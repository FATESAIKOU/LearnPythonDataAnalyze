# Section2: ミニプロジェクト① 売上分析 - 応用問題

## 🎯 この応用問題の目標

演習で行った基本的な分析に加えて、より深い分析に挑戦する。
自分で問いを立て、仮説を検証する力を養う。

---

## 📋 応用課題

以下の3つの課題に取り組んでください。
各課題は独立しているので、興味のあるものから始めても OK です。

---

## 📝 課題1: セグメント別の詳細分析

### 課題の説明

顧客をいくつかのセグメント（グループ）に分けて、それぞれの特徴を分析してください。

### やること

1. 性別（sex）× 喫煙（smoker）の4つのセグメントを作成
2. 各セグメントの平均客単価、平均チップ率を計算
3. どのセグメントが最も売上貢献が高いか分析
4. 結果を可視化

```python
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

df = sns.load_dataset('tips')
df['tip_rate'] = df['tip'] / df['total_bill'] * 100

# 課題1: セグメント別分析
# ここにコードを書く
```

<details>
<summary>💡 ヒントを見る</summary>

複数の列でグループ化：
```python
df.groupby(['sex', 'smoker'])['total_bill'].mean()
```

セグメントの作成（文字列結合）：
```python
df['segment'] = df['sex'].astype(str) + '_' + df['smoker'].astype(str)
```

</details>

<details>
<summary>💡 解答例を見る</summary>

```python
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

df = sns.load_dataset('tips')
df['tip_rate'] = df['tip'] / df['total_bill'] * 100

# セグメント別の集計
segment_analysis = df.groupby(['sex', 'smoker']).agg({
    'total_bill': ['mean', 'sum', 'count'],
    'tip_rate': 'mean'
}).round(2)

print("=== セグメント別分析 ===")
print(segment_analysis)

# セグメント別の合計売上を可視化
segment_sales = df.groupby(['sex', 'smoker'])['total_bill'].sum().unstack()

segment_sales.plot(kind='bar', figsize=(8, 5))
plt.title('Total Sales by Sex and Smoker')
plt.xlabel('Sex')
plt.ylabel('Total Sales ($)')
plt.xticks(rotation=0)
plt.legend(title='Smoker')
plt.tight_layout()
plt.show()
```

**発見例**:
- 男性・非喫煙者の売上貢献が最も高い
- 喫煙者は全体的に客数が少ない

</details>

---

## 📝 課題2: 高単価客の特徴分析

### 課題の説明

客単価が高い顧客（例：$30以上）に着目し、その特徴を分析してください。

### やること

1. 客単価 $30 以上のレコードを抽出
2. 高単価客の曜日・時間帯・人数の傾向を分析
3. 高単価客と通常客の違いを比較
4. 高単価客を増やすための示唆を導出

```python
# 課題2: 高単価客の分析
# ここにコードを書く
```

<details>
<summary>💡 ヒントを見る</summary>

条件で抽出：
```python
high_value = df[df['total_bill'] >= 30]
```

割合の計算：
```python
high_value['day'].value_counts(normalize=True)
```

</details>

<details>
<summary>💡 解答例を見る</summary>

```python
# 高単価客（$30以上）を抽出
high_value = df[df['total_bill'] >= 30]
normal = df[df['total_bill'] < 30]

print(f"高単価客: {len(high_value)}件 ({len(high_value)/len(df)*100:.1f}%)")
print(f"通常客: {len(normal)}件 ({len(normal)/len(df)*100:.1f}%)")

# 曜日の分布を比較
print("\n=== 曜日別の割合 ===")
print("高単価客:")
print(high_value['day'].value_counts(normalize=True).round(3))
print("\n通常客:")
print(normal['day'].value_counts(normalize=True).round(3))

# 人数の比較
print("\n=== 平均人数 ===")
print(f"高単価客: {high_value['size'].mean():.2f}人")
print(f"通常客: {normal['size'].mean():.2f}人")

# 時間帯の比較
print("\n=== 時間帯の割合 ===")
print("高単価客:")
print(high_value['time'].value_counts(normalize=True))
print("\n通常客:")
print(normal['time'].value_counts(normalize=True))

# 可視化：高単価客の人数分布
plt.figure(figsize=(10, 4))

plt.subplot(1, 2, 1)
high_value['size'].value_counts().sort_index().plot(kind='bar', color='coral')
plt.title('Party Size of High-Value Customers')
plt.xlabel('Party Size')
plt.ylabel('Count')

plt.subplot(1, 2, 2)
high_value['day'].value_counts().plot(kind='bar', color='steelblue')
plt.title('Day of High-Value Customers')
plt.xlabel('Day')
plt.ylabel('Count')

plt.tight_layout()
plt.show()
```

**発見例**:
- 高単価客は約 16% を占める
- 高単価客の平均人数は 3.5人（通常客は 2.4人）
- 高単価客は土曜日に多い
- ほぼ全員がディナー時間帯

</details>

---

## 📝 課題3: 仮説検証分析

### 課題の説明

以下の仮説が正しいかどうかを、データで検証してください。

**仮説**: 「グループの人数が多いほど、一人当たりの支払額は低くなる」

### やること

1. 一人当たりの支払額を計算（total_bill ÷ size）
2. 人数別に一人当たり支払額の平均を計算
3. 結果をグラフで可視化
4. 仮説が正しいかどうか結論を出す

```python
# 課題3: 仮説検証
# ここにコードを書く
```

<details>
<summary>💡 ヒントを見る</summary>

一人当たりの支払額：
```python
df['per_person'] = df['total_bill'] / df['size']
```

</details>

<details>
<summary>💡 解答例を見る</summary>

```python
# 一人当たりの支払額を計算
df['per_person'] = df['total_bill'] / df['size']

# 人数別の一人当たり支払額
per_person_by_size = df.groupby('size')['per_person'].mean()
print("=== 人数別の一人当たり支払額 ===")
print(per_person_by_size.round(2))

# 可視化
plt.figure(figsize=(8, 5))
per_person_by_size.plot(kind='bar', color='seagreen')
plt.title('Average Per-Person Spending by Party Size')
plt.xlabel('Party Size')
plt.ylabel('Per-Person Spending ($)')
plt.xticks(rotation=0)
plt.axhline(y=df['per_person'].mean(), color='red', linestyle='--', label='Overall Average')
plt.legend()
plt.tight_layout()
plt.show()

# 相関係数で確認
correlation = df['size'].corr(df['per_person'])
print(f"\n人数と一人当たり支払額の相関係数: {correlation:.3f}")
```

**結論**:
- 相関係数は約 -0.18（弱い負の相関）
- 人数が多いほど一人当たり支払額がやや低くなる傾向はあるが、強い関係ではない
- **仮説は「やや正しい」が、関係は弱い**

</details>

---

## 📝 追加チャレンジ（任意）

時間に余裕があれば、以下の課題にも挑戦してみてください。

### チャレンジ1: チップ率の予測要因

チップ率が高くなる要因は何か？様々な変数との関係を分析してください。

<details>
<summary>💡 分析のヒント</summary>

- 曜日別のチップ率
- 時間帯別のチップ率
- 人数別のチップ率
- 合計金額とチップ率の関係

```python
# 例：合計金額とチップ率の散布図
plt.figure(figsize=(8, 5))
plt.scatter(df['total_bill'], df['tip_rate'], alpha=0.5)
plt.title('Total Bill vs Tip Rate')
plt.xlabel('Total Bill ($)')
plt.ylabel('Tip Rate (%)')
plt.show()
```

</details>

### チャレンジ2: 週末 vs 平日 の詳細比較

週末（土・日）と平日（木・金）で、様々な指標を比較してください。

<details>
<summary>💡 分析のヒント</summary>

```python
# 週末フラグを作成
df['is_weekend'] = df['day'].isin(['Sat', 'Sun'])

# 週末・平日で比較
weekend_comparison = df.groupby('is_weekend').agg({
    'total_bill': ['mean', 'sum', 'count'],
    'tip_rate': 'mean',
    'size': 'mean'
})
print(weekend_comparison)
```

</details>

---

## ✅ 応用問題の完了チェック

以下の項目ができたら、この応用問題は完了です：

- [ ] 課題1: セグメント別の分析を行った
- [ ] 課題2: 高単価客の特徴を分析した
- [ ] 課題3: 仮説を検証し、結論を出した
- [ ] 各課題で発見したことをまとめた

---

## 🎉 Section2 完了！

お疲れさまでした！これで売上分析プロジェクトは完了です。

次の Section3 では、別のデータセット（penguins）を使った
「観測データ分析」プロジェクトに挑戦します！
