# Section5: データのフィルタリング - 演習問題

## 🎯 この演習の目的

条件に基づいてデータを抽出する操作を練習します。
Excel のフィルター機能を Python で実現する方法を習得しましょう。

---

## 📝 演習1: 基本的なフィルタリング

### 問題

以下の DataFrame から、指定された条件でデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["ノートPC", "マウス", "キーボード", "モニター", "USBメモリ", "Webカメラ"],
    "カテゴリ": ["PC", "周辺機器", "周辺機器", "PC", "周辺機器", "周辺機器"],
    "価格": [80000, 2000, 5000, 30000, 1000, 8000],
    "在庫": [10, 50, 30, 15, 100, 25]
})
```

1. 価格が 10000 以上の商品を抽出
2. カテゴリが「周辺機器」の商品を抽出
3. 在庫が 20 未満の商品を抽出
4. 価格が 5000 に等しい商品を抽出

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["ノートPC", "マウス", "キーボード", "モニター", "USBメモリ", "Webカメラ"],
    "カテゴリ": ["PC", "周辺機器", "周辺機器", "PC", "周辺機器", "周辺機器"],
    "価格": [80000, 2000, 5000, 30000, 1000, 8000],
    "在庫": [10, 50, 30, 15, 100, 25]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 価格が 10000 以上の商品を抽出 =====

result1 = df[df["価格"] >= 10000]

print("=== 1. 価格が 10000 以上 ===")
print(result1)
print()

# ===== 2. カテゴリが「周辺機器」の商品を抽出 =====

result2 = df[df["カテゴリ"] == "周辺機器"]

print("=== 2. カテゴリが「周辺機器」===")
print(result2)
print()

# ===== 3. 在庫が 20 未満の商品を抽出 =====

result3 = df[df["在庫"] < 20]

print("=== 3. 在庫が 20 未満 ===")
print(result3)
print()

# ===== 4. 価格が 5000 に等しい商品を抽出 =====

result4 = df[df["価格"] == 5000]

print("=== 4. 価格が 5000 ===")
print(result4)
```

**実行結果:**
```
=== 元の DataFrame ===
       商品名    カテゴリ    価格  在庫
0   ノートPC        PC  80000    10
1     マウス    周辺機器   2000    50
2  キーボード    周辺機器   5000    30
3    モニター        PC  30000    15
4   USBメモリ    周辺機器   1000   100
5    Webカメラ    周辺機器   8000    25

=== 1. 価格が 10000 以上 ===
      商品名 カテゴリ    価格  在庫
0  ノートPC       PC  80000    10
3   モニター       PC  30000    15

=== 2. カテゴリが「周辺機器」===
       商品名    カテゴリ   価格  在庫
1     マウス    周辺機器  2000    50
2  キーボード    周辺機器  5000    30
4   USBメモリ    周辺機器  1000   100
5    Webカメラ    周辺機器  8000    25

=== 3. 在庫が 20 未満 ===
      商品名 カテゴリ    価格  在庫
0  ノートPC       PC  80000    10
3   モニター       PC  30000    15

=== 4. 価格が 5000 ===
       商品名    カテゴリ   価格  在庫
2  キーボード    周辺機器  5000    30
```

</details>

---

## 📝 演習2: 複数条件のフィルタリング（AND/OR）

### 問題

以下の DataFrame から、複数条件を組み合わせてデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤", "山田"],
    "部署": ["営業", "開発", "営業", "人事", "開発", "営業"],
    "年齢": [25, 30, 28, 35, 32, 40],
    "年収": [400, 500, 450, 480, 550, 420]
})
```

1. 部署が「営業」かつ 年齢が 30 未満
2. 年収が 500 以上 または 年齢が 35 以上
3. 部署が「開発」かつ 年収が 500 以上

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤", "山田"],
    "部署": ["営業", "開発", "営業", "人事", "開発", "営業"],
    "年齢": [25, 30, 28, 35, 32, 40],
    "年収": [400, 500, 450, 480, 550, 420]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 部署が「営業」かつ 年齢が 30 未満 =====

result1 = df[(df["部署"] == "営業") & (df["年齢"] < 30)]

print("=== 1. 営業部で 30歳未満 ===")
print(result1)
print()

# ===== 2. 年収が 500 以上 または 年齢が 35 以上 =====

result2 = df[(df["年収"] >= 500) | (df["年齢"] >= 35)]

print("=== 2. 年収 500万以上 または 35歳以上 ===")
print(result2)
print()

# ===== 3. 部署が「開発」かつ 年収が 500 以上 =====

result3 = df[(df["部署"] == "開発") & (df["年収"] >= 500)]

print("=== 3. 開発部で年収 500万以上 ===")
print(result3)
```

**実行結果:**
```
=== 元の DataFrame ===
   名前  部署  年齢  年収
0  田中  営業    25  400
1  佐藤  開発    30  500
2  鈴木  営業    28  450
3  高橋  人事    35  480
4  伊藤  開発    32  550
5  山田  営業    40  420

=== 1. 営業部で 30歳未満 ===
   名前  部署  年齢  年収
0  田中  営業    25  400
2  鈴木  営業    28  450

=== 2. 年収 500万以上 または 35歳以上 ===
   名前  部署  年齢  年収
1  佐藤  開発    30  500
3  高橋  人事    35  480
4  伊藤  開発    32  550
5  山田  営業    40  420

=== 3. 開発部で年収 500万以上 ===
   名前  部署  年齢  年収
1  佐藤  開発    30  500
4  伊藤  開発    32  550
```

</details>

---

## 📝 演習3: isin() と between() の使用

### 問題

以下の DataFrame から、isin() と between() を使ってデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "都市": ["東京", "大阪", "名古屋", "福岡", "札幌", "仙台"],
    "人口": [1400, 880, 230, 160, 197, 109],  # 万人
    "地域": ["関東", "関西", "中部", "九州", "北海道", "東北"]
})
```

1. 地域が「関東」「関西」「中部」のいずれかの都市を抽出（isin 使用）
2. 人口が 150万人 以上 500万人 以下の都市を抽出（between 使用）
3. 地域が「九州」「北海道」「東北」でない都市を抽出（isin の否定）

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "都市": ["東京", "大阪", "名古屋", "福岡", "札幌", "仙台"],
    "人口": [1400, 880, 230, 160, 197, 109],  # 万人
    "地域": ["関東", "関西", "中部", "九州", "北海道", "東北"]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 地域が「関東」「関西」「中部」のいずれか（isin 使用）=====

target_regions = ["関東", "関西", "中部"]
result1 = df[df["地域"].isin(target_regions)]

print("=== 1. 関東・関西・中部の都市（isin）===")
print(result1)
print()

# ===== 2. 人口が 150万人 以上 500万人 以下（between 使用）=====

result2 = df[df["人口"].between(150, 500)]

print("=== 2. 人口 150〜500万の都市（between）===")
print(result2)
print()

# ===== 3. 「九州」「北海道」「東北」でない都市（isin の否定）=====

exclude_regions = ["九州", "北海道", "東北"]
result3 = df[~df["地域"].isin(exclude_regions)]

print("=== 3. 九州・北海道・東北 以外の都市 ===")
print(result3)
```

**実行結果:**
```
=== 元の DataFrame ===
     都市    人口    地域
0    東京  1400    関東
1    大阪   880    関西
2  名古屋   230    中部
3    福岡   160    九州
4    札幌   197  北海道
5    仙台   109    東北

=== 1. 関東・関西・中部の都市（isin）===
     都市    人口  地域
0    東京  1400  関東
1    大阪   880  関西
2  名古屋   230  中部

=== 2. 人口 150〜500万の都市（between）===
     都市  人口    地域
2  名古屋   230    中部
3    福岡   160    九州
4    札幌   197  北海道

=== 3. 九州・北海道・東北 以外の都市 ===
     都市    人口  地域
0    東京  1400  関東
1    大阪   880  関西
2  名古屋   230  中部
```

</details>

---

## 📝 演習4: query() メソッドの使用

### 問題

以下の DataFrame から、query() を使ってデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D", "E"],
    "価格": [100, 200, 150, 300, 250],
    "在庫": [10, 5, 20, 15, 8],
    "売上": [50, 30, 80, 20, 60]
})
```

1. 価格が 150 以上の商品を抽出
2. 価格が 200 未満 かつ 在庫が 10 以上の商品を抽出
3. 売上が 50 以上 または 在庫が 5 以下の商品を抽出

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D", "E"],
    "価格": [100, 200, 150, 300, 250],
    "在庫": [10, 5, 20, 15, 8],
    "売上": [50, 30, 80, 20, 60]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 価格が 150 以上の商品を抽出 =====

result1 = df.query("価格 >= 150")

print("=== 1. 価格 >= 150（query）===")
print(result1)
print()

# ===== 2. 価格が 200 未満 かつ 在庫が 10 以上 =====

result2 = df.query("価格 < 200 and 在庫 >= 10")

print("=== 2. 価格 < 200 かつ 在庫 >= 10（query）===")
print(result2)
print()

# ===== 3. 売上が 50 以上 または 在庫が 5 以下 =====

result3 = df.query("売上 >= 50 or 在庫 <= 5")

print("=== 3. 売上 >= 50 または 在庫 <= 5（query）===")
print(result3)
print()

# 比較: 通常の書き方
print("=== 参考: 通常の書き方との比較 ===")
print("query: df.query('価格 < 200 and 在庫 >= 10')")
print("通常:  df[(df['価格'] < 200) & (df['在庫'] >= 10)]")
```

**実行結果:**
```
=== 元の DataFrame ===
  商品   価格  在庫  売上
0    A  100   10   50
1    B  200    5   30
2    C  150   20   80
3    D  300   15   20
4    E  250    8   60

=== 1. 価格 >= 150（query）===
  商品   価格  在庫  売上
1    B  200    5   30
2    C  150   20   80
3    D  300   15   20
4    E  250    8   60

=== 2. 価格 < 200 かつ 在庫 >= 10（query）===
  商品   価格  在庫  売上
0    A  100   10   50
2    C  150   20   80

=== 3. 売上 >= 50 または 在庫 <= 5（query）===
  商品   価格  在庫  売上
0    A  100   10   50
1    B  200    5   30
2    C  150   20   80
4    E  250    8   60

=== 参考: 通常の書き方との比較 ===
query: df.query('価格 < 200 and 在庫 >= 10')
通常:  df[(df['価格'] < 200) & (df['在庫'] >= 10)]
```

</details>

---

## 📝 演習5: 文字列の部分一致フィルタリング

### 問題

以下の DataFrame から、文字列の部分一致を使ってデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["りんごジュース", "みかんジュース", "りんご飴", 
               "バナナスムージー", "オレンジケーキ", "りんごパイ"],
    "カテゴリ": ["飲料", "飲料", "菓子", "飲料", "菓子", "菓子"],
    "価格": [150, 150, 100, 200, 300, 250]
})
```

1. 商品名に「りんご」を含む商品を抽出
2. 商品名が「ジュース」で終わる商品を抽出
3. カテゴリが「飲料」かつ 価格が 150 以下の商品を抽出

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["りんごジュース", "みかんジュース", "りんご飴", 
               "バナナスムージー", "オレンジケーキ", "りんごパイ"],
    "カテゴリ": ["飲料", "飲料", "菓子", "飲料", "菓子", "菓子"],
    "価格": [150, 150, 100, 200, 300, 250]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 商品名に「りんご」を含む商品を抽出 =====

result1 = df[df["商品名"].str.contains("りんご")]

print("=== 1. 商品名に「りんご」を含む ===")
print(result1)
print()

# ===== 2. 商品名が「ジュース」で終わる商品を抽出 =====

result2 = df[df["商品名"].str.endswith("ジュース")]

print("=== 2. 商品名が「ジュース」で終わる ===")
print(result2)
print()

# ===== 3. カテゴリが「飲料」かつ 価格が 150 以下 =====

result3 = df[(df["カテゴリ"] == "飲料") & (df["価格"] <= 150)]

print("=== 3. 飲料で価格 150 以下 ===")
print(result3)
```

**実行結果:**
```
=== 元の DataFrame ===
           商品名 カテゴリ   価格
0  りんごジュース     飲料  150
1  みかんジュース     飲料  150
2        りんご飴     菓子  100
3  バナナスムージー     飲料  200
4    オレンジケーキ     菓子  300
5      りんごパイ     菓子  250

=== 1. 商品名に「りんご」を含む ===
           商品名 カテゴリ   価格
0  りんごジュース     飲料  150
2        りんご飴     菓子  100
5      りんごパイ     菓子  250

=== 2. 商品名が「ジュース」で終わる ===
           商品名 カテゴリ   価格
0  りんごジュース     飲料  150
1  みかんジュース     飲料  150

=== 3. 飲料で価格 150 以下 ===
           商品名 カテゴリ   価格
0  りんごジュース     飲料  150
1  みかんジュース     飲料  150
```

</details>

---

## 🎯 チェックリスト

以下ができるようになったか確認しましょう：

- [ ] 単一条件でフィルタリングできる（==, >, >=, <, <=, !=）
- [ ] AND 条件（&）で複数条件を組み合わせられる
- [ ] OR 条件（|）で複数条件を組み合わせられる
- [ ] NOT 条件（~）で条件を反転できる
- [ ] `isin()` で複数の値にマッチできる
- [ ] `between()` で範囲を指定できる
- [ ] `query()` で条件を文字列で指定できる
- [ ] `str.contains()` で部分一致検索ができる
