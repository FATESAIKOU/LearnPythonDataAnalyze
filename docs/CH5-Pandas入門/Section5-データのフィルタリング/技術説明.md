# Section5: データのフィルタリング

## 🎯 このセクションで学ぶこと

条件に基づいてデータを抽出する方法を学びます。
Excel の「フィルター機能」を Python で実現できるようになります。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    データフィルタリングのイメージ                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   【元のデータ】                       【フィルタリング後】             │
│                                                                         │
│   ┌─────┬─────┬─────┬─────┐           ┌─────┬─────┬─────┬─────┐         │
│   │ 名前│ 部署│ 年齢│ 年収│           │ 名前│ 部署│ 年齢│ 年収│         │
│   ├─────┼─────┼─────┼─────┤           ├─────┼─────┼─────┼─────┤         │
│   │ 田中│ 営業│  25 │ 400 │           │ 佐藤│ 開発│  30 │ 500 │         │
│   │ 佐藤│ 開発│  30 │ 500 │  ───→    │ 伊藤│ 開発│  35 │ 550 │         │
│   │ 鈴木│ 営業│  28 │ 450 │           └─────┴─────┴─────┴─────┘         │
│   │ 高橋│ 人事│  32 │ 480 │                                             │
│   │ 伊藤│ 開発│  35 │ 550 │           条件: 部署 == "開発"              │
│   └─────┴─────┴─────┴─────┘                                             │
│                                                                         │
│   😊 条件に合うデータだけを1行のコードで抽出できる！                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📘 1. ブールインデックス（条件式）

### 1.1 条件式の結果は True/False の Series

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "年齢": [25, 30, 28, 32, 35],
    "部署": ["営業", "開発", "営業", "人事", "開発"]
})

# 条件式を作成
condition = df["年齢"] >= 30

print(condition)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      条件式の動作イメージ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df["年齢"] >= 30                                                      │
│         │                                                               │
│         ▼  各行に対して条件をチェック                                  │
│                                                                         │
│   ┌──────┐        ┌────────────────┐       ┌───────┐                    │
│   │  25  │   →   │  25 >= 30 ?    │   →  │ False │  0                 │
│   │  30  │   →   │  30 >= 30 ?    │   →  │ True  │  1                 │
│   │  28  │   →   │  28 >= 30 ?    │   →  │ False │  2                 │
│   │  32  │   →   │  32 >= 30 ?    │   →  │ True  │  3                 │
│   │  35  │   →   │  35 >= 30 ?    │   →  │ True  │  4                 │
│   └──────┘        └────────────────┘       └───────┘                    │
│    年齢列               条件判定           ブールSeries                 │
│                                                                         │
│   💡 結果は True/False の Series（ブール Series）                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 ブールインデックスでフィルタリング

```python
# 条件式を [] に入れてフィルタリング
result = df[df["年齢"] >= 30]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   ブールインデックスの仕組み                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df[df["年齢"] >= 30]                                                  │
│      │                                                                  │
│      └─ ブール Series（True/False の列）                                │
│                                                                         │
│   ┌─────┬─────┬─────┐      ┌───────┐                                    │
│   │ 名前│ 年齢│ 部署│      │ 条件  │                                    │
│   ├─────┼─────┼─────┤      ├───────┤      ┌─────┬─────┬─────┐           │
│   │ 田中│  25 │ 営業│  →  │ False │  ✗  │     │     │     │           │
│   │ 佐藤│  30 │ 開発│  →  │ True  │  ✓  │ 佐藤│  30 │ 開発│           │
│   │ 鈴木│  28 │ 営業│  →  │ False │  ✗  │     │     │     │           │
│   │ 高橋│  32 │ 人事│  →  │ True  │  ✓  │ 高橋│  32 │ 人事│           │
│   │ 伊藤│  35 │ 開発│  →  │ True  │  ✓  │ 伊藤│  35 │ 開発│           │
│   └─────┴─────┴─────┘      └───────┘      └─────┴─────┴─────┘           │
│                                          True の行だけ抽出！            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📘 2. 基本的なフィルタリング

### 2.1 比較演算子

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D", "E"],
    "価格": [100, 200, 150, 300, 250],
    "在庫": [10, 5, 0, 15, 8]
})

# 等しい
df[df["価格"] == 200]

# 等しくない
df[df["価格"] != 200]

# より大きい
df[df["価格"] > 150]

# 以上
df[df["価格"] >= 150]

# より小さい
df[df["価格"] < 200]

# 以下
df[df["価格"] <= 200]
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       比較演算子一覧                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   演算子     意味              使用例                                   │
│   ────────────────────────────────────────────────────────────          │
│   ==        等しい            df[df["価格"] == 200]                     │
│   !=        等しくない        df[df["価格"] != 200]                     │
│   >         より大きい        df[df["価格"] > 150]                      │
│   >=        以上              df[df["価格"] >= 150]                     │
│   <         より小さい        df[df["価格"] < 200]                      │
│   <=        以下              df[df["価格"] <= 200]                     │
│                                                                         │
│   ⚠️ 注意: = ではなく == を使う！                                       │
│   • = は「代入」                                                        │
│   • == は「比較」                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 文字列の条件

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "人事", "開発"]
})

# 文字列が一致
df[df["部署"] == "営業"]

# 文字列が一致しない
df[df["部署"] != "人事"]
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    文字列フィルタリングの例                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df[df["部署"] == "営業"]                                              │
│                                                                         │
│   ┌─────┬─────┐      ┌───────────────────┐      ┌─────┬─────┐           │
│   │ 名前│ 部署│      │ 部署 == "営業" ?  │      │ 名前│ 部署│           │
│   ├─────┼─────┤      ├───────────────────┤      ├─────┼─────┤           │
│   │ 田中│ 営業│  →  │      True         │  ✓  │ 田中│ 営業│           │
│   │ 佐藤│ 開発│  →  │      False        │  ✗  │     │     │           │
│   │ 鈴木│ 営業│  →  │      True         │  ✓  │ 鈴木│ 営業│           │
│   │ 高橋│ 人事│  →  │      False        │  ✗  │     │     │           │
│   │ 伊藤│ 開発│  →  │      False        │  ✗  │     │     │           │
│   └─────┴─────┘      └───────────────────┘      └─────┴─────┘           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📘 3. 複数条件の組み合わせ

### 3.1 AND 条件（&）

両方の条件を満たす行を抽出します。

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "人事", "開発"],
    "年齢": [25, 30, 28, 32, 35],
    "年収": [400, 500, 450, 480, 550]
})

# 部署が「開発」かつ 年収が 500 以上
result = df[(df["部署"] == "開発") & (df["年収"] >= 500)]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       AND 条件（&）のイメージ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   (df["部署"] == "開発") & (df["年収"] >= 500)                          │
│                                                                         │
│   ┌─────┬─────┬─────┐   ┌───────┐   ┌───────┐   ┌───────┐               │
│   │ 名前│ 部署│ 年収│   │ 条件1 │   │ 条件2 │   │ 結果  │               │
│   ├─────┼─────┼─────┤   │ 開発? │ & │ >=500 │ = │       │               │
│   │ 田中│ 営業│ 400 │   │ False │   │ False │   │ False │  ✗           │
│   │ 佐藤│ 開発│ 500 │   │ True  │   │ True  │   │ True  │  ✓ 抽出！    │
│   │ 鈴木│ 営業│ 450 │   │ False │   │ False │   │ False │  ✗           │
│   │ 高橋│ 人事│ 480 │   │ False │   │ False │   │ False │  ✗           │
│   │ 伊藤│ 開発│ 550 │   │ True  │   │ True  │   │ True  │  ✓ 抽出！    │
│   └─────┴─────┴─────┘   └───────┘   └───────┘   └───────┘               │
│                                                                         │
│   ⚠️ 重要: 各条件を () で囲むこと！                                     │
│   ✗ df[df["部署"] == "開発" & df["年収"] >= 500]  ← エラー            │
│   ✓ df[(df["部署"] == "開発") & (df["年収"] >= 500)]                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 OR 条件（|）

どちらかの条件を満たす行を抽出します。

```python
# 部署が「営業」または 部署が「人事」
result = df[(df["部署"] == "営業") | (df["部署"] == "人事")]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       OR 条件（|）のイメージ                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   (df["部署"] == "営業") | (df["部署"] == "人事")                       │
│                                                                         │
│   ┌─────┬─────┐   ┌───────┐   ┌───────┐   ┌───────┐                     │
│   │ 名前│ 部署│   │ 営業? │   │ 人事? │   │ 結果  │                     │
│   ├─────┼─────┤   │       │ | │       │ = │       │                     │
│   │ 田中│ 営業│   │ True  │   │ False │   │ True  │  ✓ 抽出！          │
│   │ 佐藤│ 開発│   │ False │   │ False │   │ False │  ✗                 │
│   │ 鈴木│ 営業│   │ True  │   │ False │   │ True  │  ✓ 抽出！          │
│   │ 高橋│ 人事│   │ False │   │ True  │   │ True  │  ✓ 抽出！          │
│   │ 伊藤│ 開発│   │ False │   │ False │   │ False │  ✗                 │
│   └─────┴─────┘   └───────┘   └───────┘   └───────┘                     │
│                                                                         │
│   💡 OR は | を使う（Python の or ではない！）                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 NOT 条件（~）

条件を反転します。

```python
# 部署が「開発」でない
result = df[~(df["部署"] == "開発")]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       NOT 条件（~）のイメージ                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ~(df["部署"] == "開発")                                               │
│                                                                         │
│   ┌─────┬─────┐   ┌───────┐       ┌───────┐                             │
│   │ 名前│ 部署│   │ 開発? │   ~   │ 結果  │                             │
│   ├─────┼─────┤   │       │  反転 │       │                             │
│   │ 田中│ 営業│   │ False │   →  │ True  │  ✓ 抽出！                  │
│   │ 佐藤│ 開発│   │ True  │   →  │ False │  ✗                         │
│   │ 鈴木│ 営業│   │ False │   →  │ True  │  ✓ 抽出！                  │
│   │ 高橋│ 人事│   │ False │   →  │ True  │  ✓ 抽出！                  │
│   │ 伊藤│ 開発│   │ True  │   →  │ False │  ✗                         │
│   └─────┴─────┘   └───────┘       └───────┘                             │
│                                                                         │
│   💡 ~ は条件全体の前につける                                           │
│   💡 df["部署"] != "開発" と同じ結果                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📘 4. isin() で複数の値にマッチ

### 4.1 isin() の基本

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "人事", "開発"]
})

# 部署が「営業」または「人事」（isin を使用）
result = df[df["部署"].isin(["営業", "人事"])]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       isin() のイメージ                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df["部署"].isin(["営業", "人事"])                                     │
│                                                                         │
│   ┌─────┐     ┌───────────────────────────┐     ┌───────┐               │
│   │ 部署│     │ ["営業", "人事"] に含む?  │     │ 結果  │               │
│   ├─────┤     └───────────────────────────┘     ├───────┤               │
│   │ 営業│  →        ✓ 含む                 → │ True  │               │
│   │ 開発│  →        ✗ 含まない             → │ False │               │
│   │ 営業│  →        ✓ 含む                 → │ True  │               │
│   │ 人事│  →        ✓ 含む                 → │ True  │               │
│   │ 開発│  →        ✗ 含まない             → │ False │               │
│   └─────┘                                       └───────┘               │
│                                                                         │
│   💡 複数の OR 条件を簡潔に書ける！                                     │
│                                                                         │
│   以下と同じ結果:                                                       │
│   df[(df["部署"] == "営業") | (df["部署"] == "人事")]                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 isin() の否定

```python
# 部署が「営業」「人事」でない
result = df[~df["部署"].isin(["営業", "人事"])]
print(result)
```

---

## 📘 5. between() で範囲指定

### 5.1 between() の基本

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D", "E"],
    "価格": [100, 200, 150, 300, 250]
})

# 価格が 150 以上 250 以下
result = df[df["価格"].between(150, 250)]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      between() のイメージ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df["価格"].between(150, 250)                                          │
│                                                                         │
│   ┌─────┐   ┌────────────────────┐     ┌───────┐                        │
│   │ 価格│   │ 150 <= 価格 <= 250 │     │ 結果  │                        │
│   ├─────┤   └────────────────────┘     ├───────┤                        │
│   │ 100 │  →     100 は範囲外     →  │ False │                        │
│   │ 200 │  →     200 は範囲内     →  │ True  │  ✓                    │
│   │ 150 │  →     150 は範囲内     →  │ True  │  ✓ (境界含む)         │
│   │ 300 │  →     300 は範囲外     →  │ False │                        │
│   │ 250 │  →     250 は範囲内     →  │ True  │  ✓ (境界含む)         │
│   └─────┘                              └───────┘                        │
│                                                                         │
│   💡 between(下限, 上限) は両端を含む（150 と 250 も含む）              │
│                                                                         │
│   以下と同じ結果:                                                       │
│   df[(df["価格"] >= 150) & (df["価格"] <= 250)]                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📘 6. query() メソッド

### 6.1 query() の基本

文字列で条件を書けるので、複雑な条件も読みやすくなります。

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "人事", "開発"],
    "年齢": [25, 30, 28, 32, 35],
    "年収": [400, 500, 450, 480, 550]
})

# query で条件を指定
result = df.query("年齢 >= 30")
print(result)

# 複数条件
result = df.query("部署 == '開発' and 年収 >= 500")
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       query() の特徴                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   【通常の書き方】                                                      │
│   df[(df["部署"] == "開発") & (df["年収"] >= 500)]                      │
│                                                                         │
│   【query を使った書き方】                                              │
│   df.query("部署 == '開発' and 年収 >= 500")                            │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  query() の利点:                                                │   │
│   │  ✓ 括弧が不要で読みやすい                                      │   │
│   │  ✓ and, or, not が使える（& | ~ ではなく）                     │   │
│   │  ✓ カラム名を直接書ける（df["カラム名"] ではなく）             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ⚠️ 注意点:                                                            │
│   • 文字列は ' ' で囲む（"" の中では '' を使う）                        │
│   • カラム名に日本語やスペースがある場合は `` で囲む                    │
│     例: df.query("`部 署` == '営業'")                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 query() での変数使用

```python
# 変数を使う場合は @ をつける
target_dept = "開発"
min_salary = 500

result = df.query("部署 == @target_dept and 年収 >= @min_salary")
print(result)
```

---

## 📘 7. 文字列の部分一致

### 7.1 str.contains() で部分一致

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["りんごジュース", "みかんジュース", "りんご飴", "バナナ", "みかん"],
    "価格": [150, 150, 100, 120, 80]
})

# 「りんご」を含む商品
result = df[df["商品名"].str.contains("りんご")]
print(result)
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    str.contains() のイメージ                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   df["商品名"].str.contains("りんご")                                   │
│                                                                         │
│   ┌────────────────┐    ┌─────────────────────┐     ┌───────┐           │
│   │     商品名     │    │ 「りんご」を含む?   │     │ 結果  │           │
│   ├────────────────┤    └─────────────────────┘     ├───────┤           │
│   │ りんごジュース │ →           ✓            →  │ True  │           │
│   │ みかんジュース │ →           ✗            →  │ False │           │
│   │   りんご飴     │ →           ✓            →  │ True  │           │
│   │    バナナ      │ →           ✗            →  │ False │           │
│   │    みかん      │ →           ✗            →  │ False │           │
│   └────────────────┘                                └───────┘           │
│                                                                         │
│   💡 Excel の「*りんご*」のようなワイルドカード検索と同じ               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 その他の文字列メソッド

```python
# 「ジュース」で終わる
df[df["商品名"].str.endswith("ジュース")]

# 「り」で始まる
df[df["商品名"].str.startswith("り")]

# 大文字小文字を無視して検索
df[df["商品名"].str.contains("APPLE", case=False)]
```

---

## 📝 まとめ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    このセクションで学んだこと                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   【基本的なフィルタリング】                                            │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  df[df["列名"] == 値]           等しい行を抽出                  │   │
│   │  df[df["列名"] > 値]            大きい行を抽出                  │   │
│   │  df[df["列名"] >= 値]           以上の行を抽出                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   【複数条件】                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  df[(条件1) & (条件2)]          AND（両方を満たす）             │   │
│   │  df[(条件1) | (条件2)]          OR（どちらかを満たす）          │   │
│   │  df[~(条件)]                    NOT（条件を反転）               │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   【便利なメソッド】                                                    │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  df[df["列"].isin([値1, 値2])]  複数値のいずれかにマッチ        │   │
│   │  df[df["列"].between(a, b)]     範囲内（a以上b以下）            │   │
│   │  df.query("条件式")             文字列で条件指定                │   │
│   │  df[df["列"].str.contains("x")] 文字列の部分一致                │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ⚠️ 複数条件では各条件を () で囲むこと！                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
