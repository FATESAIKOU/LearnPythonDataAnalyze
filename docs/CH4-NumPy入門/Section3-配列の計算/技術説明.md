# Section3: 配列の計算

## 🎯 このセクションの目標

- 配列同士の演算ができるようになる
- ブロードキャストの仕組みを理解する
- 集計関数を使ってデータを要約できるようになる
- 軸（axis）を指定した計算ができるようになる

---

## 🔢 要素ごとの演算

NumPy 配列は、四則演算を要素ごとに行います。
Python のリストとは異なり、**ループなしで**配列全体を一度に計算できます。

### 基本的な演算

```python
import numpy as np

a = np.array([1, 2, 3, 4, 5])
b = np.array([10, 20, 30, 40, 50])

print(a + b)   # [11 22 33 44 55]  加算
print(a - b)   # [-9 -18 -27 -36 -45]  減算
print(a * b)   # [10 40 90 160 250]  乗算
print(a / b)   # [0.1 0.1 0.1 0.1 0.1]  除算
print(b // a)  # [10 10 10 10 10]  整数除算
print(b % a)   # [0 0 0 0 0]  剰余
print(a ** 2)  # [1 4 9 16 25]  べき乗
```

```
要素ごとの演算のイメージ:

配列 a:    [1, 2, 3, 4, 5]
           × × × × ×
配列 b:    [10, 20, 30, 40, 50]
           ↓ ↓ ↓ ↓ ↓
結果:      [10, 40, 90, 160, 250]
```

### 2次元配列の演算

```python
import numpy as np

a = np.array([[1, 2],
              [3, 4]])
b = np.array([[10, 20],
              [30, 40]])

print(a + b)
# [[11 22]
#  [33 44]]

print(a * b)
# [[10 40]
#  [90 160]]
```

---

## 📊 スカラーとの演算（ブロードキャスト基礎）

配列とスカラー（単一の数値）の演算は、スカラーが配列全体に適用されます。

```python
import numpy as np

arr = np.array([1, 2, 3, 4, 5])

print(arr + 10)   # [11 12 13 14 15]
print(arr * 2)    # [ 2  4  6  8 10]
print(arr / 2)    # [0.5 1.  1.5 2.  2.5]
print(arr ** 2)   # [ 1  4  9 16 25]
print(10 - arr)   # [9 8 7 6 5]
```

```
スカラーとの演算:

配列:      [1, 2, 3, 4, 5]
           × × × × ×
スカラー:  [2, 2, 2, 2, 2]  ← 2 が「広がった」
           ↓ ↓ ↓ ↓ ↓
結果:      [2, 4, 6, 8, 10]
```

### 実用例: 温度の変換

```python
import numpy as np

# 華氏温度
fahrenheit = np.array([32, 68, 77, 86, 100])

# 摂氏に変換: C = (F - 32) × 5/9
celsius = (fahrenheit - 32) * 5 / 9
print(celsius)  # [ 0. 20. 25. 30. 37.78]
```

---

## 📐 ブロードキャスト（異なる形状の配列の計算）

Section1 で図解した内容の復習と発展です。

### ルール

1. 形状を**右端から**比較する
2. 各次元のサイズが「同じ」または「どちらかが 1」なら計算可能
3. サイズが 1 の次元は、もう一方のサイズに「引き伸ばされる」

### 例1: 2次元配列 + 1次元配列

```python
import numpy as np

# 2次元 (2, 3)
a = np.array([[1, 2, 3],
              [4, 5, 6]])

# 1次元 (3,)
b = np.array([10, 20, 30])

# 形状比較: (2, 3) と (3,) → (2, 3) と (1, 3) と解釈 → OK!
print(a + b)
# [[11 22 33]
#  [14 25 36]]
```

```
ブロードキャストのイメージ:

a (2, 3):           b (3,) → (1, 3) → (2, 3):
┌────┬────┬────┐    ┌────┬────┬────┐
│  1 │  2 │  3 │    │ 10 │ 20 │ 30 │  ← 各行に同じ値
├────┼────┼────┤  + ├────┼────┼────┤
│  4 │  5 │  6 │    │ 10 │ 20 │ 30 │
└────┴────┴────┘    └────┴────┴────┘

結果:
┌────┬────┬────┐
│ 11 │ 22 │ 33 │
├────┼────┼────┤
│ 14 │ 25 │ 36 │
└────┴────┴────┘
```

### 例2: 縦ベクトル + 横ベクトル

```python
import numpy as np

# 縦ベクトル (3, 1)
a = np.array([[1],
              [2],
              [3]])

# 横ベクトル (4,)
b = np.array([10, 20, 30, 40])

# 形状: (3, 1) と (4,) → (3, 1) と (1, 4) → (3, 4)
print(a + b)
# [[11 21 31 41]
#  [12 22 32 42]
#  [13 23 33 43]]
```

### ブロードキャストできない例

```python
import numpy as np

a = np.array([[1, 2, 3],
              [4, 5, 6]])  # (2, 3)

b = np.array([10, 20])  # (2,)

# 形状比較: (2, 3) と (2,) → 右から 3 と 2 → 一致しない！
# print(a + b)  # ValueError!
```

---

## 📈 集計関数

配列全体、または特定の軸に沿ってデータを集計します。

### 基本的な集計関数

```python
import numpy as np

arr = np.array([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

print(arr.sum())   # 55   合計
print(arr.mean())  # 5.5  平均
print(arr.max())   # 10   最大値
print(arr.min())   # 1    最小値
print(arr.std())   # 2.87... 標準偏差
print(arr.var())   # 8.25 分散
```

### 手計算との比較

```python
import numpy as np

arr = np.array([2, 4, 6, 8, 10])

# 合計（手計算）
total = 0
for x in arr:
    total = total + x
print("合計（手計算）:", total)  # 30
print("合計（NumPy）:", arr.sum())  # 30

# 平均（手計算）
mean = total / len(arr)
print("平均（手計算）:", mean)  # 6.0
print("平均（NumPy）:", arr.mean())  # 6.0
```

### その他の集計関数

```python
import numpy as np

arr = np.array([3, 1, 4, 1, 5, 9, 2, 6])

print(arr.argmax())  # 5  最大値のインデックス
print(arr.argmin())  # 1  最小値のインデックス
print(arr.prod())    # 6480  全要素の積
print(np.median(arr))  # 3.5  中央値（関数として呼ぶ）
```

---

## 🎯 軸（axis）を指定した集計

2次元以上の配列では、**どの方向に**集計するかを `axis` で指定できます。

### axis の意味

```
2次元配列 arr:
        列→   0   1   2
      行↓  ┌───┬───┬───┐
        0  │ 1 │ 2 │ 3 │
           ├───┼───┼───┤
        1  │ 4 │ 5 │ 6 │
           └───┴───┴───┘

axis=0: 行方向（縦方向）に集計 → 結果は列ごとの値
axis=1: 列方向（横方向）に集計 → 結果は行ごとの値
```

### 具体例

```python
import numpy as np

arr = np.array([[1, 2, 3],
                [4, 5, 6]])

# 全体の合計
print(arr.sum())  # 21

# 行方向（axis=0）: 各列の合計
print(arr.sum(axis=0))  # [5 7 9]

# 列方向（axis=1）: 各行の合計
print(arr.sum(axis=1))  # [6 15]
```

```
axis=0 の動き（各列で縦に足す）:

┌───┬───┬───┐
│ 1 │ 2 │ 3 │  ← 1列目: 1+4=5
├───┼───┼───┤     2列目: 2+5=7
│ 4 │ 5 │ 6 │     3列目: 3+6=9
└───┴───┴───┘
      ↓ ↓ ↓
結果: [5, 7, 9]


axis=1 の動き（各行で横に足す）:

┌───┬───┬───┐
│ 1 │ 2 │ 3 │ → 1+2+3=6
├───┼───┼───┤
│ 4 │ 5 │ 6 │ → 4+5+6=15
└───┴───┴───┘

結果: [6, 15]
```

### 覚え方のコツ

- `axis=0`: その軸が「潰れる」→ 行が潰れて列ごとの結果
- `axis=1`: その軸が「潰れる」→ 列が潰れて行ごとの結果

```python
import numpy as np

arr = np.array([[1, 2, 3],
                [4, 5, 6]])
print(arr.shape)  # (2, 3)

print(arr.sum(axis=0).shape)  # (3,)  ← axis=0(行)が消えた
print(arr.sum(axis=1).shape)  # (2,)  ← axis=1(列)が消えた
```

### 実用例: 科目別・生徒別の平均

```python
import numpy as np

# 3人の生徒、4科目のテスト成績
scores = np.array([[80, 75, 90, 85],   # 生徒1
                   [70, 80, 85, 90],   # 生徒2
                   [85, 90, 80, 75]])  # 生徒3

# 科目別の平均（axis=0: 生徒方向に平均）
print("科目別平均:", scores.mean(axis=0))
# [78.33 81.67 85.   83.33]

# 生徒別の平均（axis=1: 科目方向に平均）
print("生徒別平均:", scores.mean(axis=1))
# [82.5 81.25 82.5]
```

---

## 🔬 ユニバーサル関数（ufunc）

NumPy には、配列の全要素に対して一括で適用できる数学関数があります。

### 数学関数

```python
import numpy as np

arr = np.array([1, 4, 9, 16, 25])

print(np.sqrt(arr))   # [1. 2. 3. 4. 5.]  平方根
print(np.square(arr)) # [1 16 81 256 625]  2乗
print(np.abs(np.array([-1, -2, 3])))  # [1 2 3]  絶対値
```

### 三角関数

```python
import numpy as np

# 角度（ラジアン）
angles = np.array([0, np.pi/6, np.pi/4, np.pi/3, np.pi/2])

print(np.sin(angles).round(3))  # [0.    0.5   0.707 0.866 1.   ]
print(np.cos(angles).round(3))  # [1.    0.866 0.707 0.5   0.   ]
```

### 指数・対数関数

```python
import numpy as np

arr = np.array([1, 2, 3])

print(np.exp(arr))   # [ 2.718  7.389 20.086]  e^x
print(np.log(arr))   # [0.    0.693 1.099]  自然対数
print(np.log10(np.array([1, 10, 100])))  # [0. 1. 2.]  常用対数
```

### 丸め関数

```python
import numpy as np

arr = np.array([1.2, 2.5, 3.7, 4.4])

print(np.round(arr))   # [1. 2. 4. 4.]  四捨五入
print(np.floor(arr))   # [1. 2. 3. 4.]  切り捨て
print(np.ceil(arr))    # [2. 3. 4. 5.]  切り上げ
print(np.trunc(arr))   # [1. 2. 3. 4.]  小数部切り捨て
```

---

## 🧮 行列演算の基礎

### ドット積（内積）

```python
import numpy as np

a = np.array([1, 2, 3])
b = np.array([4, 5, 6])

# ドット積: 1×4 + 2×5 + 3×6 = 32
print(np.dot(a, b))  # 32
print(a @ b)         # 32  ← @ 演算子でも可能
```

```
ドット積の計算:

a = [1, 2, 3]
b = [4, 5, 6]

1×4 + 2×5 + 3×6
= 4 + 10 + 18
= 32
```

### 行列積

```python
import numpy as np

a = np.array([[1, 2],
              [3, 4]])  # (2, 2)

b = np.array([[5, 6],
              [7, 8]])  # (2, 2)

print(np.dot(a, b))
# [[19 22]
#  [43 50]]

print(a @ b)  # 同じ結果
# [[19 22]
#  [43 50]]
```

```
行列積の計算:

     a              b           結果
┌───┬───┐     ┌───┬───┐     ┌────┬────┐
│ 1 │ 2 │  @  │ 5 │ 6 │  =  │ 19 │ 22 │
├───┼───┤     ├───┼───┤     ├────┼────┤
│ 3 │ 4 │     │ 7 │ 8 │     │ 43 │ 50 │
└───┴───┘     └───┴───┘     └────┴────┘

結果[0,0] = 1×5 + 2×7 = 5 + 14 = 19
結果[0,1] = 1×6 + 2×8 = 6 + 16 = 22
結果[1,0] = 3×5 + 4×7 = 15 + 28 = 43
結果[1,1] = 3×6 + 4×8 = 18 + 32 = 50
```

> ⚠️ 注意: `a * b` は**要素ごとの積**、`a @ b` は**行列積**です！

---

## 📝 まとめ

| 操作 | コード例 | 説明 |
|------|----------|------|
| 要素ごとの演算 | `a + b`, `a * b` | 対応する要素同士で計算 |
| スカラー演算 | `arr * 2` | 全要素に適用 |
| 合計 | `arr.sum()` | 全要素の和 |
| 平均 | `arr.mean()` | 全要素の平均 |
| 最大/最小 | `arr.max()`, `arr.min()` | 最大値、最小値 |
| 標準偏差 | `arr.std()` | 標準偏差 |
| 列ごとの集計 | `arr.sum(axis=0)` | 行を潰して列ごとに |
| 行ごとの集計 | `arr.sum(axis=1)` | 列を潰して行ごとに |
| 平方根 | `np.sqrt(arr)` | 全要素の平方根 |
| ドット積 | `np.dot(a, b)` or `a @ b` | 内積・行列積 |

---

## 🤔 よくある質問

### Q: sum() と np.sum() の違いは？

**A**: 基本的に同じですが、`np.sum()` はリストにも使えます。

```python
arr.sum()      # 配列のメソッド
np.sum(arr)    # NumPy の関数
np.sum([1,2,3])  # リストにも使える
```

### Q: axis を間違えたらどうなる？

**A**: 結果の形状が変わるので、必ず確認しましょう。

```python
arr = np.array([[1, 2, 3], [4, 5, 6]])  # (2, 3)
print(arr.sum(axis=0).shape)  # (3,) 列ごと
print(arr.sum(axis=1).shape)  # (2,) 行ごと
```

### Q: * と @ の違いは？

**A**: 
- `*`: 要素ごとの積（アダマール積）
- `@`: 行列積（ドット積）

```python
a = np.array([[1, 2], [3, 4]])
b = np.array([[5, 6], [7, 8]])

print(a * b)  # [[ 5 12], [21 32]]  要素ごと
print(a @ b)  # [[19 22], [43 50]]  行列積
```
