# Section4: グループ化と集計 - 技術説明

## 🎯 このセクションで学ぶこと

データ分析では「カテゴリごとに集計する」操作が非常に多いです。
Pandas の groupby を使ったグループ化と集計を学びます。
**groupby の結果はマルチインデックスになることが多い**ので、Section3 で学んだインデックスの知識が活きてきます。

---

## 1. groupby の基本

### groupby とは

```
【groupby の動作イメージ】

  元の DataFrame                   グループ化
  ┌───────┬──────┬──────┬──────┐
  │ index │ 部署 │ 名前 │ 売上 │     ①「部署」でグループ分け
  ├───────┼──────┼──────┼──────┤
  │   0   │ 営業 │ 田中 │ 100  │     ┌─────────────────────┐
  ├───────┼──────┼──────┼──────┤     │ 営業グループ        │
  │   1   │ 営業 │ 佐藤 │ 150  │  → │ 田中:100, 佐藤:150  │
  ├───────┼──────┼──────┼──────┤     │ 合計: 250           │
  │   2   │ 開発 │ 鈴木 │ 200  │     └─────────────────────┘
  ├───────┼──────┼──────┼──────┤
  │   3   │ 開発 │ 高橋 │ 180  │     ┌─────────────────────┐
  └───────┴──────┴──────┴──────┘     │ 開発グループ        │
                                     │ 鈴木:200, 高橋:180  │
                                     │ 合計: 380           │
                                     └─────────────────────┘

                    ②集計関数を適用

  集計結果（index = グループキー）
  ┌───────┬──────┐
  │ index │ 売上 │   ← index が「部署」になる！
  │(部署) │      │
  ├───────┼──────┤
  │ 営業  │ 250  │
  ├───────┼──────┤
  │ 開発  │ 380  │
  └───────┴──────┘

┌─────────────────────────────────────────────────────────────┐
│  groupby の結果: グループキーが index になる                │
│  → reset_index() で通常の列に戻せる                        │
└─────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})

print("=== 元のデータ ===")
print(df)

# 部署ごとの売上合計
result = df.groupby("部署")["売上"].sum()
print("\n=== groupby 結果 ===")
print(result)

print("\n=== インデックスを確認 ===")
print(f"インデックス: {result.index.tolist()}")
print(f"型: {type(result)}")
```

**実行結果:**
```
=== 元のデータ ===
   部署  名前   売上
0  営業  田中   100
1  営業  佐藤   150
2  開発  鈴木   200
3  開発  高橋   180

=== groupby 結果 ===
部署
営業    250
開発    380
Name: 売上, dtype: int64

=== インデックスを確認 ===
インデックス: ['営業', '開発']
型: <class 'pandas.core.series.Series'>
```

### 集計関数一覧

```
【よく使う集計関数】

┌───────────┬───────────────────────────────────────────────┐
│  関数     │   説明                                        │
├───────────┼───────────────────────────────────────────────┤
│ sum()     │ 合計                                          │
│ mean()    │ 平均                                          │
│ median()  │ 中央値                                        │
│ count()   │ 件数（NaN を除く）                            │
│ size()    │ 件数（NaN を含む）                            │
│ min()     │ 最小値                                        │
│ max()     │ 最大値                                        │
│ std()     │ 標準偏差                                      │
│ var()     │ 分散                                          │
│ first()   │ 最初の値                                      │
│ last()    │ 最後の値                                      │
└───────────┴───────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "開発", "開発"],
    "売上": [100, 150, 120, 200, 180]
})

print("=== 各種集計関数 ===")
print(f"合計: \n{df.groupby('部署')['売上'].sum()}\n")
print(f"平均: \n{df.groupby('部署')['売上'].mean()}\n")
print(f"件数: \n{df.groupby('部署')['売上'].count()}\n")
print(f"最大: \n{df.groupby('部署')['売上'].max()}\n")
```

---

## 2. 複数列でのグループ化（マルチインデックス）

### 複数キーでのグループ化

```
【複数列でグループ化 → マルチインデックス】

  元の DataFrame
  ┌───────┬──────┬──────┬──────┐
  │ index │ 部署 │ 年度 │ 売上 │
  ├───────┼──────┼──────┼──────┤
  │   0   │ 営業 │ 2023 │ 100  │
  ├───────┼──────┼──────┼──────┤
  │   1   │ 営業 │ 2024 │ 120  │
  ├───────┼──────┼──────┼──────┤
  │   2   │ 開発 │ 2023 │ 200  │
  ├───────┼──────┼──────┼──────┤
  │   3   │ 開発 │ 2024 │ 220  │
  └───────┴──────┴──────┴──────┘

          ↓  df.groupby(["部署", "年度"])["売上"].sum()

  集計結果（マルチインデックス）
  ┌────────────────┬──────┐
  │ index          │ 売上 │
  │ (部署, 年度)   │      │
  ├───────┬────────┼──────┤
  │ 営業  │  2023  │ 100  │
  │       ├────────┼──────┤
  │       │  2024  │ 120  │
  ├───────┼────────┼──────┤
  │ 開発  │  2023  │ 200  │
  │       ├────────┼──────┤
  │       │  2024  │ 220  │
  └───────┴────────┴──────┘
    ↑        ↑
  level0   level1
  （部署） （年度）

┌─────────────────────────────────────────────────────────────┐
│  複数列で groupby → マルチインデックスが生成される         │
│  Section3 で学んだマルチインデックスへのアクセス方法が使える│
└─────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2023, 2024, 2024],
    "売上": [100, 80, 120, 200, 180, 220]
})

print("=== 元のデータ ===")
print(df)

# 複数列でグループ化
result = df.groupby(["部署", "年度"])["売上"].sum()
print("\n=== 部署・年度別 売上合計 ===")
print(result)

print("\n=== インデックス構造 ===")
print(result.index)
```

**実行結果:**
```
=== 元のデータ ===
   部署    年度   売上
0  営業  2023   100
1  営業  2023    80
2  営業  2024   120
3  開発  2023   200
4  開発  2024   180
5  開発  2024   220

=== 部署・年度別 売上合計 ===
部署  年度
営業  2023    180
      2024    120
開発  2023    200
      2024    400
Name: 売上, dtype: int64

=== インデックス構造 ===
MultiIndex([('営業', 2023),
            ('営業', 2024),
            ('開発', 2023),
            ('開発', 2024)],
           names=['部署', '年度'])
```

### マルチインデックスへのアクセス

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "年度": [2023, 2024, 2023, 2024],
    "売上": [180, 120, 200, 400]
})

result = df.groupby(["部署", "年度"])["売上"].sum()

# 第1レベル（部署）でアクセス
print("=== 営業部署のデータ ===")
print(result.loc["営業"])

# 両方のレベルで指定（タプル）
print("\n=== 開発部署 2024年 ===")
print(result.loc[("開発", 2024)])

# reset_index で DataFrame に戻す
print("\n=== reset_index 後 ===")
print(result.reset_index())
```

---

## 3. 複数の集計を同時に行う（agg）

### agg() の使い方

```
【agg() で複数の集計を同時実行】

  元の DataFrame
  ┌───────┬──────┬──────┐
  │ index │ 部署 │ 売上 │
  ├───────┼──────┼──────┤
  │   0   │ 営業 │ 100  │
  ├───────┼──────┼──────┤
  │   1   │ 営業 │ 150  │
  ├───────┼──────┼──────┤
  │   2   │ 開発 │ 200  │
  └───────┴──────┴──────┘

        ↓  df.groupby("部署")["売上"].agg(["sum", "mean", "count"])

  集計結果（columns = 集計関数名）
  ┌───────┬──────┬───────┬───────┐
  │ index │ sum  │ mean  │ count │
  │(部署) │      │       │       │
  ├───────┼──────┼───────┼───────┤
  │ 営業  │ 250  │ 125.0 │   2   │
  ├───────┼──────┼───────┼───────┤
  │ 開発  │ 200  │ 200.0 │   1   │
  └───────┴──────┴───────┴───────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "開発", "開発"],
    "売上": [100, 150, 120, 200, 180]
})

print("=== 元のデータ ===")
print(df)

# 複数の集計を同時に
result = df.groupby("部署")["売上"].agg(["sum", "mean", "count", "max", "min"])
print("\n=== 複数の集計結果 ===")
print(result)

print("\n=== index を確認 ===")
print(f"index: {result.index.tolist()}")
```

**実行結果:**
```
=== 元のデータ ===
   部署   売上
0  営業   100
1  営業   150
2  営業   120
3  開発   200
4  開発   180

=== 複数の集計結果 ===
      sum   mean  count  max  min
部署                              
営業  370  123.33      3  150  100
開発  380  190.00      2  200  180

=== index を確認 ===
index: ['営業', '開発']
```

### 列ごとに異なる集計

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "売上": [100, 150, 200, 180],
    "件数": [5, 8, 10, 12]
})

print("=== 元のデータ ===")
print(df)

# 列ごとに異なる集計関数を適用
result = df.groupby("部署").agg({
    "売上": ["sum", "mean"],
    "件数": ["sum", "max"]
})

print("\n=== 列ごとに異なる集計 ===")
print(result)

print("\n=== columns を確認（マルチレベル）===")
print(result.columns)
```

**実行結果:**
```
=== 列ごとに異なる集計 ===
       売上              件数     
       sum   mean  sum  max
部署                         
営業   250  125.0   13    8
開発   380  190.0   22   12

=== columns を確認（マルチレベル）===
MultiIndex([('売上', 'sum'),
            ('売上', 'mean'),
            ('件数', 'sum'),
            ('件数', 'max')],
           )
```

---

## 4. pivot_table でクロス集計

### pivot_table の基本

```
【pivot_table = Excel のピボットテーブル】

  元の DataFrame（縦持ち）
  ┌───────┬──────┬──────┬──────┐
  │ index │ 部署 │ 年度 │ 売上 │
  ├───────┼──────┼──────┼──────┤
  │   0   │ 営業 │ 2023 │ 100  │
  ├───────┼──────┼──────┼──────┤
  │   1   │ 営業 │ 2024 │ 120  │
  ├───────┼──────┼──────┼──────┤
  │   2   │ 開発 │ 2023 │ 200  │
  ├───────┼──────┼──────┼──────┤
  │   3   │ 開発 │ 2024 │ 220  │
  └───────┴──────┴──────┴──────┘

        ↓  pd.pivot_table(df, values="売上", 
                           index="部署", columns="年度")

  ピボットテーブル（横持ち）
  ┌───────┬──────┬──────┐
  │ index │ 2023 │ 2024 │   ← columns = 年度
  │(部署) │      │      │
  ├───────┼──────┼──────┤
  │ 営業  │ 100  │ 120  │
  ├───────┼──────┼──────┤
  │ 開発  │ 200  │ 220  │
  └───────┴──────┴──────┘

┌─────────────────────────────────────────────────────────────┐
│  pivot_table: 行と列を指定してクロス集計                    │
│  index = 行に配置するグループキー                           │
│  columns = 列に配置するグループキー                         │
│  values = 集計する値                                        │
└─────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "年度": [2023, 2024, 2023, 2024],
    "売上": [100, 120, 200, 220]
})

print("=== 元のデータ（縦持ち）===")
print(df)

# ピボットテーブル
pivot = pd.pivot_table(df, values="売上", index="部署", columns="年度")
print("\n=== ピボットテーブル（横持ち）===")
print(pivot)

print("\n=== index を確認 ===")
print(f"index: {pivot.index.tolist()}")
print(f"columns: {pivot.columns.tolist()}")
```

**実行結果:**
```
=== 元のデータ（縦持ち）===
   部署    年度   売上
0  営業  2023   100
1  営業  2024   120
2  開発  2023   200
3  開発  2024   220

=== ピボットテーブル（横持ち）===
年度    2023  2024
部署              
営業     100   120
開発     200   220

=== index を確認 ===
index: ['営業', '開発']
columns: [2023, 2024]
```

### 複数値がある場合の集計

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2023, 2024, 2024],
    "売上": [100, 80, 120, 200, 180, 220]
})

print("=== 元のデータ（同じ部署・年度に複数の値）===")
print(df)

# 同じグループに複数の値がある場合、デフォルトは mean
pivot_mean = pd.pivot_table(df, values="売上", index="部署", columns="年度")
print("\n=== デフォルト（平均）===")
print(pivot_mean)

# aggfunc で集計関数を指定
pivot_sum = pd.pivot_table(df, values="売上", index="部署", columns="年度", aggfunc="sum")
print("\n=== 合計（aggfunc='sum'）===")
print(pivot_sum)

# 複数の集計関数
pivot_multi = pd.pivot_table(df, values="売上", index="部署", columns="年度", 
                              aggfunc=["sum", "count"])
print("\n=== 複数の集計 ===")
print(pivot_multi)
```

**実行結果:**
```
=== デフォルト（平均）===
年度    2023   2024
部署               
営業    90.0  120.0
開発   200.0  200.0

=== 合計（aggfunc='sum'）===
年度    2023  2024
部署              
営業     180   120
開発     200   400

=== 複数の集計 ===
        sum        count     
年度   2023  2024  2023 2024
部署                        
営業    180   120     2    1
開発    200   400     1    2
```

### 合計行・列の追加（margins）

```
【margins=True で合計を追加】

  通常のピボット                  margins=True
  ┌───────┬──────┬──────┐        ┌───────┬──────┬──────┬──────┐
  │ index │ 2023 │ 2024 │        │ index │ 2023 │ 2024 │ All  │
  │(部署) │      │      │        │(部署) │      │      │      │
  ├───────┼──────┼──────┤        ├───────┼──────┼──────┼──────┤
  │ 営業  │ 180  │ 120  │   →   │ 営業  │ 180  │ 120  │ 300  │
  ├───────┼──────┼──────┤        ├───────┼──────┼──────┼──────┤
  │ 開発  │ 200  │ 400  │        │ 開発  │ 200  │ 400  │ 600  │
  └───────┴──────┴──────┘        ├───────┼──────┼──────┼──────┤
                                 │ All   │ 380  │ 520  │ 900  │
                                 └───────┴──────┴──────┴──────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2023, 2024, 2024],
    "売上": [100, 80, 120, 200, 180, 220]
})

# margins=True で合計行・列を追加
pivot = pd.pivot_table(df, values="売上", index="部署", columns="年度", 
                        aggfunc="sum", margins=True, margins_name="合計")

print("=== margins=True（合計付き）===")
print(pivot)
```

**実行結果:**
```
=== margins=True（合計付き）===
年度    2023  2024   合計
部署                    
営業     180   120   300
開発     200   400   600
合計     380   520   900
```

---

## 5. 実践：売上データの分析

### 総合例

```python
import pandas as pd

# サンプルデータ
sales = pd.DataFrame({
    "日付": ["2024-01-05", "2024-01-10", "2024-01-15", "2024-01-20",
             "2024-02-05", "2024-02-10", "2024-02-15", "2024-02-20"],
    "店舗": ["東京", "東京", "大阪", "大阪", "東京", "東京", "大阪", "大阪"],
    "カテゴリ": ["食品", "雑貨", "食品", "雑貨", "食品", "雑貨", "食品", "雑貨"],
    "売上": [10000, 8000, 12000, 6000, 11000, 9000, 13000, 7000]
})

# 月列を追加
sales["月"] = pd.to_datetime(sales["日付"]).dt.month

print("=== 売上データ ===")
print(sales)

# ===== groupby での集計 =====

# 店舗別売上合計
print("\n=== 店舗別売上合計 ===")
store_sales = sales.groupby("店舗")["売上"].sum()
print(store_sales)
print(f"\n（index = {store_sales.index.tolist()}）")

# 店舗×カテゴリ別（マルチインデックス）
print("\n=== 店舗×カテゴリ別売上合計 ===")
store_cat = sales.groupby(["店舗", "カテゴリ"])["売上"].sum()
print(store_cat)

# ===== pivot_table での集計 =====

# 店舗×月のクロス集計
print("\n=== 店舗×月 ピボットテーブル ===")
pivot = pd.pivot_table(sales, values="売上", index="店舗", columns="月", 
                        aggfunc="sum", margins=True, margins_name="合計")
print(pivot)
```

**実行結果:**
```
=== 売上データ ===
          日付  店舗 カテゴリ     売上   月
0  2024-01-05  東京      食品   10000   1
1  2024-01-10  東京      雑貨    8000   1
2  2024-01-15  大阪      食品   12000   1
3  2024-01-20  大阪      雑貨    6000   1
4  2024-02-05  東京      食品   11000   2
5  2024-02-10  東京      雑貨    9000   2
6  2024-02-15  大阪      食品   13000   2
7  2024-02-20  大阪      雑貨    7000   2

=== 店舗別売上合計 ===
店舗
大阪    38000
東京    38000
Name: 売上, dtype: int64

（index = ['大阪', '東京']）

=== 店舗×カテゴリ別売上合計 ===
店舗  カテゴリ
大阪  食品       25000
      雑貨       13000
東京  食品       21000
      雑貨       17000
Name: 売上, dtype: int64

=== 店舗×月 ピボットテーブル ===
月       1      2     合計
店舗                      
大阪  18000  20000  38000
東京  18000  20000  38000
合計  36000  40000  76000
```

---

## ✅ このセクションで学んだこと

1. **groupby**: グループ化して集計、結果の index がグループキーになる
2. **複数列で groupby**: マルチインデックスが生成される
3. **agg()**: 複数の集計関数を同時に適用
4. **pivot_table**: 行×列のクロス集計（Excel のピボットテーブル相当）
5. **margins**: 合計行・列の追加
6. **reset_index()**: グループ化結果を通常の DataFrame に戻す

---

## 🔗 次のセクション

次は「Section5: 時系列データの基礎」で、
日付型の操作とリサンプリングを学びます！
