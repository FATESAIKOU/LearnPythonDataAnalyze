# Section4: グループ化と集計 - 応用問題

## 応用問題1: 店舗売上レポート

### 問題

以下の売上データを使って、各種レポートを作成してください。

```python
import pandas as pd

sales = pd.DataFrame({
    "日付": ["2024-01-05", "2024-01-10", "2024-01-15", "2024-01-20",
             "2024-02-05", "2024-02-10", "2024-02-15", "2024-02-20",
             "2024-03-05", "2024-03-10", "2024-03-15", "2024-03-20"],
    "店舗": ["東京", "大阪", "東京", "大阪", 
             "東京", "大阪", "東京", "大阪",
             "東京", "大阪", "東京", "大阪"],
    "カテゴリ": ["食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨"],
    "売上": [15000, 12000, 8000, 6000,
             16000, 13000, 9000, 7000,
             17000, 14000, 10000, 8000]
})

# 日付を datetime 型に変換
sales["日付"] = pd.to_datetime(sales["日付"])
sales["月"] = sales["日付"].dt.month
```

#### タスク1: 店舗別の売上集計

店舗ごとに「売上合計」「売上平均」「取引件数」を計算してください。

**期待する結果:**
```
          sum       mean  count
店舗                           
大阪    60000  10000.000      6
東京    75000  12500.000      6
```

#### タスク2: 店舗×カテゴリ別売上

店舗とカテゴリの組み合わせごとの売上合計を求めてください。

**期待する結果:**
```
店舗  カテゴリ
大阪  雑貨       21000
      食品       39000
東京  雑貨       27000
      食品       48000
Name: 売上, dtype: int64
```

#### タスク3: 月別クロス集計

店舗を行、月を列にしたピボットテーブルを作成し、合計行・列も追加してください。

**期待する結果:**
```
月        1      2      3     合計
店舗                              
大阪  18000  20000  22000  60000
東京  23000  25000  27000  75000
合計  41000  45000  49000  135000
```

<details>
<summary>解答例を見る</summary>

**基本解法:**
```python
import pandas as pd

sales = pd.DataFrame({
    "日付": ["2024-01-05", "2024-01-10", "2024-01-15", "2024-01-20",
             "2024-02-05", "2024-02-10", "2024-02-15", "2024-02-20",
             "2024-03-05", "2024-03-10", "2024-03-15", "2024-03-20"],
    "店舗": ["東京", "大阪", "東京", "大阪", 
             "東京", "大阪", "東京", "大阪",
             "東京", "大阪", "東京", "大阪"],
    "カテゴリ": ["食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨"],
    "売上": [15000, 12000, 8000, 6000,
             16000, 13000, 9000, 7000,
             17000, 14000, 10000, 8000]
})

sales["日付"] = pd.to_datetime(sales["日付"])
sales["月"] = sales["日付"].dt.month

print("=== タスク1: 店舗別集計（手動）===")
for store in sales["店舗"].unique():
    store_data = sales[sales["店舗"] == store]
    total = 0
    count = 0
    for v in store_data["売上"]:
        total = total + v
        count = count + 1
    mean = total / count
    print(f"{store}: 合計={total}, 平均={mean}, 件数={count}")

print("\n=== タスク2: 店舗×カテゴリ別（手動）===")
for store in sales["店舗"].unique():
    for cat in sales["カテゴリ"].unique():
        filtered = sales[(sales["店舗"] == store) & (sales["カテゴリ"] == cat)]
        total = 0
        for v in filtered["売上"]:
            total = total + v
        print(f"{store} - {cat}: {total}")

print("\n=== タスク3: 月別クロス集計（手動）===")
stores = sales["店舗"].unique()
months = sales["月"].unique()

for store in stores:
    row_values = []
    row_total = 0
    for month in months:
        filtered = sales[(sales["店舗"] == store) & (sales["月"] == month)]
        monthly_sum = 0
        for v in filtered["売上"]:
            monthly_sum = monthly_sum + v
        row_values.append(monthly_sum)
        row_total = row_total + monthly_sum
    print(f"{store}: 月別={row_values}, 合計={row_total}")
```

**発展解法（Pandas 関数）:**
```python
import pandas as pd

sales = pd.DataFrame({
    "日付": ["2024-01-05", "2024-01-10", "2024-01-15", "2024-01-20",
             "2024-02-05", "2024-02-10", "2024-02-15", "2024-02-20",
             "2024-03-05", "2024-03-10", "2024-03-15", "2024-03-20"],
    "店舗": ["東京", "大阪", "東京", "大阪", 
             "東京", "大阪", "東京", "大阪",
             "東京", "大阪", "東京", "大阪"],
    "カテゴリ": ["食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨",
                 "食品", "食品", "雑貨", "雑貨"],
    "売上": [15000, 12000, 8000, 6000,
             16000, 13000, 9000, 7000,
             17000, 14000, 10000, 8000]
})

sales["日付"] = pd.to_datetime(sales["日付"])
sales["月"] = sales["日付"].dt.month

# タスク1: 店舗別集計
print("=== タスク1: 店舗別の売上集計 ===")
store_stats = sales.groupby("店舗")["売上"].agg(["sum", "mean", "count"])
print(store_stats)

# タスク2: 店舗×カテゴリ別売上
print("\n=== タスク2: 店舗×カテゴリ別売上 ===")
store_cat = sales.groupby(["店舗", "カテゴリ"])["売上"].sum()
print(store_cat)

# タスク3: 月別クロス集計
print("\n=== タスク3: 月別クロス集計 ===")
pivot = pd.pivot_table(sales, values="売上", index="店舗", columns="月",
                        aggfunc="sum", margins=True, margins_name="合計")
print(pivot)
```

</details>

---

## 応用問題2: 社員評価分析

### 問題

以下の社員評価データを分析してください。

```python
import pandas as pd

employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", 
               "E006", "E007", "E008", "E009", "E010"],
    "部署": ["営業", "営業", "営業", "開発", "開発",
             "開発", "開発", "人事", "人事", "人事"],
    "役職": ["一般", "リーダー", "一般", "一般", "リーダー",
             "マネージャー", "一般", "リーダー", "一般", "マネージャー"],
    "評価点": [75, 85, 68, 82, 90, 95, 78, 88, 72, 92]
})
```

#### タスク1: 部署別の評価統計

部署ごとに「平均評価」「最高評価」「最低評価」「人数」を求めてください。

**期待する結果:**
```
       mean  max  min  count
部署                        
人事  84.00   92   72      3
営業  76.00   85   68      3
開発  86.25   95   78      4
```

#### タスク2: 部署×役職別の平均評価

部署と役職の組み合わせごとの平均評価を求め、通常の DataFrame に変換してください。

**期待する結果:**
```
   部署        役職       評価点
0  人事  マネージャー  92.0
1  人事    リーダー    88.0
2  人事      一般      72.0
3  営業    リーダー    85.0
4  営業      一般      71.5
5  開発  マネージャー  95.0
6  開発    リーダー    90.0
7  開発      一般      80.0
```

#### タスク3: 役職別評価のピボット

部署を行、役職を列にした評価点平均のピボットテーブルを作成してください。

**期待する結果:**
```
役職  マネージャー  リーダー    一般
部署                             
人事        92.0     88.0   72.0
営業         NaN     85.0   71.5
開発        95.0     90.0   80.0
```

<details>
<summary>解答例を見る</summary>

**基本解法:**
```python
import pandas as pd

employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", 
               "E006", "E007", "E008", "E009", "E010"],
    "部署": ["営業", "営業", "営業", "開発", "開発",
             "開発", "開発", "人事", "人事", "人事"],
    "役職": ["一般", "リーダー", "一般", "一般", "リーダー",
             "マネージャー", "一般", "リーダー", "一般", "マネージャー"],
    "評価点": [75, 85, 68, 82, 90, 95, 78, 88, 72, 92]
})

print("=== タスク1: 部署別評価統計（手動）===")
for dept in employees["部署"].unique():
    dept_data = employees[employees["部署"] == dept]
    
    # 各統計を計算
    total = 0
    count = 0
    max_val = dept_data["評価点"].iloc[0]
    min_val = dept_data["評価点"].iloc[0]
    
    for v in dept_data["評価点"]:
        total = total + v
        count = count + 1
        if v > max_val:
            max_val = v
        if v < min_val:
            min_val = v
    
    mean = total / count
    print(f"{dept}: 平均={mean:.2f}, 最高={max_val}, 最低={min_val}, 人数={count}")

print("\n=== タスク2: 部署×役職別平均（手動）===")
for dept in sorted(employees["部署"].unique()):
    for role in employees["役職"].unique():
        filtered = employees[(employees["部署"] == dept) & (employees["役職"] == role)]
        if len(filtered) > 0:
            total = 0
            count = 0
            for v in filtered["評価点"]:
                total = total + v
                count = count + 1
            mean = total / count
            print(f"{dept} - {role}: {mean:.1f}")

print("\n=== タスク3: ピボット（手動）===")
depts = sorted(employees["部署"].unique())
roles = ["マネージャー", "リーダー", "一般"]

for dept in depts:
    row = []
    for role in roles:
        filtered = employees[(employees["部署"] == dept) & (employees["役職"] == role)]
        if len(filtered) > 0:
            total = 0
            count = 0
            for v in filtered["評価点"]:
                total = total + v
                count = count + 1
            row.append(f"{total/count:.1f}")
        else:
            row.append("NaN")
    print(f"{dept}: {row}")
```

**発展解法（Pandas 関数）:**
```python
import pandas as pd

employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", 
               "E006", "E007", "E008", "E009", "E010"],
    "部署": ["営業", "営業", "営業", "開発", "開発",
             "開発", "開発", "人事", "人事", "人事"],
    "役職": ["一般", "リーダー", "一般", "一般", "リーダー",
             "マネージャー", "一般", "リーダー", "一般", "マネージャー"],
    "評価点": [75, 85, 68, 82, 90, 95, 78, 88, 72, 92]
})

# タスク1: 部署別の評価統計
print("=== タスク1: 部署別の評価統計 ===")
dept_stats = employees.groupby("部署")["評価点"].agg(["mean", "max", "min", "count"])
print(dept_stats)

# タスク2: 部署×役職別の平均評価
print("\n=== タスク2: 部署×役職別の平均評価 ===")
dept_role = employees.groupby(["部署", "役職"])["評価点"].mean()
print(dept_role)

print("\n=== reset_index 後 ===")
dept_role_df = dept_role.reset_index()
print(dept_role_df)

# タスク3: 役職別評価のピボット
print("\n=== タスク3: 役職別評価のピボット ===")
pivot = pd.pivot_table(employees, values="評価点", index="部署", columns="役職")
print(pivot)
```

</details>

---

## 応用問題3: ECサイト注文分析

### 問題

ECサイトの注文データを分析して、レポートを作成してください。

```python
import pandas as pd

orders = pd.DataFrame({
    "注文ID": list(range(1, 17)),
    "顧客ID": ["C001", "C002", "C001", "C003", "C002", "C003", "C001", "C002",
               "C001", "C002", "C003", "C001", "C002", "C003", "C001", "C002"],
    "商品カテゴリ": ["電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "食品", "食品", "衣料品"],
    "金額": [50000, 8000, 3000, 35000, 2500, 12000, 42000, 9500,
             4500, 28000, 3800, 6500, 55000, 4200, 3200, 7800],
    "注文日": ["2024-01-05", "2024-01-08", "2024-01-12", "2024-01-15",
               "2024-01-18", "2024-01-22", "2024-02-02", "2024-02-05",
               "2024-02-10", "2024-02-15", "2024-02-18", "2024-02-22",
               "2024-03-01", "2024-03-05", "2024-03-10", "2024-03-15"]
})

orders["注文日"] = pd.to_datetime(orders["注文日"])
orders["月"] = orders["注文日"].dt.month
```

#### タスク1: 顧客別購買分析

顧客IDごとに以下を集計してください：
- 合計金額
- 注文回数
- 平均注文金額

**期待する結果:**
```
          sum  count       mean
顧客ID                         
C001   109200      6  18200.00
C002   110800      6  18466.67
C003    55000      4  13750.00
```

#### タスク2: カテゴリ×顧客のクロス集計

商品カテゴリ（行）と顧客ID（列）のクロス集計で、金額合計のピボットテーブルを作成してください。

**期待する結果:**
```
顧客ID        C001    C002   C003
商品カテゴリ                     
衣料品        6500   25300  12000
食品         10700    2500   8000
電子機器     92000   83000  35000
```

#### タスク3: 月別×カテゴリ別売上レポート

月を行、商品カテゴリを列にしたピボットテーブルを作成し、合計も含めてください。

**期待する結果:**
```
商品カテゴリ   電子機器   衣料品    食品      合計
月                                              
1           85000  20000    5500  110500
2           70000  16000    8300   94300
3           55000   7800   7400   70200
合計        210000  43800  21200  275000
```

<details>
<summary>解答例を見る</summary>

**基本解法:**
```python
import pandas as pd

orders = pd.DataFrame({
    "注文ID": list(range(1, 17)),
    "顧客ID": ["C001", "C002", "C001", "C003", "C002", "C003", "C001", "C002",
               "C001", "C002", "C003", "C001", "C002", "C003", "C001", "C002"],
    "商品カテゴリ": ["電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "食品", "食品", "衣料品"],
    "金額": [50000, 8000, 3000, 35000, 2500, 12000, 42000, 9500,
             4500, 28000, 3800, 6500, 55000, 4200, 3200, 7800],
    "注文日": ["2024-01-05", "2024-01-08", "2024-01-12", "2024-01-15",
               "2024-01-18", "2024-01-22", "2024-02-02", "2024-02-05",
               "2024-02-10", "2024-02-15", "2024-02-18", "2024-02-22",
               "2024-03-01", "2024-03-05", "2024-03-10", "2024-03-15"]
})

orders["注文日"] = pd.to_datetime(orders["注文日"])
orders["月"] = orders["注文日"].dt.month

print("=== タスク1: 顧客別購買分析（手動）===")
for customer in sorted(orders["顧客ID"].unique()):
    customer_data = orders[orders["顧客ID"] == customer]
    total = 0
    count = 0
    for v in customer_data["金額"]:
        total = total + v
        count = count + 1
    mean = total / count
    print(f"{customer}: 合計={total}, 回数={count}, 平均={mean:.2f}")

print("\n=== タスク2: カテゴリ×顧客クロス集計（手動）===")
categories = sorted(orders["商品カテゴリ"].unique())
customers = sorted(orders["顧客ID"].unique())

for cat in categories:
    row = []
    for cust in customers:
        filtered = orders[(orders["商品カテゴリ"] == cat) & (orders["顧客ID"] == cust)]
        total = 0
        for v in filtered["金額"]:
            total = total + v
        row.append(total)
    print(f"{cat}: {row}")

print("\n=== タスク3: 月別×カテゴリ別（手動）===")
months = sorted(orders["月"].unique())
categories = ["電子機器", "衣料品", "食品"]

grand_total = 0
for month in months:
    row = []
    row_total = 0
    for cat in categories:
        filtered = orders[(orders["月"] == month) & (orders["商品カテゴリ"] == cat)]
        total = 0
        for v in filtered["金額"]:
            total = total + v
        row.append(total)
        row_total = row_total + total
    grand_total = grand_total + row_total
    print(f"月{month}: {row}, 合計={row_total}")

print(f"総合計: {grand_total}")
```

**発展解法（Pandas 関数）:**
```python
import pandas as pd

orders = pd.DataFrame({
    "注文ID": list(range(1, 17)),
    "顧客ID": ["C001", "C002", "C001", "C003", "C002", "C003", "C001", "C002",
               "C001", "C002", "C003", "C001", "C002", "C003", "C001", "C002"],
    "商品カテゴリ": ["電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "衣料品", "食品", "電子機器", "食品", "衣料品",
                     "電子機器", "食品", "食品", "衣料品"],
    "金額": [50000, 8000, 3000, 35000, 2500, 12000, 42000, 9500,
             4500, 28000, 3800, 6500, 55000, 4200, 3200, 7800],
    "注文日": ["2024-01-05", "2024-01-08", "2024-01-12", "2024-01-15",
               "2024-01-18", "2024-01-22", "2024-02-02", "2024-02-05",
               "2024-02-10", "2024-02-15", "2024-02-18", "2024-02-22",
               "2024-03-01", "2024-03-05", "2024-03-10", "2024-03-15"]
})

orders["注文日"] = pd.to_datetime(orders["注文日"])
orders["月"] = orders["注文日"].dt.month

print("=== 元のデータ ===")
print(orders.head())

# タスク1: 顧客別購買分析
print("\n=== タスク1: 顧客別購買分析 ===")
customer_stats = orders.groupby("顧客ID")["金額"].agg(["sum", "count", "mean"])
print(customer_stats)

# タスク2: カテゴリ×顧客のクロス集計
print("\n=== タスク2: カテゴリ×顧客のクロス集計 ===")
cat_customer = pd.pivot_table(orders, values="金額", 
                               index="商品カテゴリ", columns="顧客ID",
                               aggfunc="sum")
print(cat_customer)

# タスク3: 月別×カテゴリ別売上レポート
print("\n=== タスク3: 月別×カテゴリ別売上レポート ===")
monthly_cat = pd.pivot_table(orders, values="金額",
                              index="月", columns="商品カテゴリ",
                              aggfunc="sum", margins=True, margins_name="合計")
print(monthly_cat)

# 列の順序を調整（オプション）
print("\n=== 列順序を調整 ===")
monthly_cat = monthly_cat[["電子機器", "衣料品", "食品", "合計"]]
print(monthly_cat)
```

</details>

---

## 🎉 応用問題完了！

グループ化と集計をマスターしました！

**学んだこと:**
- groupby でグループごとに集計
- 複数列での groupby → マルチインデックス
- agg() で複数の集計を同時に実行
- pivot_table で Excel 風のクロス集計
- margins で合計行・列の追加

**次のステップ:**
Section5「時系列データの基礎」で日付型の操作を学びましょう！
