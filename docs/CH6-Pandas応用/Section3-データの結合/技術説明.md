# Section3: データの結合 - 技術説明

## 🎯 このセクションで学ぶこと

複数の DataFrame を結合する前に、まず **インデックス（index）** の概念を理解することが重要です。
インデックスを理解すれば、結合操作がより直感的になります。

---

## 1. インデックス（index）の基礎

### インデックスとは

```
【DataFrame の構造】

                        列（columns）
                    ┌──────┬──────┬──────┐
                    │ 名前 │ 年齢 │ 部署 │
            ┌───────┼──────┼──────┼──────┤
            │   0   │ 田中 │  25  │ 営業 │
            ├───────┼──────┼──────┼──────┤
 index      │   1   │ 佐藤 │  30  │ 開発 │  ← データ（values）
（行ラベル）├───────┼──────┼──────┼──────┤
            │   2   │ 鈴木 │  28  │ 総務 │
            └───────┴──────┴──────┴──────┘

┌───────────────────────────────────────────────────────────────┐
│  index = 各行を識別するためのラベル（デフォルトは 0, 1, 2...）│
│  columns = 各列を識別するためのラベル（列名）                 │
│  values = 実際のデータ                                        │
└───────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"],
    "年齢": [25, 30, 28],
    "部署": ["営業", "開発", "総務"]
})

print("=== DataFrame ===")
print(df)

print("\n=== インデックス ===")
print(df.index)

print("\n=== カラム ===")
print(df.columns)

print("\n=== 値 ===")
print(df.values)
```

**実行結果:**
```
=== DataFrame ===
   名前  年齢  部署
0  田中    25  営業
1  佐藤    30  開発
2  鈴木    28  総務

=== インデックス ===
RangeIndex(start=0, stop=3, step=1)

=== カラム ===
Index(['名前', '年齢', '部署'], dtype='object')

=== 値 ===
[['田中' 25 '営業']
 ['佐藤' 30 '開発']
 ['鈴木' 28 '総務']]
```

### インデックスの設定と変更

```
【インデックスの設定】

  デフォルト                    社員ID をインデックスに
  ┌───┬───────┬──────┐           ┌───────┬──────┬──────┐
  │   │ 社員ID│ 名前 │           │       │      │ 名前 │
  ├───┼───────┼──────┤   set_    ├───────┼──────┼──────┤
  │ 0 │ E001  │ 田中 │  ──────→ │ E001  │      │ 田中 │
  ├───┼───────┼──────┤  index()  ├───────┼──────┼──────┤
  │ 1 │ E002  │ 佐藤 │           │ E002  │      │ 佐藤 │
  └───┴───────┴──────┘           └───────┴──────┴──────┘

  ※ set_index() で列をインデックスに変換
  ※ reset_index() でインデックスを列に戻す
```

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003"],
    "名前": ["田中", "佐藤", "鈴木"],
    "年齢": [25, 30, 28]
})

print("=== 元のデータ ===")
print(df)

# 社員ID をインデックスに設定
df_indexed = df.set_index("社員ID")
print("\n=== set_index 後 ===")
print(df_indexed)

# インデックスをリセット
df_reset = df_indexed.reset_index()
print("\n=== reset_index 後 ===")
print(df_reset)
```

**実行結果:**
```
=== 元のデータ ===
  社員ID  名前  年齢
0   E001  田中    25
1   E002  佐藤    30
2   E003  鈴木    28

=== set_index 後 ===
        名前  年齢
社員ID            
E001    田中    25
E002    佐藤    30
E003    鈴木    28

=== reset_index 後 ===
  社員ID  名前  年齢
0   E001  田中    25
1   E002  佐藤    30
2   E003  鈴木    28
```

### インデックスによるデータアクセス

```
【loc と iloc の違い】

         ┌───────┬──────┬──────┐
         │       │ 名前 │ 年齢 │
         ├───────┼──────┼──────┤
         │ E001  │ 田中 │  25  │
         ├───────┼──────┼──────┤
         │ E002  │ 佐藤 │  30  │
         ├───────┼──────┼──────┤
         │ E003  │ 鈴木 │  28  │
         └───────┴──────┴──────┘

  df.loc["E002"]  → インデックスラベルで指定 → 佐藤のデータ
  df.iloc[1]      → 位置番号（0始まり）で指定 → 佐藤のデータ

┌─────────────────────────────────────────────────────────────┐
│  loc = label-based（ラベル名で指定）                        │
│  iloc = integer-based（整数位置で指定）                     │
└─────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"],
    "年齢": [25, 30, 28]
}, index=["E001", "E002", "E003"])

print("=== DataFrame ===")
print(df)

# loc: ラベルでアクセス
print("\n=== loc['E002'] ===")
print(df.loc["E002"])

# iloc: 位置でアクセス
print("\n=== iloc[1] ===")
print(df.iloc[1])

# 複数行の範囲指定
print("\n=== loc['E001':'E002'] ===")
print(df.loc["E001":"E002"])
```

---

## 2. マルチインデックス（MultiIndex）

### マルチインデックスとは

```
【マルチインデックス = 階層的なインデックス】

  通常のインデックス                 マルチインデックス
  ┌───┬──────┬──────┬──────┐        ┌──────┬──────┬──────┐
  │   │ 部署 │ 名前 │ 売上 │        │      │      │ 売上 │
  ├───┼──────┼──────┼──────┤        ├──────┼──────┼──────┤
  │ 0 │ 営業 │ 田中 │ 100  │        │ 営業 │ 田中 │ 100  │
  │ 1 │ 営業 │ 佐藤 │ 150  │ →→→ │      │ 佐藤 │ 150  │
  │ 2 │ 開発 │ 鈴木 │ 200  │        │ 開発 │ 鈴木 │ 200  │
  │ 3 │ 開発 │ 高橋 │ 180  │        │      │ 高橋 │ 180  │
  └───┴──────┴──────┴──────┘        └──────┴──────┴──────┘
                                      ↑      ↑
                                    level0  level1
                                    （部署）（名前）

┌───────────────────────────────────────────────────────────────┐
│  マルチインデックス = 複数の列を組み合わせてインデックスにする│
│  → グループ化したデータの表現に便利                          │
│  → groupby の結果はマルチインデックスになることが多い        │
└───────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})

print("=== 元のデータ ===")
print(df)

# マルチインデックスを設定
df_multi = df.set_index(["部署", "名前"])
print("\n=== マルチインデックス ===")
print(df_multi)

print("\n=== インデックス構造 ===")
print(df_multi.index)
```

**実行結果:**
```
=== 元のデータ ===
   部署  名前   売上
0  営業  田中   100
1  営業  佐藤   150
2  開発  鈴木   200
3  開発  高橋   180

=== マルチインデックス ===
          売上
部署 名前      
営業 田中   100
     佐藤   150
開発 鈴木   200
     高橋   180

=== インデックス構造 ===
MultiIndex([('営業', '田中'),
            ('営業', '佐藤'),
            ('開発', '鈴木'),
            ('開発', '高橋')],
           names=['部署', '名前'])
```

### マルチインデックスへのアクセス

```
【マルチインデックスへのアクセス方法】

          売上
部署 名前      
営業 田中   100    df.loc["営業"]        → 営業部署のすべて
     佐藤   150    df.loc[("営業","田中")] → 営業部署の田中
開発 鈴木   200    
     高橋   180    

  ※ 第1レベルだけ指定 → そのグループ全体を取得
  ※ タプルで両方指定 → 特定の1行を取得
```

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})
df_multi = df.set_index(["部署", "名前"])

# 第1レベル（部署）でアクセス
print("=== 営業部署のデータ ===")
print(df_multi.loc["営業"])

# 両方のレベルで指定（タプル）
print("\n=== 営業部署の田中さん ===")
print(df_multi.loc[("営業", "田中")])

# リセットして元に戻す
print("\n=== reset_index ===")
print(df_multi.reset_index())
```

---

## 3. データ結合の概要

### なぜデータ結合が必要か

```
【データ結合の必要性】

┌─────────────────────────────────────────────────────────────────┐
│  実務では、データが複数のテーブルに分かれていることが多い       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  売上テーブル              商品マスタ                           │
│  ┌──────┬──────┬─────┐    ┌──────┬──────────┬─────┐             │
│  │注文ID│商品ID│数量 │    │商品ID│  商品名  │単価 │             │
│  ├──────┼──────┼─────┤    ├──────┼──────────┼─────┤             │
│  │  1   │ P001 │ 10  │    │ P001 │ りんご   │ 100 │             │
│  │  2   │ P002 │  5  │    │ P002 │ みかん   │  50 │             │
│  └──────┴──────┴─────┘    └──────┴──────────┴─────┘             │
│                                                                 │
│        ↓  商品ID で結合  ↓                                    │
│                                                                 │
│  結合後                                                         │
│  ┌──────┬──────┬─────┬──────────┬─────┐                         │
│  │注文ID│商品ID│数量 │  商品名  │単価 │                         │
│  ├──────┼──────┼─────┼──────────┼─────┤                         │
│  │  1   │ P001 │ 10  │ りんご   │ 100 │                         │
│  │  2   │ P002 │  5  │ みかん   │  50 │                         │
│  └──────┴──────┴─────┴──────────┴─────┘                         │
│                                                                 │
│  → 商品名と単価が追加され、売上金額の計算が可能に！            │
└─────────────────────────────────────────────────────────────────┘
```

### 結合方法の種類とインデックスの関係

```
【Pandas の結合メソッドとインデックス】

┌─────────────┬─────────────────────────────────────────────────┐
│ メソッド    │ 用途とインデックスの関係                        │
├─────────────┼─────────────────────────────────────────────────┤
│ concat()    │ 単純に縦または横に連結                          │
│             │ インデックスはそのまま維持 or 振り直し          │
├─────────────┼─────────────────────────────────────────────────┤
│ merge()     │ キー列を使って結合（SQL の JOIN と同様）        │
│             │ 結果のインデックスは振り直される                │
├─────────────┼─────────────────────────────────────────────────┤
│ join()      │ インデックスをキーとして結合                    │
│             │ インデックスが一致する行を結合                  │
└─────────────┴─────────────────────────────────────────────────┘
```

---

## 4. concat() で連結

### 縦方向の連結（行を追加）

```
【concat() 縦方向連結】

    DataFrame 1              DataFrame 2
    ┌──────┬──────┐          ┌──────┬──────┐
    │ 名前 │ 年齢 │          │ 名前 │ 年齢 │
    ├──────┼──────┤          ├──────┼──────┤
  0 │ 田中 │  25  │        0 │ 伊藤 │  35  │
    ├──────┼──────┤          ├──────┼──────┤
  1 │ 佐藤 │  30  │        1 │ 山田 │  40  │
    └──────┴──────┘          └──────┴──────┘

                 ↓  concat([df1, df2])

    結合後（インデックス重複）    ignore_index=True
    ┌──────┬──────┐              ┌──────┬──────┐
    │ 名前 │ 年齢 │              │ 名前 │ 年齢 │
    ├──────┼──────┤              ├──────┼──────┤
  0 │ 田中 │  25  │            0 │ 田中 │  25  │
    ├──────┼──────┤              ├──────┼──────┤
  1 │ 佐藤 │  30  │            1 │ 佐藤 │  30  │
    ├──────┼──────┤              ├──────┼──────┤
  0 │ 伊藤 │  35  │ ← 重複！  2 │ 伊藤 │  35  │ ← 連番
    ├──────┼──────┤              ├──────┼──────┤
  1 │ 山田 │  40  │            3 │ 山田 │  40  │
    └──────┴──────┘              └──────┴──────┘
```

```python
import pandas as pd

df1 = pd.DataFrame({
    "名前": ["田中", "佐藤"],
    "年齢": [25, 30]
})

df2 = pd.DataFrame({
    "名前": ["伊藤", "山田"],
    "年齢": [35, 40]
})

# 縦方向に連結
df_concat = pd.concat([df1, df2])
print("=== concat（インデックス重複）===")
print(df_concat)

# インデックスをリセット
df_concat = pd.concat([df1, df2], ignore_index=True)
print("\n=== ignore_index=True ===")
print(df_concat)
```

### 横方向の連結（列を追加）

```
【concat() 横方向連結（axis=1）】

    DataFrame 1              DataFrame 2
    ┌──────┬──────┐          ┌──────┐
    │ 名前 │ 年齢 │          │ 部署 │
    ├──────┼──────┤          ├──────┤
  0 │ 田中 │  25  │        0 │ 営業 │
    ├──────┼──────┤          ├──────┤
  1 │ 佐藤 │  30  │        1 │ 開発 │
    └──────┴──────┘          └──────┘

         ↓  concat([df1, df2], axis=1)

    結合後（インデックスで対応）
    ┌──────┬──────┬──────┐
    │ 名前 │ 年齢 │ 部署 │
    ├──────┼──────┼──────┤
  0 │ 田中 │  25  │ 営業 │  ← インデックス 0 同士が結合
    ├──────┼──────┼──────┤
  1 │ 佐藤 │  30  │ 開発 │  ← インデックス 1 同士が結合
    └──────┴──────┴──────┘

  ※ 横方向連結はインデックスで行を対応させる！
```

```python
import pandas as pd

df1 = pd.DataFrame({
    "名前": ["田中", "佐藤"],
    "年齢": [25, 30]
})

df2 = pd.DataFrame({
    "部署": ["営業", "開発"]
})

# 横方向に連結（axis=1）
df_concat = pd.concat([df1, df2], axis=1)
print(df_concat)
```

```
【concat() の主な引数】

┌─────────────────────┬───────────────────────────────────────────┐
│   引数              │   説明                                    │
├─────────────────────┼───────────────────────────────────────────┤
│ axis=0              │ 縦方向に連結（デフォルト）                │
│ axis=1              │ 横方向に連結                              │
│ ignore_index=True   │ インデックスを振り直す                    │
│ keys=[...]          │ 階層的なインデックスを付ける              │
│ join="outer"        │ すべての列を含む（デフォルト）            │
│ join="inner"        │ 共通の列のみ含む                          │
└─────────────────────┴───────────────────────────────────────────┘
```

---

## 5. merge() でキー結合

### merge() の基本

```
【merge() の動作】

    左の DataFrame           右の DataFrame
    ┌──────┬──────┬─────┐    ┌──────┬──────────┐
    │注文ID│商品ID│数量 │    │商品ID│  商品名  │
    ├──────┼──────┼─────┤    ├──────┼──────────┤
    │  1   │ P001 │ 10  │    │ P001 │ りんご   │
    ├──────┼──────┼─────┤    ├──────┼──────────┤
    │  2   │ P002 │  5  │    │ P002 │ みかん   │
    └──────┴──────┴─────┘    └──────┴──────────┘

            ↓  merge(left, right, on="商品ID")

    結合後
    ┌──────┬──────┬─────┬──────────┐
    │注文ID│商品ID│数量 │  商品名  │
    ├──────┼──────┼─────┼──────────┤
    │  1   │ P001 │ 10  │ りんご   │  ← 商品ID が一致する行を結合
    ├──────┼──────┼─────┼──────────┤
    │  2   │ P002 │  5  │ みかん   │
    └──────┴──────┴─────┴──────────┘

  ※ merge() は列の値でマッチング（インデックスは無視される）
  ※ 結果のインデックスは 0, 1, 2... に振り直される
```

```python
import pandas as pd

# 売上データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3],
    "商品ID": ["P001", "P002", "P001"],
    "数量": [10, 5, 8]
})

# 商品マスタ
products = pd.DataFrame({
    "商品ID": ["P001", "P002", "P003"],
    "商品名": ["りんご", "みかん", "バナナ"],
    "単価": [100, 50, 80]
})

print("=== 売上データ ===")
print(orders)
print("\n=== 商品マスタ ===")
print(products)

# 商品ID で結合
df_merged = pd.merge(orders, products, on="商品ID")
print("\n=== merge 後 ===")
print(df_merged)
```

### 結合の種類（how パラメータ）

```
【結合の種類】

┌─────────────────────────────────────────────────────────────────┐
│  left（左の DataFrame）    right（右の DataFrame）              │
│  ┌──────┬──────┐           ┌──────┬──────┐                      │
│  │ key  │ val1 │           │ key  │ val2 │                      │
│  ├──────┼──────┤           ├──────┼──────┤                      │
│  │  A   │  1   │           │  A   │  X   │                      │
│  │  B   │  2   │           │  C   │  Y   │                      │
│  │  C   │  3   │           │  D   │  Z   │                      │
│  └──────┴──────┘           └──────┴──────┘                      │
└─────────────────────────────────────────────────────────────────┘

【inner（内部結合）】両方に存在するキーのみ
    ┌──────┬──────┬──────┐
    │ key  │ val1 │ val2 │
    ├──────┼──────┼──────┤
    │  A   │  1   │  X   │  ← A と C のみ
    │  C   │  3   │  Y   │
    └──────┴──────┴──────┘

【left（左外部結合）】左のすべて + 右のマッチ
    ┌──────┬──────┬──────┐
    │ key  │ val1 │ val2 │
    ├──────┼──────┼──────┤
    │  A   │  1   │  X   │
    │  B   │  2   │ NaN  │  ← 右にない B は NaN
    │  C   │  3   │  Y   │
    └──────┴──────┴──────┘

【right（右外部結合）】右のすべて + 左のマッチ
    ┌──────┬──────┬──────┐
    │ key  │ val1 │ val2 │
    ├──────┼──────┼──────┤
    │  A   │  1   │  X   │
    │  C   │  3   │  Y   │
    │  D   │ NaN  │  Z   │  ← 左にない D は NaN
    └──────┴──────┴──────┘

【outer（完全外部結合）】両方のすべて
    ┌──────┬──────┬──────┐
    │ key  │ val1 │ val2 │
    ├──────┼──────┼──────┤
    │  A   │  1   │  X   │
    │  B   │  2   │ NaN  │
    │  C   │  3   │  Y   │
    │  D   │ NaN  │  Z   │
    └──────┴──────┴──────┘
```

```python
import pandas as pd

left = pd.DataFrame({
    "key": ["A", "B", "C"],
    "val1": [1, 2, 3]
})

right = pd.DataFrame({
    "key": ["A", "C", "D"],
    "val2": ["X", "Y", "Z"]
})

# inner（デフォルト）
print("=== inner join ===")
print(pd.merge(left, right, on="key", how="inner"))

# left
print("\n=== left join ===")
print(pd.merge(left, right, on="key", how="left"))

# right
print("\n=== right join ===")
print(pd.merge(left, right, on="key", how="right"))

# outer
print("\n=== outer join ===")
print(pd.merge(left, right, on="key", how="outer"))
```

```
【merge() の主な引数】

┌─────────────────────┬───────────────────────────────────────────┐
│   引数              │   説明                                    │
├─────────────────────┼───────────────────────────────────────────┤
│ on="列名"           │ 結合キーとなる列（両方に同名の列がある時）│
│ left_on="列名"      │ 左の結合キー列                            │
│ right_on="列名"     │ 右の結合キー列                            │
│ how="inner"         │ 結合方法（inner/left/right/outer）        │
│ suffixes=("_x","_y")│ 重複列名に付けるサフィックス              │
└─────────────────────┴───────────────────────────────────────────┘
```

---

## 6. join() でインデックス結合

### join() の基本

`join()` は **インデックス** をキーとして結合します。

```
【join() の動作 - インデックスで結合】

    左の DataFrame              右の DataFrame
    （インデックスがキー）      （インデックスがキー）
    ┌───────┬──────┐            ┌───────┬──────┐
    │ index │ 名前 │            │ index │ 部署 │
    ├───────┼──────┤            ├───────┼──────┤
    │ E001  │ 田中 │            │ E001  │ 営業 │
    ├───────┼──────┤            ├───────┼──────┤
    │ E002  │ 佐藤 │            │ E002  │ 開発 │
    └───────┴──────┘            └───────┴──────┘

           ↓  left.join(right)

    結合後
    ┌───────┬──────┬──────┐
    │ index │ 名前 │ 部署 │
    ├───────┼──────┼──────┤
    │ E001  │ 田中 │ 営業 │  ← インデックス E001 同士が結合
    ├───────┼──────┼──────┤
    │ E002  │ 佐藤 │ 開発 │  ← インデックス E002 同士が結合
    └───────┴──────┴──────┘

  ※ join() はインデックスでマッチング
  ※ merge() は列の値でマッチング
```

```python
import pandas as pd

# インデックスを設定した DataFrame
df1 = pd.DataFrame({
    "名前": ["田中", "佐藤"]
}, index=["E001", "E002"])

df2 = pd.DataFrame({
    "部署": ["営業", "開発"]
}, index=["E001", "E002"])

print("=== df1 ===")
print(df1)
print("\n=== df2 ===")
print(df2)

# join で結合（インデックスをキーに）
df_joined = df1.join(df2)
print("\n=== join 後 ===")
print(df_joined)
```

### merge() vs join() の比較

```
【merge() と join() の違い】

┌─────────────────────────────────────────────────────────────────┐
│                     merge()                                     │
├─────────────────────────────────────────────────────────────────┤
│  ・列の値でマッチング                                           │
│  ・結合キーを on パラメータで指定                               │
│  ・結果のインデックスは 0, 1, 2... に振り直される               │
│  ・pd.merge(df1, df2, on="キー列")                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     join()                                      │
├─────────────────────────────────────────────────────────────────┤
│  ・インデックスでマッチング                                     │
│  ・事前に set_index() でインデックスを設定しておく必要あり      │
│  ・元のインデックスが保持される                                 │
│  ・df1.join(df2)                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 実践：複数テーブルの結合

### 典型的なデータ結合の例

```python
import pandas as pd

# ===== 3つのテーブルを用意 =====

# 注文データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3, 4],
    "顧客ID": ["C001", "C002", "C001", "C003"],
    "商品ID": ["P001", "P002", "P003", "P001"],
    "数量": [2, 1, 3, 1]
})

# 顧客マスタ
customers = pd.DataFrame({
    "顧客ID": ["C001", "C002", "C003"],
    "顧客名": ["田中商店", "佐藤工業", "鈴木電機"]
})

# 商品マスタ
products = pd.DataFrame({
    "商品ID": ["P001", "P002", "P003"],
    "商品名": ["ノートPC", "マウス", "キーボード"],
    "単価": [80000, 3000, 5000]
})

print("=== 注文データ ===")
print(orders)

# Step 1: 注文と顧客を結合
df = pd.merge(orders, customers, on="顧客ID")
print("\n=== Step 1: 顧客情報を追加 ===")
print(df)

# Step 2: さらに商品情報を結合
df = pd.merge(df, products, on="商品ID")
print("\n=== Step 2: 商品情報を追加 ===")
print(df)

# Step 3: 売上を計算
df["売上"] = df["数量"] * df["単価"]
print("\n=== Step 3: 売上を計算 ===")
print(df)
```

---

## ✅ このセクションで学んだこと

1. **インデックス**: 各行を識別するラベル、set_index/reset_index で操作
2. **マルチインデックス**: 複数列を組み合わせた階層的インデックス
3. **loc/iloc**: ラベル指定 vs 位置指定でのアクセス
4. **concat()**: DataFrame を縦または横に単純連結
5. **merge()**: キー列を使って結合（SQL の JOIN 相当）
6. **join()**: インデックスをキーとして結合
7. **結合の種類**: inner, left, right, outer の違い

---

## 🔗 次のセクション

次は「Section4: グループ化と集計」で、
groupby による集計（マルチインデックスを生成）を学びます！
