# Section3: データの結合 - 演習問題

## 📝 演習の進め方

1. 各問題のコードをJupyter Notebookで実行してください
2. 結果を予想してから実行しましょう
3. 解答例は `<details>` をクリックして確認できます

---

## 演習1: インデックスの確認

DataFrame のインデックス、カラム、値を確認してください。

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["りんご", "みかん", "バナナ"],
    "価格": [100, 80, 120],
    "在庫": [50, 30, 45]
})

print("=== DataFrame ===")
print(df)

# TODO: インデックス、カラム、値を表示
# print(df.???)
# print(df.???)
# print(df.???)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "商品名": ["りんご", "みかん", "バナナ"],
    "価格": [100, 80, 120],
    "在庫": [50, 30, 45]
})

print("=== DataFrame ===")
print(df)

# インデックス
print("\n=== インデックス ===")
print(df.index)

# カラム
print("\n=== カラム ===")
print(df.columns)

# 値
print("\n=== 値 ===")
print(df.values)
```

**実行結果:**
```
=== DataFrame ===
   商品名   価格  在庫
0  りんご   100    50
1  みかん    80    30
2  バナナ   120    45

=== インデックス ===
RangeIndex(start=0, stop=3, step=1)

=== カラム ===
Index(['商品名', '価格', '在庫'], dtype='object')

=== 値 ===
[['りんご' 100 50]
 ['みかん' 80 30]
 ['バナナ' 120 45]]
```

</details>

---

## 演習2: set_index と reset_index

社員ID をインデックスに設定し、その後リセットしてください。

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003"],
    "名前": ["田中", "佐藤", "鈴木"],
    "部署": ["営業", "開発", "総務"]
})

print("=== 元のデータ ===")
print(df)

# TODO: 社員ID をインデックスに設定
# df_indexed = ???

print("\n=== set_index 後 ===")
print(df_indexed)

# TODO: インデックスをリセット
# df_reset = ???

print("\n=== reset_index 後 ===")
print(df_reset)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003"],
    "名前": ["田中", "佐藤", "鈴木"],
    "部署": ["営業", "開発", "総務"]
})

print("=== 元のデータ ===")
print(df)

# 社員ID をインデックスに設定
df_indexed = df.set_index("社員ID")

print("\n=== set_index 後 ===")
print(df_indexed)

# インデックスをリセット
df_reset = df_indexed.reset_index()

print("\n=== reset_index 後 ===")
print(df_reset)
```

**実行結果:**
```
=== 元のデータ ===
  社員ID  名前  部署
0   E001  田中  営業
1   E002  佐藤  開発
2   E003  鈴木  総務

=== set_index 後 ===
        名前  部署
社員ID           
E001    田中  営業
E002    佐藤  開発
E003    鈴木  総務

=== reset_index 後 ===
  社員ID  名前  部署
0   E001  田中  営業
1   E002  佐藤  開発
2   E003  鈴木  総務
```

</details>

---

## 演習3: loc と iloc でアクセス

インデックスを設定した DataFrame に loc と iloc でアクセスしてください。

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "年齢": [25, 30, 28, 35],
    "部署": ["営業", "開発", "総務", "営業"]
}, index=["E001", "E002", "E003", "E004"])

print("=== DataFrame ===")
print(df)

# TODO: loc で E002 の行を取得
# print(df.loc[???])

# TODO: iloc で 2番目の行（インデックス位置1）を取得
# print(df.iloc[???])

# TODO: loc で E001 から E003 までの範囲を取得
# print(df.loc[???])
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "年齢": [25, 30, 28, 35],
    "部署": ["営業", "開発", "総務", "営業"]
}, index=["E001", "E002", "E003", "E004"])

print("=== DataFrame ===")
print(df)

# loc で E002 の行を取得
print("\n=== loc['E002'] ===")
print(df.loc["E002"])

# iloc で 2番目の行（インデックス位置1）を取得
print("\n=== iloc[1] ===")
print(df.iloc[1])

# loc で E001 から E003 までの範囲を取得
print("\n=== loc['E001':'E003'] ===")
print(df.loc["E001":"E003"])
```

**実行結果:**
```
=== DataFrame ===
      名前  年齢  部署
E001  田中    25  営業
E002  佐藤    30  開発
E003  鈴木    28  総務
E004  高橋    35  営業

=== loc['E002'] ===
名前    佐藤
年齢      30
部署    開発
Name: E002, dtype: object

=== iloc[1] ===
名前    佐藤
年齢      30
部署    開発
Name: E002, dtype: object

=== loc['E001':'E003'] ===
      名前  年齢  部署
E001  田中    25  営業
E002  佐藤    30  開発
E003  鈴木    28  総務
```

</details>

---

## 演習4: マルチインデックスの作成

部署と名前でマルチインデックスを作成してください。

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})

print("=== 元のデータ ===")
print(df)

# TODO: 部署と名前でマルチインデックスを作成
# df_multi = ???

print("\n=== マルチインデックス ===")
print(df_multi)

# TODO: インデックスの構造を表示
# print(df_multi.???)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})

print("=== 元のデータ ===")
print(df)

# 部署と名前でマルチインデックスを作成
df_multi = df.set_index(["部署", "名前"])

print("\n=== マルチインデックス ===")
print(df_multi)

# インデックスの構造を表示
print("\n=== インデックス構造 ===")
print(df_multi.index)
```

**実行結果:**
```
=== 元のデータ ===
   部署  名前   売上
0  営業  田中   100
1  営業  佐藤   150
2  開発  鈴木   200
3  開発  高橋   180

=== マルチインデックス ===
          売上
部署 名前      
営業 田中   100
     佐藤   150
開発 鈴木   200
     高橋   180

=== インデックス構造 ===
MultiIndex([('営業', '田中'),
            ('営業', '佐藤'),
            ('開発', '鈴木'),
            ('開発', '高橋')],
           names=['部署', '名前'])
```

</details>

---

## 演習5: マルチインデックスへのアクセス

マルチインデックスに対して loc でアクセスしてください。

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})
df_multi = df.set_index(["部署", "名前"])

print("=== マルチインデックス ===")
print(df_multi)

# TODO: 営業部署のデータを取得
# print(df_multi.loc[???])

# TODO: 開発部署の鈴木さんのデータを取得（タプルで指定）
# print(df_multi.loc[???])
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "部署": ["営業", "営業", "開発", "開発"],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "売上": [100, 150, 200, 180]
})
df_multi = df.set_index(["部署", "名前"])

print("=== マルチインデックス ===")
print(df_multi)

# 営業部署のデータを取得
print("\n=== 営業部署 ===")
print(df_multi.loc["営業"])

# 開発部署の鈴木さんのデータを取得（タプルで指定）
print("\n=== 開発部署の鈴木さん ===")
print(df_multi.loc[("開発", "鈴木")])
```

**実行結果:**
```
=== マルチインデックス ===
          売上
部署 名前      
営業 田中   100
     佐藤   150
開発 鈴木   200
     高橋   180

=== 営業部署 ===
      売上
名前      
田中   100
佐藤   150

=== 開発部署の鈴木さん ===
売上    200
Name: (開発, 鈴木), dtype: int64
```

</details>

---

## 演習6: concat() で縦方向に連結

2つの DataFrame を縦方向に連結してください。

```python
import pandas as pd

# 1月のデータ
jan = pd.DataFrame({
    "日付": ["1/1", "1/2", "1/3"],
    "売上": [1000, 1500, 1200]
})

# 2月のデータ
feb = pd.DataFrame({
    "日付": ["2/1", "2/2", "2/3"],
    "売上": [1100, 1600, 1300]
})

print("=== 1月のデータ ===")
print(jan)
print("\n=== 2月のデータ ===")
print(feb)

# TODO: concat() で縦方向に連結し、インデックスを振り直す
# df_all = ???

print("\n=== 連結後（インデックスリセット） ===")
print(df_all)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

# 1月のデータ
jan = pd.DataFrame({
    "日付": ["1/1", "1/2", "1/3"],
    "売上": [1000, 1500, 1200]
})

# 2月のデータ
feb = pd.DataFrame({
    "日付": ["2/1", "2/2", "2/3"],
    "売上": [1100, 1600, 1300]
})

print("=== 1月のデータ ===")
print(jan)
print("\n=== 2月のデータ ===")
print(feb)

# concat() で縦方向に連結し、インデックスを振り直す
df_all = pd.concat([jan, feb], ignore_index=True)

print("\n=== 連結後（インデックスリセット） ===")
print(df_all)
```

**実行結果:**
```
=== 1月のデータ ===
   日付    売上
0  1/1  1000
1  1/2  1500
2  1/3  1200

=== 2月のデータ ===
   日付    売上
0  2/1  1100
1  2/2  1600
2  2/3  1300

=== 連結後（インデックスリセット） ===
   日付    売上
0  1/1  1000
1  1/2  1500
2  1/3  1200
3  2/1  1100
4  2/2  1600
5  2/3  1300
```

</details>

---

## 演習7: concat() で横方向に連結

2つの DataFrame を横方向に連結してください。

```python
import pandas as pd

# 基本情報
info = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"],
    "年齢": [25, 30, 28]
})

# 成績情報
scores = pd.DataFrame({
    "数学": [80, 75, 90],
    "英語": [85, 80, 70]
})

print("=== 基本情報 ===")
print(info)
print("\n=== 成績情報 ===")
print(scores)

# TODO: concat() で横方向に連結（axis=1）
# df_combined = ???

print("\n=== 連結後 ===")
print(df_combined)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

# 基本情報
info = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"],
    "年齢": [25, 30, 28]
})

# 成績情報
scores = pd.DataFrame({
    "数学": [80, 75, 90],
    "英語": [85, 80, 70]
})

print("=== 基本情報 ===")
print(info)
print("\n=== 成績情報 ===")
print(scores)

# concat() で横方向に連結（axis=1）
df_combined = pd.concat([info, scores], axis=1)

print("\n=== 連結後 ===")
print(df_combined)
```

**実行結果:**
```
=== 基本情報 ===
   名前  年齢
0  田中    25
1  佐藤    30
2  鈴木    28

=== 成績情報 ===
   数学  英語
0    80    85
1    75    80
2    90    70

=== 連結後 ===
   名前  年齢  数学  英語
0  田中    25    80    85
1  佐藤    30    75    80
2  鈴木    28    90    70
```

</details>

---

## 演習8: merge() で内部結合

注文データと商品マスタを結合してください。

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3, 4],
    "商品ID": ["A", "B", "C", "A"],
    "数量": [2, 1, 3, 1]
})

# 商品マスタ
products = pd.DataFrame({
    "商品ID": ["A", "B", "D"],
    "商品名": ["りんご", "みかん", "メロン"],
    "単価": [100, 80, 500]
})

print("=== 注文データ ===")
print(orders)
print("\n=== 商品マスタ ===")
print(products)

# TODO: 商品ID で内部結合（inner）
# df_merged = ???

print("\n=== 結合後 ===")
print(df_merged)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3, 4],
    "商品ID": ["A", "B", "C", "A"],
    "数量": [2, 1, 3, 1]
})

# 商品マスタ
products = pd.DataFrame({
    "商品ID": ["A", "B", "D"],
    "商品名": ["りんご", "みかん", "メロン"],
    "単価": [100, 80, 500]
})

print("=== 注文データ ===")
print(orders)
print("\n=== 商品マスタ ===")
print(products)

# 商品ID で内部結合（inner）
# how="inner" はデフォルトなので省略可能
df_merged = pd.merge(orders, products, on="商品ID")

print("\n=== 結合後 ===")
print(df_merged)
```

**実行結果:**
```
=== 注文データ ===
   注文ID 商品ID  数量
0      1      A     2
1      2      B     1
2      3      C     3
3      4      A     1

=== 商品マスタ ===
  商品ID  商品名  単価
0      A  りんご   100
1      B  みかん    80
2      D  メロン   500

=== 結合後 ===
   注文ID 商品ID  数量  商品名  単価
0      1      A     2  りんご   100
1      4      A     1  りんご   100
2      2      B     1  みかん    80
```

**注意:** 商品ID "C" は商品マスタにないので、結果には含まれません（内部結合）。

</details>

---

## 演習9: merge() で左外部結合

すべての注文を残しつつ、商品情報を結合してください。

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3],
    "商品ID": ["A", "B", "C"],
    "数量": [2, 1, 3]
})

# 商品マスタ（Cがない）
products = pd.DataFrame({
    "商品ID": ["A", "B"],
    "商品名": ["りんご", "みかん"],
    "単価": [100, 80]
})

print("=== 注文データ ===")
print(orders)
print("\n=== 商品マスタ ===")
print(products)

# TODO: 左外部結合（how="left"）で全注文を残す
# df_merged = ???

print("\n=== 左外部結合後 ===")
print(df_merged)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "注文ID": [1, 2, 3],
    "商品ID": ["A", "B", "C"],
    "数量": [2, 1, 3]
})

# 商品マスタ（Cがない）
products = pd.DataFrame({
    "商品ID": ["A", "B"],
    "商品名": ["りんご", "みかん"],
    "単価": [100, 80]
})

print("=== 注文データ ===")
print(orders)
print("\n=== 商品マスタ ===")
print(products)

# 左外部結合（how="left"）で全注文を残す
df_merged = pd.merge(orders, products, on="商品ID", how="left")

print("\n=== 左外部結合後 ===")
print(df_merged)
```

**実行結果:**
```
=== 注文データ ===
   注文ID 商品ID  数量
0      1      A     2
1      2      B     1
2      3      C     3

=== 商品マスタ ===
  商品ID  商品名  単価
0      A  りんご   100
1      B  みかん    80

=== 左外部結合後 ===
   注文ID 商品ID  数量  商品名    単価
0      1      A     2  りんご  100.0
1      2      B     1  みかん   80.0
2      3      C     3    NaN    NaN
```

**ポイント:** 商品ID "C" の注文も残りますが、商品名と単価は NaN になります。

</details>

---

## 演習10: join() でインデックス結合

インデックスをキーにして2つの DataFrame を結合してください。

```python
import pandas as pd

# 社員情報（インデックス付き）
employees = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"]
}, index=["E001", "E002", "E003"])

# 給与情報（インデックス付き）
salaries = pd.DataFrame({
    "給与": [300000, 350000, 280000]
}, index=["E001", "E002", "E003"])

print("=== 社員情報 ===")
print(employees)
print("\n=== 給与情報 ===")
print(salaries)

# TODO: join() でインデックスをキーに結合
# df_joined = ???

print("\n=== join 後 ===")
print(df_joined)
```

<details>
<summary>解答例を見る</summary>

```python
import pandas as pd

# 社員情報（インデックス付き）
employees = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木"]
}, index=["E001", "E002", "E003"])

# 給与情報（インデックス付き）
salaries = pd.DataFrame({
    "給与": [300000, 350000, 280000]
}, index=["E001", "E002", "E003"])

print("=== 社員情報 ===")
print(employees)
print("\n=== 給与情報 ===")
print(salaries)

# join() でインデックスをキーに結合
df_joined = employees.join(salaries)

print("\n=== join 後 ===")
print(df_joined)
```

**実行結果:**
```
=== 社員情報 ===
      名前
E001  田中
E002  佐藤
E003  鈴木

=== 給与情報 ===
        給与
E001  300000
E002  350000
E003  280000

=== join 後 ===
      名前      給与
E001  田中  300000
E002  佐藤  350000
E003  鈴木  280000
```

</details>

---

## 🎯 演習のまとめ

| 演習 | 学んだこと |
|------|-----------|
| 演習1-2 | index, columns, values の確認、set_index/reset_index |
| 演習3 | loc（ラベル）と iloc（位置）でのアクセス |
| 演習4-5 | マルチインデックスの作成とアクセス |
| 演習6-7 | concat() で縦/横方向連結 |
| 演習8-9 | merge() で内部結合/左外部結合 |
| 演習10 | join() でインデックス結合 |

---

## 🚀 次のステップ

応用問題で、実践的なデータ結合に挑戦しましょう！
