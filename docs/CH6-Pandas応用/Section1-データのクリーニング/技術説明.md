# Section1: データのクリーニング - 技術説明

## 🎯 このセクションで学ぶこと

実際のデータには「欠損値」「重複」「不正なデータ型」など様々な問題があります。
データ分析の前に、これらを処理して「きれいなデータ」を作る技術を学びます。

---

## 1. データクリーニングとは

### なぜデータクリーニングが必要か

```
【現実のデータの問題】

┌─────────────────────────────────────────────────────────┐
│  実際のデータには様々な「汚れ」が含まれている           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ① 欠損値（空欄、NaN）                                 │
│     → 回答漏れ、入力ミス、データ欠落                   │
│                                                         │
│  ② 重複データ                                          │
│     → 二重登録、データ連携ミス                         │
│                                                         │
│  ③ 不正なデータ型                                      │
│     → 数値が文字列として保存されている                 │
│                                                         │
│  ④ 表記ゆれ                                            │
│     → 「東京」「 東京」「東京 」「TOKYO」              │
│                                                         │
└─────────────────────────────────────────────────────────┘
              ↓
        データクリーニング
              ↓
┌─────────────────────────────────────────────────────────┐
│  きれいなデータ = 正確な分析が可能に！                  │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 欠損値の確認

### 欠損値とは

データがない状態を表す特殊な値です。Pandas では `NaN`（Not a Number）として表現されます。

```
【欠損値の表現】

    DataFrame
    ┌────────┬────────┬─────────┐
    │  名前  │  年齢  │  血液型 │
    ├────────┼────────┼─────────┤
  0 │  田中  │   25   │   A     │  ← 完全なデータ
    ├────────┼────────┼─────────┤
  1 │  佐藤  │  NaN   │   B     │  ← 年齢が欠損
    ├────────┼────────┼─────────┤
  2 │  鈴木  │   30   │  NaN    │  ← 血液型が欠損
    ├────────┼────────┼─────────┤
  3 │  NaN   │   28   │   O     │  ← 名前が欠損
    └────────┴────────┴─────────┘

    NaN = Not a Number（欠損値）
```

### 欠損値の確認メソッド

```python
import pandas as pd
import numpy as np

# 欠損値を含むデータ
df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", None],
    "年齢": [25, np.nan, 30, 28],
    "血液型": ["A", "B", np.nan, "O"]
})

print("=== 元のデータ ===")
print(df)
```

```
【欠損値確認メソッド一覧】

┌────────────────┬───────────────────────────────────────┐
│   メソッド     │   説明                                │
├────────────────┼───────────────────────────────────────┤
│ isnull()       │ 欠損値なら True を返す                │
│ isna()         │ isnull() と同じ（別名）               │
│ notnull()      │ 欠損値でなければ True を返す          │
│ notna()        │ notnull() と同じ（別名）              │
└────────────────┴───────────────────────────────────────┘
```

```python
# 各セルが欠損値かどうかを確認
print("=== isnull() の結果 ===")
print(df.isnull())

# 列ごとの欠損値の数をカウント
print("=== 列ごとの欠損値数 ===")
print(df.isnull().sum())

# 全体の欠損値数
print(f"全体の欠損値数: {df.isnull().sum().sum()}")
```

```
【isnull() の動作】

    DataFrame              isnull() の結果
    ┌────────┬────────┐    ┌────────┬────────┐
    │  名前  │  年齢  │    │  名前  │  年齢  │
    ├────────┼────────┤    ├────────┼────────┤
  0 │  田中  │   25   │    │ False  │ False  │
    ├────────┼────────┤    ├────────┼────────┤
  1 │  佐藤  │  NaN   │    │ False  │ True   │  ← NaN は True
    ├────────┼────────┤    ├────────┼────────┤
  2 │  鈴木  │   30   │    │ False  │ False  │
    ├────────┼────────┤    ├────────┼────────┤
  3 │  NaN   │   28   │    │ True   │ False  │  ← NaN は True
    └────────┴────────┘    └────────┴────────┘
```

---

## 3. 欠損値の削除（dropna）

### dropna() で欠損値を含む行・列を削除

```
【dropna() の動作】

    元のデータ                    dropna() 後
    ┌────────┬────────┬─────────┐    ┌────────┬────────┬─────────┐
    │  名前  │  年齢  │  血液型 │    │  名前  │  年齢  │  血液型 │
    ├────────┼────────┼─────────┤    ├────────┼────────┼─────────┤
  0 │  田中  │   25   │   A     │    │  田中  │   25   │   A     │ ← 残る
    ├────────┼────────┼─────────┤    └────────┴────────┴─────────┘
  1 │  佐藤  │  NaN   │   B     │  → 削除（NaN あり）
    ├────────┼────────┼─────────┤
  2 │  鈴木  │   30   │  NaN    │  → 削除（NaN あり）
    ├────────┼────────┼─────────┤
  3 │  NaN   │   28   │   O     │  → 削除（NaN あり）
    └────────┴────────┴─────────┘

    デフォルトでは1つでも NaN があれば行を削除
```

```python
import pandas as pd
import numpy as np

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", None],
    "年齢": [25, np.nan, 30, 28],
    "血液型": ["A", "B", np.nan, "O"]
})

# 欠損値を含む行を削除
df_cleaned = df.dropna()
print("=== dropna() 後 ===")
print(df_cleaned)
```

### dropna() の引数

```
【dropna() の引数】

┌────────────────┬─────────────────────────────────────────────┐
│   引数         │   説明                                      │
├────────────────┼─────────────────────────────────────────────┤
│ axis=0         │ 欠損値のある行を削除（デフォルト）          │
│ axis=1         │ 欠損値のある列を削除                        │
│ how="any"      │ 1つでも NaN があれば削除（デフォルト）      │
│ how="all"      │ すべてが NaN の場合のみ削除                 │
│ subset=[列名]  │ 特定の列の欠損値のみをチェック              │
│ thresh=n       │ n 個以上の非欠損値がある行/列を残す         │
└────────────────┴─────────────────────────────────────────────┘
```

```python
# 特定の列の欠損値だけをチェックして削除
df_subset = df.dropna(subset=["名前"])
print("=== 名前列の欠損のみ削除 ===")
print(df_subset)

# すべてが欠損の行のみ削除
df_all = df.dropna(how="all")
print("=== すべてが欠損の行のみ削除 ===")
print(df_all)
```

---

## 4. 欠損値の補完（fillna）

### fillna() で欠損値を別の値に置き換え

```
【fillna() の動作】

    元のデータ                 fillna(0) 後
    ┌────────┬────────┐       ┌────────┬────────┐
    │  商品  │  売上  │       │  商品  │  売上  │
    ├────────┼────────┤       ├────────┼────────┤
  0 │   A    │  100   │       │   A    │  100   │
    ├────────┼────────┤       ├────────┼────────┤
  1 │   B    │  NaN   │   →  │   B    │   0    │  ← 0 で補完
    ├────────┼────────┤       ├────────┼────────┤
  2 │   C    │  300   │       │   C    │  300   │
    ├────────┼────────┤       ├────────┼────────┤
  3 │   D    │  NaN   │   →  │   D    │   0    │  ← 0 で補完
    └────────┴────────┘       └────────┴────────┘
```

```python
import pandas as pd
import numpy as np

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D"],
    "売上": [100, np.nan, 300, np.nan],
    "評価": [4.5, 3.8, np.nan, 4.2]
})

print("=== 元のデータ ===")
print(df)

# 0 で補完
df_zero = df.fillna(0)
print("\n=== 0 で補完 ===")
print(df_zero)

# 平均値で補完
df_mean = df.fillna(df.mean(numeric_only=True))
print("\n=== 平均値で補完 ===")
print(df_mean)
```

### 列ごとに異なる値で補完

```python
# 列ごとに異なる値で補完
df_custom = df.fillna({"売上": 0, "評価": 3.0})
print("=== 列ごとに補完 ===")
print(df_custom)
```

```
【様々な補完方法】

┌────────────────────┬─────────────────────────────────────┐
│   方法             │   使い方                            │
├────────────────────┼─────────────────────────────────────┤
│ 固定値で補完       │ df.fillna(0)                        │
│ 平均値で補完       │ df.fillna(df.mean())                │
│ 中央値で補完       │ df.fillna(df.median())              │
│ 前の値で補完       │ df.fillna(method="ffill")           │
│ 後の値で補完       │ df.fillna(method="bfill")           │
│ 列ごとに補完       │ df.fillna({"列1": 値1, "列2": 値2}) │
└────────────────────┴─────────────────────────────────────┘
```

---

## 5. 重複データの処理

### 重複の確認（duplicated）

```
【重複の確認】

    DataFrame                duplicated() の結果
    ┌────────┬────────┐      ┌───────────┐
    │  名前  │  年齢  │      │  重複?    │
    ├────────┼────────┤      ├───────────┤
  0 │  田中  │   25   │      │  False    │  ← 最初に登場
    ├────────┼────────┤      ├───────────┤
  1 │  佐藤  │   30   │      │  False    │  ← 最初に登場
    ├────────┼────────┤      ├───────────┤
  2 │  田中  │   25   │      │  True     │  ← 重複！（0行目と同じ）
    ├────────┼────────┤      ├───────────┤
  3 │  鈴木  │   28   │      │  False    │  ← 最初に登場
    ├────────┼────────┤      ├───────────┤
  4 │  佐藤  │   30   │      │  True     │  ← 重複！（1行目と同じ）
    └────────┴────────┘      └───────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "田中", "鈴木", "佐藤"],
    "年齢": [25, 30, 25, 28, 30]
})

print("=== 元のデータ ===")
print(df)

# 重複をチェック
print("\n=== duplicated() の結果 ===")
print(df.duplicated())

# 重複行を表示
print("\n=== 重複している行 ===")
print(df[df.duplicated()])

# 重複の数をカウント
print(f"\n重複行数: {df.duplicated().sum()}")
```

### 重複の削除（drop_duplicates）

```python
# 重複を削除
df_unique = df.drop_duplicates()
print("=== 重複削除後 ===")
print(df_unique)

# 特定の列だけで重複を判定
df_name_unique = df.drop_duplicates(subset=["名前"])
print("\n=== 名前の重複を削除 ===")
print(df_name_unique)
```

```
【drop_duplicates() の引数】

┌─────────────────┬───────────────────────────────────────────┐
│   引数          │   説明                                    │
├─────────────────┼───────────────────────────────────────────┤
│ subset=[列名]   │ 特定の列のみで重複を判定                  │
│ keep="first"    │ 最初の行を残す（デフォルト）              │
│ keep="last"     │ 最後の行を残す                            │
│ keep=False      │ 重複行をすべて削除                        │
└─────────────────┴───────────────────────────────────────────┘
```

---

## 6. データ型の変換（astype）

### データ型の確認と変換

```
【データ型の問題】

    CSV から読み込んだデータ
    ┌────────┬──────────┬──────────┐
    │  商品  │  価格    │  数量    │
    ├────────┼──────────┼──────────┤
  0 │   A    │  "100"   │   10     │  ← 価格が文字列！
    ├────────┼──────────┼──────────┤
  1 │   B    │  "200"   │   20     │
    └────────┴──────────┴──────────┘

    dtype: 価格 → object（文字列）

    このままでは計算ができない！
    100 + 200 → "100200"（文字列連結）

              ↓ astype() で変換
    
    dtype: 価格 → int64（整数）
    100 + 200 → 300（正しい計算）
```

```python
import pandas as pd

# 価格が文字列のデータ
df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "価格": ["100", "200", "300"],  # 文字列
    "数量": [10, 20, 30]
})

print("=== データ型を確認 ===")
print(df.dtypes)

# 価格を整数に変換
df["価格"] = df["価格"].astype(int)

print("\n=== 変換後のデータ型 ===")
print(df.dtypes)

# 計算が可能に
df["売上"] = df["価格"] * df["数量"]
print("\n=== 売上を計算 ===")
print(df)
```

```
【主なデータ型】

┌──────────────┬───────────────────────────────────────┐
│   型         │   説明                                │
├──────────────┼───────────────────────────────────────┤
│ int64        │ 整数                                  │
│ float64      │ 小数                                  │
│ object       │ 文字列（str）                         │
│ bool         │ 真偽値（True/False）                  │
│ datetime64   │ 日付時刻                              │
│ category     │ カテゴリ（限られた値の集合）          │
└──────────────┴───────────────────────────────────────┘
```

---

## 7. 文字列の整形

### 表記ゆれの解消

```
【表記ゆれの問題】

    実際のデータ
    ┌─────────────┐
    │  都道府県   │
    ├─────────────┤
  0 │  東京      │  ← 正常
    ├─────────────┤
  1 │   東京     │  ← 前後に空白！
    ├─────────────┤
  2 │  東京 　   │  ← 後ろに空白！
    ├─────────────┤
  3 │  TOKYO    │  ← 大文字！
    └─────────────┘

    これらは別の値として扱われてしまう！
    value_counts() → 東京: 1, " 東京": 1, "東京 ": 1, "TOKYO": 1
```

### str アクセサで文字列を操作

```python
import pandas as pd

df = pd.DataFrame({
    "都道府県": ["東京", " 東京", "東京 ", "  大阪  ", "OSAKA"]
})

print("=== 元のデータ ===")
print(df)
print(df["都道府県"].value_counts())

# 空白を削除
df["都道府県"] = df["都道府県"].str.strip()

print("\n=== strip() 後 ===")
print(df)
print(df["都道府県"].value_counts())
```

```
【文字列メソッド一覧】

┌─────────────────┬───────────────────────────────────────┐
│   メソッド      │   説明                                │
├─────────────────┼───────────────────────────────────────┤
│ str.strip()     │ 前後の空白を削除                      │
│ str.lstrip()    │ 左側の空白を削除                      │
│ str.rstrip()    │ 右側の空白を削除                      │
│ str.lower()     │ 小文字に変換                          │
│ str.upper()     │ 大文字に変換                          │
│ str.replace()   │ 文字列を置換                          │
│ str.contains()  │ 部分文字列を含むかチェック            │
│ str.len()       │ 文字列の長さ                          │
└─────────────────┴───────────────────────────────────────┘
```

```python
# 様々な文字列操作
df = pd.DataFrame({
    "名前": ["TANAKA", "Sato", "SUZUKI"]
})

# 小文字に統一
df["名前_lower"] = df["名前"].str.lower()

# 大文字に統一
df["名前_upper"] = df["名前"].str.upper()

print(df)
```

---

## 8. 実践：データクリーニングの流れ

### 典型的なクリーニング手順

```
【データクリーニングの手順】

┌─────────────────────────────────────────────────┐
│ Step 1: データを読み込む                        │
│         df = pd.read_csv("data.csv")            │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 2: データの概要を確認                      │
│         df.info()  # データ型、欠損値           │
│         df.describe()  # 統計情報               │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 3: 欠損値を処理                            │
│         df.isnull().sum()  # 欠損値を確認       │
│         df = df.dropna() または fillna()        │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 4: 重複を処理                              │
│         df.duplicated().sum()  # 重複を確認     │
│         df = df.drop_duplicates()               │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 5: データ型を変換                          │
│         df["列名"] = df["列名"].astype(int)     │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 6: 文字列を整形                            │
│         df["列名"] = df["列名"].str.strip()     │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 7: クリーニング後のデータを確認            │
│         df.info()                               │
│         df.head()                               │
└─────────────────────────────────────────────────┘
```

```python
import pandas as pd
import numpy as np

# 汚いデータを作成
df = pd.DataFrame({
    "名前": ["田中", " 佐藤 ", "鈴木", "田中", None],
    "年齢": ["25", "30", np.nan, "25", "28"],
    "都市": ["東京", "OSAKA", "東京", "東京", "大阪"]
})

print("=== クリーニング前 ===")
print(df)
print(f"欠損値: {df.isnull().sum().sum()}, 重複: {df.duplicated().sum()}")

# クリーニング実行
df["名前"] = df["名前"].str.strip()      # 空白削除
df["都市"] = df["都市"].str.upper()      # 大文字に統一
df = df.dropna(subset=["名前"])          # 名前の欠損を削除
df["年齢"] = df["年齢"].fillna(0)        # 年齢の欠損を 0 で補完
df["年齢"] = df["年齢"].astype(int)      # 年齢を整数に変換
df = df.drop_duplicates()                 # 重複を削除

print("\n=== クリーニング後 ===")
print(df)
print(f"欠損値: {df.isnull().sum().sum()}, 重複: {df.duplicated().sum()}")
```

---

## ✅ このセクションで学んだこと

1. **欠損値の確認**: `isnull()`, `isna()`, `notnull()` で欠損値をチェック
2. **欠損値の削除**: `dropna()` で欠損値を含む行・列を削除
3. **欠損値の補完**: `fillna()` で欠損値を別の値に置換
4. **重複の処理**: `duplicated()` で確認、`drop_duplicates()` で削除
5. **データ型の変換**: `astype()` で型を変換
6. **文字列の整形**: `str.strip()`, `str.lower()`, `str.upper()` で統一

---

## 🔗 次のセクション

次は「Section2: データの変換と加工」で、
列の追加・削除、値の置換、apply() 関数などを学びます！
