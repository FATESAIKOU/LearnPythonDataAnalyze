# Section5: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®åŸºç¤ - æ¼”ç¿’

## æ¼”ç¿’1: datetime å‹ã¸ã®å¤‰æ›

### å•é¡Œ 1-1

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã€ã€Œæ—¥ä»˜ã€åˆ—ã‚’ datetime å‹ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": ["2024-01-15", "2024-02-20", "2024-03-10"],
    "å£²ä¸Š": [10000, 12000, 15000]
})
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
æ—¥ä»˜åˆ—ã®å‹: datetime64[ns]
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": ["2024-01-15", "2024-02-20", "2024-03-10"],
    "å£²ä¸Š": [10000, 12000, 15000]
})

print("=== å¤‰æ›å‰ ===")
print(f"æ—¥ä»˜åˆ—ã®å‹: {df['æ—¥ä»˜'].dtype}")

# datetime å‹ã«å¤‰æ›
df["æ—¥ä»˜"] = pd.to_datetime(df["æ—¥ä»˜"])

print("\n=== å¤‰æ›å¾Œ ===")
print(f"æ—¥ä»˜åˆ—ã®å‹: {df['æ—¥ä»˜'].dtype}")
print(df)
```

</details>

---

### å•é¡Œ 1-2

ä»¥ä¸‹ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã®æ—¥ä»˜ã‚’ datetime å‹ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": ["2024/01/15", "2024/02/20", "2024/03/10"],
    "å£²ä¸Š": [10000, 12000, 15000]
})
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": ["2024/01/15", "2024/02/20", "2024/03/10"],
    "å£²ä¸Š": [10000, 12000, 15000]
})

# pd.to_datetime ã¯æ§˜ã€…ãªå½¢å¼ã‚’è‡ªå‹•èªè­˜
df["æ—¥ä»˜"] = pd.to_datetime(df["æ—¥ä»˜"])

print("=== å¤‰æ›å¾Œ ===")
print(df)
print(f"æ—¥ä»˜åˆ—ã®å‹: {df['æ—¥ä»˜'].dtype}")
```

</details>

---

## æ¼”ç¿’2: dt ã‚¢ã‚¯ã‚»ã‚µã§è¦ç´ ã‚’æŠ½å‡º

### å•é¡Œ 2-1

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«ã€Œå¹´ã€ã€Œæœˆã€ã€Œæ—¥ã€ã®åˆ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
        æ—¥ä»˜     å£²ä¸Š    å¹´   æœˆ   æ—¥
0 2024-01-15  10000  2024   1  15
1 2024-02-20  12000  2024   2  20
2 2024-03-10  15000  2024   3  10
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•ï¼ˆfor ãƒ«ãƒ¼ãƒ—ï¼‰:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})

# for ãƒ«ãƒ¼ãƒ—ã§å„è¦ç´ ã‚’æŠ½å‡º
years = []
months = []
days = []

for date in df["æ—¥ä»˜"]:
    years.append(date.year)
    months.append(date.month)
    days.append(date.day)

df["å¹´"] = years
df["æœˆ"] = months
df["æ—¥"] = days

print(df)
```

**ç™ºå±•è§£æ³•ï¼ˆdt ã‚¢ã‚¯ã‚»ã‚µï¼‰:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})

# dt ã‚¢ã‚¯ã‚»ã‚µã§ä¸€æ‹¬æŠ½å‡º
df["å¹´"] = df["æ—¥ä»˜"].dt.year
df["æœˆ"] = df["æ—¥ä»˜"].dt.month
df["æ—¥"] = df["æ—¥ä»˜"].dt.day

print(df)
```

</details>

---

### å•é¡Œ 2-2

å•é¡Œ 2-1 ã®ãƒ‡ãƒ¼ã‚¿ã«ã€Œæ›œæ—¥ã€ï¼ˆ0=æœˆæ›œã€6=æ—¥æ›œï¼‰ã®åˆ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

**æœŸå¾…ã™ã‚‹çµæœ:**
```
        æ—¥ä»˜     å£²ä¸Š  æ›œæ—¥
0 2024-01-15  10000     0
1 2024-02-20  12000     1
2 2024-03-10  15000     6
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})

# for ãƒ«ãƒ¼ãƒ—ã§æ›œæ—¥ã‚’æŠ½å‡º
weekdays = []
for date in df["æ—¥ä»˜"]:
    weekdays.append(date.weekday())

df["æ›œæ—¥"] = weekdays
print(df)
```

**ç™ºå±•è§£æ³•ï¼ˆdt ã‚¢ã‚¯ã‚»ã‚µï¼‰:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})

# dt.weekday ã§æ›œæ—¥ã‚’å–å¾—
df["æ›œæ—¥"] = df["æ—¥ä»˜"].dt.weekday

print(df)
```

</details>

---

## æ¼”ç¿’3: æ—¥ä»˜ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

### å•é¡Œ 3-1

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€2024å¹´2æœˆä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10", "2024-04-05"]),
    "å£²ä¸Š": [10000, 12000, 15000, 18000]
})
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
        æ—¥ä»˜     å£²ä¸Š
1 2024-02-20  12000
2 2024-03-10  15000
3 2024-04-05  18000
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10", "2024-04-05"]),
    "å£²ä¸Š": [10000, 12000, 15000, 18000]
})

# for ãƒ«ãƒ¼ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
result_indices = []
for i in range(len(df)):
    if df["æ—¥ä»˜"].iloc[i].month >= 2:
        result_indices.append(i)

result = df.iloc[result_indices]
print(result)
```

**ç™ºå±•è§£æ³•ï¼ˆæ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ï¼‰:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10", "2024-04-05"]),
    "å£²ä¸Š": [10000, 12000, 15000, 18000]
})

# æ—¥ä»˜æ–‡å­—åˆ—ã§æ¯”è¼ƒ
result = df[df["æ—¥ä»˜"] >= "2024-02-01"]
print(result)
```

</details>

---

### å•é¡Œ 3-2

å•é¡Œ 3-1 ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€3æœˆã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

**æœŸå¾…ã™ã‚‹çµæœ:**
```
        æ—¥ä»˜     å£²ä¸Š
2 2024-03-10  15000
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10", "2024-04-05"]),
    "å£²ä¸Š": [10000, 12000, 15000, 18000]
})

# for ãƒ«ãƒ¼ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
result_data = []
for i in range(len(df)):
    if df["æ—¥ä»˜"].iloc[i].month == 3:
        result_data.append(df.iloc[i])

result = pd.DataFrame(result_data)
print(result)
```

**ç™ºå±•è§£æ³•ï¼ˆdt.monthï¼‰:**
```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10", "2024-04-05"]),
    "å£²ä¸Š": [10000, 12000, 15000, 18000]
})

# dt.month ã§æœˆã‚’æ¯”è¼ƒ
result = df[df["æ—¥ä»˜"].dt.month == 3]
print(result)
```

</details>

---

## æ¼”ç¿’4: DatetimeIndex

### å•é¡Œ 4-1

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã§ã€æ—¥ä»˜ã‚’ index ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
              å£²ä¸Š
æ—¥ä»˜              
2024-01-15  10000
2024-02-20  12000
2024-03-10  15000
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})

print("=== è¨­å®šå‰ ===")
print(df)
print(f"index: {df.index.tolist()}")

# æ—¥ä»˜ã‚’ index ã«è¨­å®š
df = df.set_index("æ—¥ä»˜")

print("\n=== è¨­å®šå¾Œ ===")
print(df)
print(f"index: {df.index.tolist()}")
```

</details>

---

### å•é¡Œ 4-2

DatetimeIndex ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã§ã€`.loc` ã‚’ä½¿ã£ã¦ 2024å¹´2æœˆ20æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})
df = df.set_index("æ—¥ä»˜")
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
å£²ä¸Š    12000
Name: 2024-02-20 00:00:00, dtype: int64
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

```python
import pandas as pd

df = pd.DataFrame({
    "æ—¥ä»˜": pd.to_datetime(["2024-01-15", "2024-02-20", "2024-03-10"]),
    "å£²ä¸Š": [10000, 12000, 15000]
})
df = df.set_index("æ—¥ä»˜")

# æ—¥ä»˜æ–‡å­—åˆ—ã§ loc ã‚¢ã‚¯ã‚»ã‚¹
result = df.loc["2024-02-20"]
print(result)
```

</details>

---

## æ¼”ç¿’5: resample

### å•é¡Œ 5-1

ä»¥ä¸‹ã®æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ã€æœˆæ¬¡ã®**åˆè¨ˆ**ã«é›†è¨ˆã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=60, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100 + i for i in range(60)]
}, index=dates)
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
æœˆæ¬¡ã®å£²ä¸Šåˆè¨ˆ
              å£²ä¸Š
2024-01-31   2635
2024-02-29   3655
2024-03-31    545
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=60, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100 + i for i in range(60)]
}, index=dates)

# æœˆã”ã¨ã«é›†è¨ˆ
monthly_totals = {}
for date, row in df.iterrows():
    month_key = f"{date.year}-{date.month:02d}"
    if month_key not in monthly_totals:
        monthly_totals[month_key] = 0
    monthly_totals[month_key] = monthly_totals[month_key] + row["å£²ä¸Š"]

print("æœˆæ¬¡å£²ä¸Šåˆè¨ˆ:")
for month, total in monthly_totals.items():
    print(f"{month}: {total}")
```

**ç™ºå±•è§£æ³•ï¼ˆresampleï¼‰:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=60, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100 + i for i in range(60)]
}, index=dates)

# resample ã§æœˆæ¬¡é›†è¨ˆ
monthly = df.resample("ME").sum()
print("æœˆæ¬¡ã®å£²ä¸Šåˆè¨ˆ")
print(monthly)
```

</details>

---

### å•é¡Œ 5-2

å•é¡Œ 5-1 ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€é€±æ¬¡ã®**å¹³å‡**ã«é›†è¨ˆã—ã¦ãã ã•ã„ã€‚

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=60, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100 + i for i in range(60)]
}, index=dates)

# é€±ã”ã¨ã«é›†è¨ˆï¼ˆç°¡ç•¥åŒ–ï¼‰
print("é€±æ¬¡å£²ä¸Šå¹³å‡ï¼ˆæ‰‹å‹•è¨ˆç®—ã¯è¤‡é›‘ãªãŸã‚çœç•¥ï¼‰")
print("resample ã‚’ä½¿ã†ã®ãŒåŠ¹ç‡çš„ã§ã™")
```

**ç™ºå±•è§£æ³•ï¼ˆresampleï¼‰:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=60, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100 + i for i in range(60)]
}, index=dates)

# resample ã§é€±æ¬¡å¹³å‡
weekly = df.resample("W").mean()
print("é€±æ¬¡ã®å£²ä¸Šå¹³å‡")
print(weekly.head(10))
```

</details>

---

## æ¼”ç¿’6: rollingï¼ˆç§»å‹•å¹³å‡ï¼‰

### å•é¡Œ 6-1

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«ã€Œ3æ—¥ç§»å‹•å¹³å‡ã€ã®åˆ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=7, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100, 120, 110, 130, 140, 125, 150]
}, index=dates)
```

**æœŸå¾…ã™ã‚‹çµæœ:**
```
            å£²ä¸Š  3æ—¥ç§»å‹•å¹³å‡
2024-01-01   100         NaN
2024-01-02   120         NaN
2024-01-03   110      110.00
2024-01-04   130      120.00
2024-01-05   140      126.67
2024-01-06   125      131.67
2024-01-07   150      138.33
```

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=7, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100, 120, 110, 130, 140, 125, 150]
}, index=dates)

# for ãƒ«ãƒ¼ãƒ—ã§ç§»å‹•å¹³å‡ã‚’è¨ˆç®—
moving_avg = []
for i in range(len(df)):
    if i < 2:  # æœ€åˆã®2ã¤ã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³
        moving_avg.append(float('nan'))
    else:
        # éå»3æ—¥åˆ†ã®å¹³å‡
        total = df["å£²ä¸Š"].iloc[i-2] + df["å£²ä¸Š"].iloc[i-1] + df["å£²ä¸Š"].iloc[i]
        avg = total / 3
        moving_avg.append(avg)

df["3æ—¥ç§»å‹•å¹³å‡"] = moving_avg
print(df)
```

**ç™ºå±•è§£æ³•ï¼ˆrollingï¼‰:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=7, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100, 120, 110, 130, 140, 125, 150]
}, index=dates)

# rolling ã§3æ—¥ç§»å‹•å¹³å‡
df["3æ—¥ç§»å‹•å¹³å‡"] = df["å£²ä¸Š"].rolling(3).mean()
print(df)
```

</details>

---

### å•é¡Œ 6-2

å•é¡Œ 6-1 ã®ãƒ‡ãƒ¼ã‚¿ã«ã€Œ3æ—¥ç§»å‹•åˆè¨ˆã€ã®åˆ—ã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

<details>
<summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>

**åŸºæœ¬è§£æ³•:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=7, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100, 120, 110, 130, 140, 125, 150]
}, index=dates)

# for ãƒ«ãƒ¼ãƒ—ã§ç§»å‹•åˆè¨ˆã‚’è¨ˆç®—
moving_sum = []
for i in range(len(df)):
    if i < 2:
        moving_sum.append(float('nan'))
    else:
        total = df["å£²ä¸Š"].iloc[i-2] + df["å£²ä¸Š"].iloc[i-1] + df["å£²ä¸Š"].iloc[i]
        moving_sum.append(total)

df["3æ—¥ç§»å‹•åˆè¨ˆ"] = moving_sum
print(df)
```

**ç™ºå±•è§£æ³•ï¼ˆrollingï¼‰:**
```python
import pandas as pd

dates = pd.date_range("2024-01-01", periods=7, freq="D")
df = pd.DataFrame({
    "å£²ä¸Š": [100, 120, 110, 130, 140, 125, 150]
}, index=dates)

# rolling ã§3æ—¥ç§»å‹•å¹³å‡ã¨ç§»å‹•åˆè¨ˆ
df["3æ—¥ç§»å‹•å¹³å‡"] = df["å£²ä¸Š"].rolling(3).mean()
df["3æ—¥ç§»å‹•åˆè¨ˆ"] = df["å£²ä¸Š"].rolling(3).sum()
print(df)
```

</details>

---

## ğŸ‰ æ¼”ç¿’å®Œäº†ï¼

ã™ã¹ã¦ã®å•é¡ŒãŒè§£ã‘ãŸã‚‰ã€ã€Œå¿œç”¨å•é¡Œã€ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼
