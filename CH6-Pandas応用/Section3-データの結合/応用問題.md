# Section3: データの結合 - 応用問題

## 🎯 応用問題の目的

インデックスの概念を活用しながら、実務に近いシナリオでデータ結合を実践します。
基本解法（ステップごとの結合）と発展解法（効率的な方法）の両方を学びます。

---

## 応用問題1: インデックスを活用したデータ管理

社員データを社員ID でインデックス化し、効率的にデータにアクセス・結合してください。

```python
import pandas as pd

# 社員基本情報
employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "名前": ["田中太郎", "佐藤花子", "鈴木一郎", "高橋美咲"],
    "部署": ["営業", "開発", "営業", "開発"]
})

# 評価データ
evaluations = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "評価点": [85, 92, 78, 88]
})

# 給与データ
salaries = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "基本給": [250000, 300000, 230000, 280000]
})

print("=== 社員基本情報 ===")
print(employees)

# TODO: 以下を実現してください
# 1. 社員ID をインデックスに設定した3つの DataFrame を作成
# 2. join() を使って3つを結合
# 3. 開発部署の社員だけを loc で抽出
# 4. 特定の社員（E002）の全情報を表示
```

<details>
<summary>解答例を見る</summary>

### 基本解法（ステップバイステップ）

```python
import pandas as pd

# 社員基本情報
employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "名前": ["田中太郎", "佐藤花子", "鈴木一郎", "高橋美咲"],
    "部署": ["営業", "開発", "営業", "開発"]
})

# 評価データ
evaluations = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "評価点": [85, 92, 78, 88]
})

# 給与データ
salaries = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "基本給": [250000, 300000, 230000, 280000]
})

# Step 1: 社員ID をインデックスに設定
emp_indexed = employees.set_index("社員ID")
eval_indexed = evaluations.set_index("社員ID")
sal_indexed = salaries.set_index("社員ID")

print("=== インデックス設定後（社員情報）===")
print(emp_indexed)

# Step 2: join() で結合（インデックスをキーに）
df = emp_indexed.join(eval_indexed)
print("\n=== Step 2: 評価を追加 ===")
print(df)

df = df.join(sal_indexed)
print("\n=== Step 2: 給与も追加 ===")
print(df)

# Step 3: 開発部署の社員を抽出
print("\n=== 開発部署の社員 ===")
for idx in df.index:
    if df.loc[idx, "部署"] == "開発":
        print(f"{idx}: {df.loc[idx, '名前']}")

# Step 4: 特定社員（E002）の全情報
print("\n=== E002 の全情報 ===")
print(df.loc["E002"])
```

### 発展解法（メソッドチェーン）

```python
import pandas as pd

# 社員基本情報
employees = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "名前": ["田中太郎", "佐藤花子", "鈴木一郎", "高橋美咲"],
    "部署": ["営業", "開発", "営業", "開発"]
})

# 評価データ
evaluations = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "評価点": [85, 92, 78, 88]
})

# 給与データ
salaries = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004"],
    "基本給": [250000, 300000, 230000, 280000]
})

# インデックス設定 + 結合を一気に
df = (employees.set_index("社員ID")
      .join(evaluations.set_index("社員ID"))
      .join(salaries.set_index("社員ID")))

print("=== 結合後の全データ ===")
print(df)

# 開発部署の社員
print("\n=== 開発部署の社員 ===")
print(df[df["部署"] == "開発"])

# 特定社員の情報
print("\n=== E002 の全情報 ===")
print(df.loc["E002"])

# ボーナス計算（評価点 × 1000）
df["ボーナス"] = df["評価点"] * 1000
print("\n=== ボーナス追加後 ===")
print(df)
```

**実行結果:**
```
=== 結合後の全データ ===
          名前  部署  評価点    基本給
社員ID                              
E001  田中太郎  営業     85  250000
E002  佐藤花子  開発     92  300000
E003  鈴木一郎  営業     78  230000
E004  高橋美咲  開発     88  280000

=== 開発部署の社員 ===
          名前  部署  評価点    基本給
社員ID                              
E002  佐藤花子  開発     92  300000
E004  高橋美咲  開発     88  280000

=== E002 の全情報 ===
名前      佐藤花子
部署        開発
評価点        92
基本給    300000
Name: E002, dtype: object

=== ボーナス追加後 ===
          名前  部署  評価点    基本給  ボーナス
社員ID                                    
E001  田中太郎  営業     85  250000   85000
E002  佐藤花子  開発     92  300000   92000
E003  鈴木一郎  営業     78  230000   78000
E004  高橋美咲  開発     88  280000   88000
```

</details>

---

## 応用問題2: マルチインデックスでのグループ管理

部署と年度でグループ化された売上データを、マルチインデックスで管理してください。

```python
import pandas as pd

# 売上データ
sales = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "営業", "開発", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2024, 2023, 2023, 2024, 2024],
    "四半期": ["Q1", "Q2", "Q1", "Q2", "Q1", "Q2", "Q1", "Q2"],
    "売上": [100, 120, 110, 130, 80, 90, 95, 100]
})

print("=== 売上データ ===")
print(sales)

# TODO: 以下を実現してください
# 1. 部署と年度でマルチインデックスを設定
# 2. 営業部署の全データを表示
# 3. 営業部署の2024年データを表示
# 4. 各グループ（部署・年度）の売上合計を計算
```

<details>
<summary>解答例を見る</summary>

### 基本解法（ステップバイステップ）

```python
import pandas as pd

# 売上データ
sales = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "営業", "開発", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2024, 2023, 2023, 2024, 2024],
    "四半期": ["Q1", "Q2", "Q1", "Q2", "Q1", "Q2", "Q1", "Q2"],
    "売上": [100, 120, 110, 130, 80, 90, 95, 100]
})

print("=== 元のデータ ===")
print(sales)

# Step 1: マルチインデックスを設定
df_multi = sales.set_index(["部署", "年度"])
print("\n=== マルチインデックス設定後 ===")
print(df_multi)

# Step 2: 営業部署の全データ
print("\n=== 営業部署の全データ ===")
print(df_multi.loc["営業"])

# Step 3: 営業部署の2024年データ（タプルで指定）
print("\n=== 営業部署の2024年データ ===")
print(df_multi.loc[("営業", 2024)])

# Step 4: グループごとの売上合計（手動計算）
print("\n=== グループごとの売上合計 ===")
groups = [("営業", 2023), ("営業", 2024), ("開発", 2023), ("開発", 2024)]
for group in groups:
    total = 0
    for i in range(len(sales)):
        if sales.iloc[i]["部署"] == group[0] and sales.iloc[i]["年度"] == group[1]:
            total = total + sales.iloc[i]["売上"]
    print(f"{group[0]} {group[1]}年: {total}")
```

### 発展解法（groupby を使用）

```python
import pandas as pd

# 売上データ
sales = pd.DataFrame({
    "部署": ["営業", "営業", "営業", "営業", "開発", "開発", "開発", "開発"],
    "年度": [2023, 2023, 2024, 2024, 2023, 2023, 2024, 2024],
    "四半期": ["Q1", "Q2", "Q1", "Q2", "Q1", "Q2", "Q1", "Q2"],
    "売上": [100, 120, 110, 130, 80, 90, 95, 100]
})

# マルチインデックス設定
df_multi = sales.set_index(["部署", "年度"])
print("=== マルチインデックス ===")
print(df_multi)

# 営業部署の全データ
print("\n=== 営業部署 ===")
print(df_multi.loc["営業"])

# 営業部署の2024年
print("\n=== 営業部署 2024年 ===")
print(df_multi.loc[("営業", 2024)])

# groupby で集計（結果もマルチインデックスになる）
print("\n=== 部署・年度別 売上合計 ===")
summary = sales.groupby(["部署", "年度"])["売上"].sum()
print(summary)

# マルチインデックスを解除
print("\n=== reset_index 後 ===")
print(summary.reset_index())
```

**実行結果:**
```
=== マルチインデックス ===
          四半期   売上
部署 年度              
営業 2023    Q1   100
     2023    Q2   120
     2024    Q1   110
     2024    Q2   130
開発 2023    Q1    80
     2023    Q2    90
     2024    Q1    95
     2024    Q2   100

=== 営業部署 ===
     四半期   売上
年度              
2023    Q1   100
2023    Q2   120
2024    Q1   110
2024    Q2   130

=== 営業部署 2024年 ===
     四半期   売上
年度              
2024    Q1   110
2024    Q2   130

=== 部署・年度別 売上合計 ===
部署  年度
営業  2023    220
      2024    240
開発  2023    170
      2024    195
Name: 売上, dtype: int64

=== reset_index 後 ===
   部署    年度   売上
0  営業  2023   220
1  営業  2024   240
2  開発  2023   170
3  開発  2024   195
```

</details>

---

## 応用問題3: ECサイトの売上分析（総合）

複数のテーブルを結合し、インデックスを活用して売上分析を行ってください。

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "order_id": [1, 2, 3, 4, 5, 6],
    "customer_id": ["C001", "C002", "C001", "C003", "C002", "C001"],
    "product_id": ["P001", "P002", "P003", "P001", "P004", "P002"],
    "quantity": [2, 1, 3, 1, 2, 4],
    "order_date": ["2024-01-10", "2024-01-11", "2024-01-12", 
                   "2024-01-12", "2024-01-13", "2024-01-14"]
})

# 顧客マスタ
customers = pd.DataFrame({
    "customer_id": ["C001", "C002", "C003", "C004"],
    "customer_name": ["田中商店", "佐藤電機", "鈴木工業", "高橋食品"],
    "region": ["東京", "大阪", "名古屋", "福岡"]
})

# 商品マスタ
products = pd.DataFrame({
    "product_id": ["P001", "P002", "P003", "P004"],
    "product_name": ["ノートPC", "マウス", "キーボード", "モニター"],
    "category": ["PC本体", "周辺機器", "周辺機器", "周辺機器"],
    "price": [80000, 3000, 5000, 25000]
})

print("=== 注文データ ===")
print(orders)

# TODO: 以下を実現してください
# 1. 3つのテーブルを結合
# 2. order_id をインデックスに設定
# 3. 売上金額（quantity × price）を計算
# 4. 特定の注文（order_id=3）の詳細を表示
# 5. 顧客別の合計売上を計算
# 6. カテゴリ別の合計売上を計算
```

<details>
<summary>解答例を見る</summary>

### 基本解法（ステップバイステップ）

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "order_id": [1, 2, 3, 4, 5, 6],
    "customer_id": ["C001", "C002", "C001", "C003", "C002", "C001"],
    "product_id": ["P001", "P002", "P003", "P001", "P004", "P002"],
    "quantity": [2, 1, 3, 1, 2, 4],
    "order_date": ["2024-01-10", "2024-01-11", "2024-01-12", 
                   "2024-01-12", "2024-01-13", "2024-01-14"]
})

# 顧客マスタ
customers = pd.DataFrame({
    "customer_id": ["C001", "C002", "C003", "C004"],
    "customer_name": ["田中商店", "佐藤電機", "鈴木工業", "高橋食品"],
    "region": ["東京", "大阪", "名古屋", "福岡"]
})

# 商品マスタ
products = pd.DataFrame({
    "product_id": ["P001", "P002", "P003", "P004"],
    "product_name": ["ノートPC", "マウス", "キーボード", "モニター"],
    "category": ["PC本体", "周辺機器", "周辺機器", "周辺機器"],
    "price": [80000, 3000, 5000, 25000]
})

# Step 1: テーブル結合
df = pd.merge(orders, customers, on="customer_id")
df = pd.merge(df, products, on="product_id")
print("=== Step 1: 結合後 ===")
print(df)

# Step 2: order_id をインデックスに
df = df.set_index("order_id")
print("\n=== Step 2: インデックス設定 ===")
print(df)

# Step 3: 売上金額を計算
df["sales"] = df["quantity"] * df["price"]
print("\n=== Step 3: 売上計算 ===")
print(df)

# Step 4: 特定の注文（order_id=3）の詳細
print("\n=== 注文ID 3 の詳細 ===")
print(df.loc[3])

# Step 5: 顧客別の合計売上（手動計算）
print("\n=== 顧客別合計売上 ===")
customer_sales = {}
for idx in df.index:
    name = df.loc[idx, "customer_name"]
    sale = df.loc[idx, "sales"]
    if name in customer_sales:
        customer_sales[name] = customer_sales[name] + sale
    else:
        customer_sales[name] = sale

for name, total in customer_sales.items():
    print(f"{name}: {total:,}円")

# Step 6: カテゴリ別の合計売上（手動計算）
print("\n=== カテゴリ別合計売上 ===")
category_sales = {}
for idx in df.index:
    cat = df.loc[idx, "category"]
    sale = df.loc[idx, "sales"]
    if cat in category_sales:
        category_sales[cat] = category_sales[cat] + sale
    else:
        category_sales[cat] = sale

for cat, total in category_sales.items():
    print(f"{cat}: {total:,}円")
```

### 発展解法（groupby を使用）

```python
import pandas as pd

# 注文データ
orders = pd.DataFrame({
    "order_id": [1, 2, 3, 4, 5, 6],
    "customer_id": ["C001", "C002", "C001", "C003", "C002", "C001"],
    "product_id": ["P001", "P002", "P003", "P001", "P004", "P002"],
    "quantity": [2, 1, 3, 1, 2, 4],
    "order_date": ["2024-01-10", "2024-01-11", "2024-01-12", 
                   "2024-01-12", "2024-01-13", "2024-01-14"]
})

# 顧客マスタ
customers = pd.DataFrame({
    "customer_id": ["C001", "C002", "C003", "C004"],
    "customer_name": ["田中商店", "佐藤電機", "鈴木工業", "高橋食品"],
    "region": ["東京", "大阪", "名古屋", "福岡"]
})

# 商品マスタ
products = pd.DataFrame({
    "product_id": ["P001", "P002", "P003", "P004"],
    "product_name": ["ノートPC", "マウス", "キーボード", "モニター"],
    "category": ["PC本体", "周辺機器", "周辺機器", "周辺機器"],
    "price": [80000, 3000, 5000, 25000]
})

# 結合 + インデックス設定 + 売上計算
df = (orders
      .merge(customers, on="customer_id")
      .merge(products, on="product_id")
      .set_index("order_id"))

df["sales"] = df["quantity"] * df["price"]

print("=== 完成したデータ ===")
print(df[["customer_name", "product_name", "quantity", "price", "sales"]])

# 特定の注文を loc でアクセス
print("\n=== 注文ID 3 の詳細 ===")
print(df.loc[3])

# 顧客別合計（groupby → 結果はインデックス付き）
print("\n=== 顧客別合計売上 ===")
customer_summary = df.groupby("customer_name")["sales"].sum()
print(customer_summary.sort_values(ascending=False))

# カテゴリ別合計
print("\n=== カテゴリ別合計売上 ===")
category_summary = df.groupby("category")["sales"].sum()
print(category_summary.sort_values(ascending=False))

# 地域別合計
print("\n=== 地域別合計売上 ===")
region_summary = df.groupby("region")["sales"].sum()
print(region_summary.sort_values(ascending=False))
```

**実行結果:**
```
=== 完成したデータ ===
         customer_name product_name  quantity  price   sales
order_id                                                     
1             田中商店     ノートPC         2  80000  160000
2             佐藤電機       マウス         1   3000    3000
3             田中商店   キーボード         3   5000   15000
4             鈴木工業     ノートPC         1  80000   80000
5             佐藤電機     モニター         2  25000   50000
6             田中商店       マウス         4   3000   12000

=== 注文ID 3 の詳細 ===
customer_id          C001
product_id           P003
quantity                3
order_date     2024-01-12
customer_name      田中商店
region               東京
product_name     キーボード
category           周辺機器
price              5000
sales             15000
Name: 3, dtype: object

=== 顧客別合計売上 ===
customer_name
田中商店    187000
鈴木工業     80000
佐藤電機     53000
Name: sales, dtype: int64

=== カテゴリ別合計売上 ===
category
PC本体      240000
周辺機器     80000
Name: sales, dtype: int64

=== 地域別合計売上 ===
region
東京      187000
名古屋     80000
大阪       53000
Name: sales, dtype: int64
```

</details>

---

## 🎯 応用問題のまとめ

| 問題 | 学んだこと |
|------|-----------|
| 問題1 | インデックス設定 + join() での結合、loc でのアクセス |
| 問題2 | マルチインデックスの作成とアクセス、groupby との関係 |
| 問題3 | 複数テーブルの結合、インデックスを活用した分析 |

---

## 💡 実務でのポイント

1. **インデックスの活用**: ユニークな ID 列をインデックスにすると、loc でのアクセスが高速
2. **マルチインデックス**: 階層的なデータ構造を表現、groupby の結果として自動生成される
3. **merge vs join**: 
   - merge() → 列の値でマッチング（一般的）
   - join() → インデックスでマッチング（事前にインデックス設定が必要）
4. **reset_index()**: マルチインデックスを通常の列に戻したい時に使用

---

## 🚀 次のセクション

次は「Section4: グループ化と集計」で、
groupby による集計（マルチインデックスを生成）を学びます！
