# CH6: Pandas 応用 - 学習の動機づけ

## 🎯 なぜ Pandas の応用を学ぶのか？

実際のデータは「きれい」ではありません。
欠損値があったり、複数のファイルに分かれていたり、集計が必要だったり...

Pandas の応用を学ぶことで、**実務で必要な「データを整える」スキル** が身につきます。
Excel のピボットテーブルのような集計も、より柔軟にできるようになります。

```
┌─────────────────────────────────────────────────────────────────┐
│               Pandas 応用を学ぶ目的                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🧹 データクリーニング    →  欠損値・重複を処理して整える      │
│                                                                 │
│   🔗 データ結合            →  複数ファイルを1つに統合できる     │
│                                                                 │
│   📊 グループ集計          →  ピボットテーブルと同等の分析      │
│                                                                 │
│   📅 時系列データ処理      →  日付ごとの集計・分析ができる      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔑 この章を学ぶための前提条件

```
┌─────────────────────────────────────────────────────────────────┐
│                      学習の前提条件                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 条件 1: CH5 の内容を理解している                            │
│     ─────────────────────────────────────────────────           │
│     • DataFrame の作成と基本操作ができる                        │
│     • CSV/Excel の読み書きができる                              │
│     • loc/iloc でデータを選択できる                             │
│     • 条件によるフィルタリングができる                          │
│                                                                 │
│  ✅ 条件 2: Excel のピボットテーブルを見たことがある            │
│     ─────────────────────────────────────────────────           │
│     • 「行」「列」「値」を設定して集計する概念がわかる          │
│     • または SUMIF, COUNTIF などの関数を使ったことがある        │
│                                                                 │
│  ✅ 条件 3: 「汚いデータ」に悩んだ経験がある                    │
│     ─────────────────────────────────────────────────           │
│     • 空白セルがあってうまく計算できなかった                    │
│     • 複数のファイルを手動で結合した経験がある                  │
│     • データの整形に時間がかかった経験がある                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 この章を学ぶと何が変わるのか？（As-Is / To-Be 比較）

### 変化1: 欠損値の処理が簡単にできる

**シナリオ**: 売上データに空白（欠損値）があり、集計できない

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 As-Is: Excel の場合                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   元データ:                                                             │
│   ┌───────┬───────┬───────┐                                             │
│   │ 日付  │ 支店  │ 売上  │                                             │
│   ├───────┼───────┼───────┤                                             │
│   │ 1/1   │ 東京  │  120  │                                             │
│   │ 1/2   │ 大阪  │ (空白)│  ← 空白があると SUM がエラーになることも    │
│   │ 1/3   │ 東京  │  180  │                                             │
│   │ 1/4   │(空白) │  150  │  ← 支店が空白だと集計できない               │
│   └───────┴───────┴───────┘                                             │
│                                                                         │
│   対処法:                                                               │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │  ① 空白セルを目視で探す                                       │    │
│   │  ② Ctrl+G → [セル選択] → [空白セル] で選択                    │    │
│   │  ③ 削除するか、値を入力して補完                               │    │
│   │  ④ 大量にあると手作業では限界...                              │    │
│   └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   😰 問題点:                                                            │
│   • 目視での確認は見落としが発生しやすい                                │
│   • 大量データでは手作業での対応が困難                                  │
│   • 毎回同じ作業を繰り返す必要がある                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  🐍 To-Be: Pandas の場合                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  # 欠損値の確認                                                 │   │
│   │  print(df.isnull().sum())                                       │   │
│   │  # 支店    1                                                    │   │
│   │  # 売上    1                                                    │   │
│   │                                                                 │   │
│   │  # 欠損値のある行を削除                                         │   │
│   │  df_clean = df.dropna()                                         │   │
│   │                                                                 │   │
│   │  # または欠損値を特定の値で補完                                 │   │
│   │  df["売上"] = df["売上"].fillna(0)           # 0で補完          │   │
│   │  df["支店"] = df["支店"].fillna("不明")      # "不明"で補完     │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   😊 利点:                                                              │
│   • 欠損値の数を一瞬で確認できる                                        │
│   • 削除も補完も1行で完了                                               │
│   • 何万行あっても同じコードで処理可能                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 変化2: 複数ファイルの結合が簡単にできる

**シナリオ**: 売上データと商品マスタを結合して、商品名を表示したい

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 As-Is: Excel の場合                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   売上データ:               商品マスタ:                                 │
│   ┌───────┬───────┐         ┌───────┬────────┐                          │
│   │商品ID │ 売上  │         │商品ID │ 商品名 │                          │
│   ├───────┼───────┤         ├───────┼────────┤                          │
│   │  A001 │  120  │         │  A001 │ りんご │                          │
│   │  B002 │   85  │         │  B002 │ みかん │                          │
│   │  A001 │  200  │         │  C003 │ バナナ │                          │
│   └───────┴───────┘         └───────┴────────┘                          │
│                                                                         │
│   対処法: VLOOKUP を使う                                                │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │  =VLOOKUP(A2, 商品マスタ!$A$2:$B$10, 2, FALSE)                 │    │
│   └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   😰 問題点:                                                            │
│   • 全行に式をコピーする必要がある                                      │
│   • 参照範囲を手動で設定しなければならない                              │
│   • 商品マスタが別ファイルだと参照が複雑になる                          │
│   • #N/A エラーの処理が必要                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  🐍 To-Be: Pandas の場合                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  # 2つのデータを読み込む                                        │   │
│   │  sales = pd.read_csv("sales.csv")                               │   │
│   │  products = pd.read_csv("products.csv")                         │   │
│   │                                                                 │   │
│   │  # 商品IDをキーに結合（VLOOKUP と同じ効果）                     │   │
│   │  merged = pd.merge(sales, products, on="商品ID")                │   │
│   │                                                                 │   │
│   │  print(merged)                                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   結果:                                                                 │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │   商品ID    売上    商品名                                      │   │
│   │    A001     120    りんご    ← 自動で結合された！               │   │
│   │    B002      85    みかん                                       │   │
│   │    A001     200    りんご                                       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   😊 利点:                                                              │
│   • 1行で結合完了（VLOOKUP のコピー不要）                               │
│   • 別ファイルでも簡単に結合                                            │
│   • 結合方法も柔軟に指定可能（内部結合、外部結合など）                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 変化3: ピボットテーブルがコードで作れる

**シナリオ**: 支店別・月別の売上集計表を作成したい

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 As-Is: Excel の場合                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   手順:                                                                 │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │  ① データ範囲を選択                                           │    │
│   │  ② [挿入] → [ピボットテーブル]                                │    │
│   │  ③ 「行」に「支店」をドラッグ                                 │    │
│   │  ④ 「列」に「月」をドラッグ                                   │    │
│   │  ⑤ 「値」に「売上」をドラッグ                                 │    │
│   │  ⑥ 集計方法を「合計」に設定                                   │    │
│   │  ⑦ 書式設定で見た目を調整                                     │    │
│   └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   結果:                                                                 │
│   ┌─────────┬───────┬───────┬───────┬───────┐                           │
│   │ 支店＼月│  1月  │  2月  │  3月  │ 合計  │                           │
│   ├─────────┼───────┼───────┼───────┼───────┤                           │
│   │ 東京    │  450  │  520  │  480  │ 1450  │                           │
│   │ 大阪    │  380  │  410  │  390  │ 1180  │                           │
│   │ 名古屋  │  290  │  320  │  310  │  920  │                           │
│   └─────────┴───────┴───────┴───────┴───────┘                           │
│                                                                         │
│   😰 問題点:                                                            │
│   • 毎回 GUI で操作が必要                                               │
│   • データが更新されたら作り直し or 更新操作が必要                      │
│   • 設定を再現するには同じ手順を踏む必要がある                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│  🐍 To-Be: Pandas の場合                                                  │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌────────────────────────────────────────────────────────────────────┐  │
│   │  # ピボットテーブルを作成                                          │  │
│   │  pivot = pd.pivot_table(                                           │  │
│   │      df,                                                           │  │
│   │      values="売上",        # 集計する値                            │  │
│   │      index="支店",         # 行（Excel の「行」フィールド）        │  │
│   │      columns="月",         # 列（Excel の「列」フィールド）        │  │
│   │      aggfunc="sum"         # 集計方法                              │  │
│   │  )                                                                 │  │
│   │                                                                    │  │
│   │  print(pivot)                                                      │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│   結果:                                                                   │
│   ┌────────────────────────────────────────────────────────────────────┐  │
│   │  月      1月    2月    3月                                         │  │
│   │  支店                                                              │  │
│   │  大阪    380    410    390                                         │  │
│   │  名古屋  290    320    310                                         │  │
│   │  東京    450    520    480                                         │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│   さらに groupby を使えば:                                                │
│   ┌────────────────────────────────────────────────────────────────────┐  │
│   │  # 支店ごとの合計・平均・件数を一度に計算                          │  │
│   │  summary = df.groupby("支店")["売上"].agg(["sum", "mean", "count"])│  │
│   └────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│   😊 利点:                                                                │
│   • コードで再現可能（同じ集計を何度でも実行）                            │
│   • 複数の集計を同時に計算できる                                          │
│   • データが更新されてもコードを再実行するだけ                            │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 📚 この章で学ぶ内容

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       CH6 の学習内容                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Section 1: データのクリーニング                                        │
│  ────────────────────────────                                           │
│  • 欠損値と重複を処理してデータを整える                                 │
│                                                                         │
│      Before:                      After:                                │
│      ┌───────┬───────┐            ┌───────┬───────┐                     │
│      │ 支店  │ 売上  │            │ 支店  │ 売上  │                     │
│      ├───────┼───────┤            ├───────┼───────┤                     │
│      │ 東京  │  120  │            │ 東京  │  120  │                     │
│      │ (NaN) │   85  │  ─────→   │ 不明  │   85  │ ← 補完               │
│      │ 東京  │ (NaN) │            │ 東京  │  120  │ ← 削除 or 補完      │
│      │ 東京  │  120  │ (重複)     └───────┴───────┘ ← 重複削除          │
│      └───────┴───────┘                                                  │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Section 2-3: データの変換と結合                                        │
│  ────────────────────────────                                           │
│  • 列の追加・加工・複数データの統合                                     │
│                                                                         │
│      ┌─────────┐   ┌─────────┐         ┌─────────────────┐              │
│      │ 売上    │ + │ 商品    │  ────→  │ 売上 + 商品名   │              │
│      │ データ  │   │ マスタ  │  merge  │ 統合データ      │              │
│      └─────────┘   └─────────┘         └─────────────────┘              │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Section 4: グループ化と集計                                            │
│  ────────────────────────────                                           │
│  • Excel のピボットテーブルと同等の機能                                 │
│                                                                         │
│      元データ:                    集計結果:                             │
│      ┌───────┬───────┐            ┌───────┬───────┬───────┐             │
│      │ 支店  │ 売上  │            │ 支店  │  合計 │  平均 │             │
│      ├───────┼───────┤  groupby   ├───────┼───────┼───────┤             │
│      │ 東京  │  120  │  ───────→  │ 東京  │  500  │  166  │             │
│      │ 大阪  │   85  │            │ 大阪  │  265  │  132  │             │
│      │ 東京  │  200  │            └───────┴───────┴───────┘             │
│      │ 大阪  │  180  │                                                  │
│      │ 東京  │  180  │                                                  │
│      └───────┴───────┘                                                  │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Section 5: 時系列データの基礎                                          │
│  ────────────────────────────                                           │
│  • 日付データの処理と時間軸での集計                                     │
│                                                                         │
│      日次データ:                    月次集計:                           │
│      ┌───────────┬───────┐          ┌───────┬───────┐                   │
│      │   日付    │ 売上  │          │  月   │ 売上  │                   │
│      ├───────────┼───────┤ resample ├───────┼───────┤                   │
│      │ 2024-01-01│  120  │ ──────→  │ 1月   │ 1050  │                   │
│      │ 2024-01-02│  150  │          │ 2月   │ 1180  │                   │
│      │    ...    │  ...  │          │ 3月   │  980  │                   │
│      └───────────┴───────┘          └───────┴───────┘                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🏁 この章のゴール

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        CH6 修了時の姿                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  # この章を修了すると、このコードが「書ける」ようになります     │   │
│   │                                                                 │   │
│   │  import pandas as pd                                            │   │
│   │                                                                 │   │
│   │  # 1. データ読み込み                                            │   │
│   │  sales = pd.read_csv("sales.csv")                               │   │
│   │  products = pd.read_csv("products.csv")                         │   │
│   │                                                                 │   │
│   │  # 2. データクリーニング                                        │   │
│   │  sales = sales.dropna()                   # 欠損値削除          │   │
│   │  sales = sales.drop_duplicates()          # 重複削除            │   │
│   │                                                                 │   │
│   │  # 3. データ結合                                                │   │
│   │  df = pd.merge(sales, products, on="商品ID")                    │   │
│   │                                                                 │   │
│   │  # 4. 日付列を datetime 型に変換                                │   │
│   │  df["日付"] = pd.to_datetime(df["日付"])                        │   │
│   │  df["月"] = df["日付"].dt.month                                 │   │
│   │                                                                 │   │
│   │  # 5. 支店別・月別の売上集計                                    │   │
│   │  summary = df.groupby(["支店", "月"])["売上"].agg(              │   │
│   │      ["sum", "mean", "count"]                                   │   │
│   │  ).round(0)                                                     │   │
│   │                                                                 │   │
│   │  # 6. 結果を保存                                                │   │
│   │  summary.to_csv("monthly_report.csv")                           │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   処理の流れ:                                                           │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                 │   │
│   │  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐ │   │
│   │  │ 読込み │ → │クリーン│ → │  結合  │ → │  集計  │ → │  保存  │ │   │
│   │  └────────┘   └────────┘   └────────┘   └────────┘   └────────┘ │   │
│   │                                                                 │   │
│   │  これが実務のデータ分析ワークフロー！                           │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   💡 クリーニング → 結合 → 集計 → 保存、これが実務の基本パターン！      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 💪 さあ、始めましょう！

実際のデータ分析では、「きれいなデータ」は存在しません。
この章で学ぶ「データを整える」スキルは、最も実務で役立つ技術です。

ここまでマスターすれば、次の章でグラフ作成を学び、
最終章で総合的なデータ分析プロジェクトに挑戦する準備が整います！

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│     🚀 次のステップ: ch-overview.md で章の全体像を確認！        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
