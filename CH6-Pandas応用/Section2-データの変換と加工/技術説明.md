# Section2: データの変換と加工 - 技術説明

## 🎯 このセクションで学ぶこと

データ分析では、生データをそのまま使うことは稀です。
新しい列を追加したり、値を変換したりして、分析しやすい形に加工する技術を学びます。

---

## 1. 列の追加と削除

### 新しい列の追加

```
【新しい列の追加】

    元の DataFrame              列を追加
    ┌────────┬────────┐         ┌────────┬────────┬────────┐
    │  数量  │  単価  │         │  数量  │  単価  │  売上  │
    ├────────┼────────┤         ├────────┼────────┼────────┤
  0 │   10   │  100   │    →    │   10   │  100   │  1000  │
    ├────────┼────────┤         ├────────┼────────┼────────┤
  1 │    5   │  200   │         │    5   │  200   │  1000  │
    ├────────┼────────┤         ├────────┼────────┼────────┤
  2 │    8   │  150   │         │    8   │  150   │  1200  │
    └────────┴────────┘         └────────┴────────┴────────┘

    df["売上"] = df["数量"] * df["単価"]
```

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "数量": [10, 5, 8],
    "単価": [100, 200, 150]
})

print("=== 元のデータ ===")
print(df)

# 新しい列を追加（計算結果）
df["売上"] = df["数量"] * df["単価"]

# 固定値の列を追加
df["店舗"] = "東京"

print("\n=== 列を追加後 ===")
print(df)
```

### 列の削除（drop）

```
【列の削除】

    元の DataFrame                  列を削除
    ┌────────┬────────┬────────┐    ┌────────┬────────┐
    │  商品  │  数量  │  備考  │    │  商品  │  数量  │
    ├────────┼────────┼────────┤    ├────────┼────────┤
  0 │   A    │   10   │  ---   │ →  │   A    │   10   │
    ├────────┼────────┼────────┤    ├────────┼────────┤
  1 │   B    │    5   │  ---   │    │   B    │    5   │
    └────────┴────────┴────────┘    └────────┴────────┘

    df = df.drop(columns=["備考"])
```

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "数量": [10, 5, 8],
    "備考": ["---", "---", "---"]
})

# 列を削除
df = df.drop(columns=["備考"])
print(df)

# 複数列を削除
# df = df.drop(columns=["列1", "列2"])
```

```
【drop() の引数】

┌─────────────────────┬─────────────────────────────────────┐
│   使い方            │   説明                              │
├─────────────────────┼─────────────────────────────────────┤
│ drop(columns=[...]) │ 指定した列を削除                    │
│ drop(index=[...])   │ 指定した行（インデックス）を削除    │
│ drop(..., axis=1)   │ 列方向の操作（columns と同じ）      │
│ drop(..., axis=0)   │ 行方向の操作（index と同じ）        │
└─────────────────────┴─────────────────────────────────────┘
```

---

## 2. 値の置換（replace）

### replace() で値を置き換え

```
【replace() の動作】

    元の DataFrame               replace() 後
    ┌────────┬────────────┐     ┌────────┬────────────┐
    │  商品  │ ステータス │     │  商品  │ ステータス │
    ├────────┼────────────┤     ├────────┼────────────┤
  0 │   A    │     1      │  →  │   A    │  販売中    │
    ├────────┼────────────┤     ├────────┼────────────┤
  1 │   B    │     0      │     │   B    │  販売停止  │
    ├────────┼────────────┤     ├────────┼────────────┤
  2 │   C    │     1      │     │   C    │  販売中    │
    └────────┴────────────┘     └────────┴────────────┘

    df["ステータス"] = df["ステータス"].replace({1: "販売中", 0: "販売停止"})
```

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C", "D"],
    "ステータス": [1, 0, 1, 0]
})

print("=== 元のデータ ===")
print(df)

# 値を置換（辞書形式）
df["ステータス"] = df["ステータス"].replace({1: "販売中", 0: "販売停止"})

print("\n=== 置換後 ===")
print(df)
```

### map() で値を変換

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["りんご", "みかん", "バナナ"],
    "カテゴリ": ["果物", "果物", "果物"]
})

# カテゴリコードを追加
category_map = {"果物": "F", "野菜": "V", "飲料": "D"}
df["カテゴリコード"] = df["カテゴリ"].map(category_map)

print(df)
```

```
【replace() と map() の違い】

┌─────────────────┬─────────────────────────────────────────┐
│   メソッド      │   特徴                                  │
├─────────────────┼─────────────────────────────────────────┤
│ replace()       │ 一部の値だけを置換（マッチしないものは  │
│                 │ そのまま残る）                          │
├─────────────────┼─────────────────────────────────────────┤
│ map()           │ すべての値を変換（マッチしないものは    │
│                 │ NaN になる）                            │
└─────────────────┴─────────────────────────────────────────┘
```

---

## 3. apply() で関数を適用

### apply() の基本的な使い方

`apply()` は、Series や DataFrame の各要素に関数を適用するメソッドです。

```
【apply() の基本動作】

    ┌─────────────────────────────────────────────────────────────┐
    │  Series.apply(関数)                                         │
    │                                                             │
    │  Series の各要素に対して、指定した関数を順番に適用する      │
    └─────────────────────────────────────────────────────────────┘

    入力 Series              関数を適用               出力 Series
    ┌────────┐                                       ┌────────┐
    │  価格  │                                       │  結果  │
    ├────────┤              ┌──────────┐             ├────────┤
  0 │  1000  │  ─────────→  │  func()  │  ────────→  │  1100  │
    ├────────┤              └──────────┘             ├────────┤
  1 │  2000  │  ─────────→  │  func()  │  ────────→  │  2200  │
    ├────────┤              └──────────┘             ├────────┤
  2 │  1500  │  ─────────→  │  func()  │  ────────→  │  1650  │
    └────────┘              └──────────┘             └────────┘

    各要素が1つずつ関数に渡され、結果が新しい Series として返される
```

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "価格": [1000, 2000, 1500]
})

print("=== 元のデータ ===")
print(df)

# Step 1: 関数を定義
def add_tax(price):
    """価格に10%の税を加算する"""
    return int(price * 1.1)

# Step 2: apply() で関数を適用
df["税込価格"] = df["価格"].apply(add_tax)

print("\n=== apply() 適用後 ===")
print(df)
```

**実行結果:**
```
=== 元のデータ ===
  商品    価格
0    A   1000
1    B   2000
2    C   1500

=== apply() 適用後 ===
  商品    価格  税込価格
0    A   1000      1100
1    B   2000      2200
2    C   1500      1650
```

### lambda（ラムダ式）を使った apply()

短い処理の場合、`lambda`（無名関数）を使うと1行で書けます。

```
【lambda（ラムダ式）とは】

┌─────────────────────────────────────────────────────────────────┐
│  通常の関数定義                                                 │
│                                                                 │
│      def add_tax(price):                                        │
│          return int(price * 1.1)                                │
│                                                                 │
│      df["価格"].apply(add_tax)                                  │
├─────────────────────────────────────────────────────────────────┤
│  ラムダ式（同じ処理を1行で）                                    │
│                                                                 │
│      df["価格"].apply(lambda price: int(price * 1.1))           │
│                                                                 │
│      ┌────────────────────────────────────────┐                 │
│      │  lambda  引数  :  戻り値の計算式       │                 │
│      └────────────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "価格": [1000, 2000, 1500]
})

# ラムダ式で税込価格を計算
df["税込価格"] = df["価格"].apply(lambda x: int(x * 1.1))

# ラムダ式で条件分岐（三項演算子）
df["価格帯"] = df["価格"].apply(lambda x: "高額" if x >= 1500 else "通常")

print(df)
```

**実行結果:**
```
  商品    価格  税込価格 価格帯
0    A   1000      1100   通常
1    B   2000      2200   高額
2    C   1500      1650   高額
```

### apply() の2つの方向（axis）

DataFrame に対する `apply()` には、**列方向（axis=0）** と **行方向（axis=1）** の2つの適用方向があります。

```
【apply() の axis パラメータ】

┌─────────────────────────────────────────────────────────────────┐
│  axis=0（デフォルト）: 列ごとに関数を適用                       │
│                                                                 │
│      DataFrame                    結果                          │
│      ┌───────┬───────┬───────┐                                  │
│      │  数量 │  単価 │  在庫 │                                  │
│      ├───────┼───────┼───────┤                                  │
│    0 │  10   │  100  │  50   │                                  │
│      ├───────┼───────┼───────┤                                  │
│    1 │   5   │  200  │  30   │                                  │
│      ├───────┼───────┼───────┤                                  │
│    2 │   8   │  150  │  20   │                                  │
│      └───────┴───────┴───────┘                                  │
│          ↓       ↓       ↓      各「列」を Series として        │
│        func   func   func       関数に渡す                      │
│          ↓       ↓       ↓                                      │
│      ┌───────┬───────┬───────┐                                  │
│      │  23   │  450  │  100  │  ← 例: sum() の結果              │
│      └───────┴───────┴───────┘                                  │
│                                                                 │
│      df.apply(sum, axis=0)  # 各列の合計                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  axis=1: 行ごとに関数を適用                                     │
│                                                                 │
│      DataFrame                              結果                │
│      ┌───────┬───────┬───────┐          ┌───────┐               │
│      │  数量 │  単価 │  在庫 │          │  売上 │               │
│      ├───────┼───────┼───────┤          ├───────┤               │
│    0 │  10   │  100  │  50   │ → func → │  1000 │               │
│      ├───────┼───────┼───────┤          ├───────┤               │
│    1 │   5   │  200  │  30   │ → func → │  1000 │               │
│      ├───────┼───────┼───────┤          ├───────┤               │
│    2 │   8   │  150  │  20   │ → func → │  1200 │               │
│      └───────┴───────┴───────┘          └───────┘               │
│                                                                 │
│      各「行」を Series として関数に渡す                         │
│      row["数量"], row["単価"] のようにアクセス可能              │
│                                                                 │
│      df.apply(lambda row: row["数量"] * row["単価"], axis=1)    │
└─────────────────────────────────────────────────────────────────┘
```

#### axis=0（列方向）の例

```python
import pandas as pd

df = pd.DataFrame({
    "数量": [10, 5, 8],
    "単価": [100, 200, 150],
    "在庫": [50, 30, 20]
})

print("=== 元のデータ ===")
print(df)

# axis=0: 各列に対して sum を適用
col_sums = df.apply(sum, axis=0)
print("\n=== 列ごとの合計（axis=0）===")
print(col_sums)
```

**実行結果:**
```
=== 元のデータ ===
   数量  単価  在庫
0    10   100    50
1     5   200    30
2     8   150    20

=== 列ごとの合計（axis=0）===
数量     23
単価    450
在庫    100
dtype: int64
```

#### axis=1（行方向）の例

```python
import pandas as pd

df = pd.DataFrame({
    "商品": ["A", "B", "C"],
    "数量": [10, 5, 8],
    "単価": [100, 200, 150]
})

print("=== 元のデータ ===")
print(df)

# axis=1: 各行に対して関数を適用
# row は各行の Series（数量、単価などにアクセス可能）
def calc_sales(row):
    return row["数量"] * row["単価"]

df["売上"] = df.apply(calc_sales, axis=1)

print("\n=== 売上を追加（axis=1）===")
print(df)

# ラムダ式でも書ける
# df["売上"] = df.apply(lambda row: row["数量"] * row["単価"], axis=1)
```

**実行結果:**
```
=== 元のデータ ===
  商品  数量  単価
0    A    10   100
1    B     5   200
2    C     8   150

=== 売上を追加（axis=1）===
  商品  数量  単価    売上
0    A    10   100   1000
1    B     5   200   1000
2    C     8   150   1200
```

```
【apply() の使い分けまとめ】

┌───────────────────┬─────────────────────────────────────────┐
│   用途            │   使い方                                │
├───────────────────┼─────────────────────────────────────────┤
│ 1列の各要素を変換 │ df["列"].apply(func)                    │
│                   │ 例: 税込価格計算、カテゴリ分類          │
├───────────────────┼─────────────────────────────────────────┤
│ 各列を集計        │ df.apply(func, axis=0)                  │
│                   │ 例: 各列の合計、平均、最大値            │
├───────────────────┼─────────────────────────────────────────┤
│ 複数列を使った    │ df.apply(func, axis=1)                  │
│ 行ごとの計算      │ 例: 数量×単価、複数条件の判定           │
└───────────────────┴─────────────────────────────────────────┘
```

---

## 4. カテゴリ変換（cut, qcut）

### cut() で数値を区間に分割

```
【cut() の動作】

     連続値             カテゴリに変換
    ┌────────┐         ┌──────────┐
    │  年齢  │         │  年代    │
    ├────────┤         ├──────────┤
  0 │   18   │    →    │  10代    │
    ├────────┤         ├──────────┤
  1 │   25   │    →    │  20代    │
    ├────────┤         ├──────────┤
  2 │   35   │    →    │  30代    │
    ├────────┤         ├──────────┤
  3 │   42   │    →    │  40代    │
    └────────┘         └──────────┘

    bins = [0, 20, 30, 40, 50, 100]
    labels = ["10代", "20代", "30代", "40代", "50代以上"]
    pd.cut(df["年齢"], bins=bins, labels=labels)
```

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "年齢": [18, 25, 35, 42, 58]
})

# 年齢を年代に変換
bins = [0, 20, 30, 40, 50, 100]
labels = ["10代", "20代", "30代", "40代", "50代以上"]

df["年代"] = pd.cut(df["年齢"], bins=bins, labels=labels)

print(df)
```

### qcut() で均等分割

```python
import pandas as pd

df = pd.DataFrame({
    "顧客": ["A", "B", "C", "D", "E", "F"],
    "購入金額": [1000, 3000, 5000, 8000, 12000, 20000]
})

# 4分位で分割
df["ランク"] = pd.qcut(df["購入金額"], q=4, labels=["Bronze", "Silver", "Gold", "Platinum"])

print(df)
```

```
【cut() と qcut() の違い】

cut():  指定した境界値で分割
        → 各区間のデータ数はバラバラ

        例: bins=[0, 1000, 5000, 10000]
            0-1000, 1000-5000, 5000-10000

qcut(): データ数が均等になるように分割
        → 各区間のデータ数がほぼ同じ

        例: q=4
            下位25%, 25-50%, 50-75%, 上位25%
```

---

## 5. 列名・インデックス名の変更（rename）

### rename() で名前を変更

```
【rename() の動作】

    元の列名                    変更後の列名
    ┌────────┬────────┐        ┌──────────┬──────────┐
    │  name  │  age   │   →    │  名前    │  年齢    │
    ├────────┼────────┤        ├──────────┼──────────┤
    │  田中  │   25   │        │  田中    │    25    │
    └────────┴────────┘        └──────────┴──────────┘

    df = df.rename(columns={"name": "名前", "age": "年齢"})
```

```python
import pandas as pd

df = pd.DataFrame({
    "name": ["田中", "佐藤"],
    "age": [25, 30],
    "city": ["東京", "大阪"]
})

print("=== 元のデータ ===")
print(df)

# 列名を変更
df = df.rename(columns={
    "name": "名前",
    "age": "年齢",
    "city": "都市"
})

print("\n=== 列名変更後 ===")
print(df)
```

### すべての列名を一括変更

```python
import pandas as pd

df = pd.DataFrame({
    "A": [1, 2],
    "B": [3, 4]
})

# すべての列名を変更
df.columns = ["列1", "列2"]

print(df)
```

---

## 6. 文字列メソッド（str アクセサ）

### str アクセサで文字列操作

```
【str アクセサ】

    文字列の列に対して、文字列メソッドを適用できる

    df["列名"].str.メソッド名()

    ┌─────────────────────────────────────────────┐
    │  Series                                     │
    │  ┌──────────────┐                           │
    │  │  "TANAKA"    │   .str.lower()            │
    │  │  "SATO"      │   → "tanaka", "sato"      │
    │  │  "SUZUKI"    │                           │
    │  └──────────────┘                           │
    └─────────────────────────────────────────────┘
```

```python
import pandas as pd

df = pd.DataFrame({
    "名前": ["田中 太郎", "佐藤 花子", "鈴木 一郎"],
    "メール": ["TANAKA@example.com", "sato@TEST.com", "Suzuki@Mail.JP"]
})

print("=== 元のデータ ===")
print(df)

# メールを小文字に統一
df["メール_lower"] = df["メール"].str.lower()

# 名前を姓と名に分割
df["姓"] = df["名前"].str.split(" ").str[0]
df["名"] = df["名前"].str.split(" ").str[1]

print("\n=== 加工後 ===")
print(df)
```

```
【よく使う str メソッド】

┌────────────────────┬─────────────────────────────────────┐
│   メソッド         │   説明                              │
├────────────────────┼─────────────────────────────────────┤
│ str.lower()        │ 小文字に変換                        │
│ str.upper()        │ 大文字に変換                        │
│ str.strip()        │ 前後の空白を削除                    │
│ str.replace(a, b)  │ 文字列 a を b に置換                │
│ str.contains(s)    │ 文字列 s を含むか（True/False）     │
│ str.split(sep)     │ sep で分割してリストを返す          │
│ str.len()          │ 文字列の長さ                        │
│ str[n]             │ n番目の文字を取得                   │
│ str[:n]            │ 先頭からn文字を取得                 │
└────────────────────┴─────────────────────────────────────┘
```

---

## 7. 実践：データ変換の流れ

### 典型的なデータ変換の例

```python
import pandas as pd

# 元データ
df = pd.DataFrame({
    "order_id": ["ORD001", "ORD002", "ORD003"],
    "product_name": ["  りんご  ", "MIKAN", "banana"],
    "quantity": [10, 5, 8],
    "unit_price": [100, 150, 80],
    "status": [1, 0, 1]
})

print("=== 変換前 ===")
print(df)

# ===== データ変換 =====

# 1. 列名を日本語に
df = df.rename(columns={
    "order_id": "注文ID",
    "product_name": "商品名",
    "quantity": "数量",
    "unit_price": "単価",
    "status": "ステータス"
})

# 2. 商品名を整形（空白削除、小文字統一）
df["商品名"] = df["商品名"].str.strip().str.lower()

# 3. ステータスを日本語に変換
df["ステータス"] = df["ステータス"].replace({1: "完了", 0: "処理中"})

# 4. 売上列を追加
df["売上"] = df["数量"] * df["単価"]

# 5. 売上ランクを追加
df["売上ランク"] = df["売上"].apply(lambda x: "高" if x >= 800 else "中" if x >= 500 else "低")

print("\n=== 変換後 ===")
print(df)
```

```
【データ変換のポイント】

┌─────────────────────────────────────────────────────────┐
│ 1. まず列名を分かりやすく（rename）                     │
│                                                         │
│ 2. 文字列データを整形（str アクセサ）                   │
│                                                         │
│ 3. コードを意味のある値に変換（replace, map）           │
│                                                         │
│ 4. 必要な計算列を追加（列の追加）                       │
│                                                         │
│ 5. カテゴリ変数を作成（cut, apply）                     │
│                                                         │
│ 6. 不要な列を削除（drop）                               │
└─────────────────────────────────────────────────────────┘
```

---

## ✅ このセクションで学んだこと

1. **列の追加・削除**: `df["新列"] = ...`、`df.drop(columns=[...])`
2. **値の置換**: `replace()` で部分置換、`map()` で全体変換
3. **関数の適用**: `apply()` でカスタム処理を実行
4. **カテゴリ変換**: `cut()` で区間分割、`qcut()` で均等分割
5. **列名変更**: `rename()` で列名・インデックス名を変更
6. **文字列操作**: `str` アクセサで文字列メソッドを適用

---

## 🔗 次のセクション

次は「Section3: データの結合」で、
複数のデータを統合する concat、merge、join を学びます！
