# Section5: データのフィルタリング - 応用問題

## 🎯 この応用問題の目的

実際のビジネスシナリオを想定し、
複雑な条件でデータを抽出・分析する能力を養います。

---

## 🚀 応用問題1: 売上データの分析

### 問題

以下の売上データから、様々な条件でデータを抽出し、分析してください。

```python
import pandas as pd

df = pd.DataFrame({
    "日付": ["2024-01-01", "2024-01-01", "2024-01-02", "2024-01-02", 
             "2024-01-03", "2024-01-03", "2024-01-04", "2024-01-04"],
    "店舗": ["東京", "大阪", "東京", "大阪", "東京", "大阪", "東京", "大阪"],
    "商品": ["A", "B", "A", "A", "B", "B", "A", "B"],
    "数量": [10, 5, 8, 12, 7, 9, 15, 6],
    "単価": [100, 200, 100, 100, 200, 200, 100, 200],
    "売上": [1000, 1000, 800, 1200, 1400, 1800, 1500, 1200]
})
```

1. 東京店舗の売上データのみを抽出
2. 売上が 1000 以上 1500 以下のデータを抽出
3. 東京店舗で商品Aの売上データを抽出
4. 数量が 10 以上 または 売上が 1500 以上のデータを抽出
5. 抽出したデータの売上合計を計算

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

df = pd.DataFrame({
    "日付": ["2024-01-01", "2024-01-01", "2024-01-02", "2024-01-02", 
             "2024-01-03", "2024-01-03", "2024-01-04", "2024-01-04"],
    "店舗": ["東京", "大阪", "東京", "大阪", "東京", "大阪", "東京", "大阪"],
    "商品": ["A", "B", "A", "A", "B", "B", "A", "B"],
    "数量": [10, 5, 8, 12, 7, 9, 15, 6],
    "単価": [100, 200, 100, 100, 200, 200, 100, 200],
    "売上": [1000, 1000, 800, 1200, 1400, 1800, 1500, 1200]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 東京店舗の売上データのみを抽出 =====

# 基本解法：ループで条件に合う行を収集
tokyo_data = []
for i in range(len(df)):
    if df.iloc[i]["店舗"] == "東京":
        tokyo_data.append(df.iloc[i])

result1 = pd.DataFrame(tokyo_data)

print("=== 1. 東京店舗のデータ ===")
print(result1)
print()

# ===== 2. 売上が 1000 以上 1500 以下のデータを抽出 =====

# 基本解法：ループで範囲をチェック
range_data = []
for i in range(len(df)):
    sales = df.iloc[i]["売上"]
    if sales >= 1000 and sales <= 1500:
        range_data.append(df.iloc[i])

result2 = pd.DataFrame(range_data)

print("=== 2. 売上 1000〜1500 ===")
print(result2)
print()

# ===== 3. 東京店舗で商品Aの売上データを抽出 =====

# 基本解法：複数条件をループでチェック
tokyo_a_data = []
for i in range(len(df)):
    if df.iloc[i]["店舗"] == "東京" and df.iloc[i]["商品"] == "A":
        tokyo_a_data.append(df.iloc[i])

result3 = pd.DataFrame(tokyo_a_data)

print("=== 3. 東京店舗の商品A ===")
print(result3)
print()

# ===== 4. 数量が 10 以上 または 売上が 1500 以上 =====

# 基本解法：OR条件をループでチェック
or_data = []
for i in range(len(df)):
    if df.iloc[i]["数量"] >= 10 or df.iloc[i]["売上"] >= 1500:
        or_data.append(df.iloc[i])

result4 = pd.DataFrame(or_data)

print("=== 4. 数量 >= 10 または 売上 >= 1500 ===")
print(result4)
print()

# ===== 5. 抽出したデータの売上合計を計算 =====

# 基本解法：ループで合計
total_sales = 0
for i in range(len(result4)):
    total_sales = total_sales + result4.iloc[i]["売上"]

print("=== 5. 売上合計 ===")
print(f"条件4のデータの売上合計: {total_sales:,}円")
```

**実行結果:**
```
=== 元の DataFrame ===
          日付  店舗 商品  数量  単価    売上
0  2024-01-01  東京    A    10   100  1000
1  2024-01-01  大阪    B     5   200  1000
2  2024-01-02  東京    A     8   100   800
3  2024-01-02  大阪    A    12   100  1200
4  2024-01-03  東京    B     7   200  1400
5  2024-01-03  大阪    B     9   200  1800
6  2024-01-04  東京    A    15   100  1500
7  2024-01-04  大阪    B     6   200  1200

=== 1. 東京店舗のデータ ===
          日付  店舗 商品  数量  単価    売上
0  2024-01-01  東京    A    10   100  1000
2  2024-01-02  東京    A     8   100   800
4  2024-01-03  東京    B     7   200  1400
6  2024-01-04  東京    A    15   100  1500

=== 2. 売上 1000〜1500 ===
          日付  店舗 商品  数量  単価    売上
0  2024-01-01  東京    A    10   100  1000
1  2024-01-01  大阪    B     5   200  1000
3  2024-01-02  大阪    A    12   100  1200
4  2024-01-03  東京    B     7   200  1400
6  2024-01-04  東京    A    15   100  1500
7  2024-01-04  大阪    B     6   200  1200

=== 3. 東京店舗の商品A ===
          日付  店舗 商品  数量  単価    売上
0  2024-01-01  東京    A    10   100  1000
2  2024-01-02  東京    A     8   100   800
6  2024-01-04  東京    A    15   100  1500

=== 4. 数量 >= 10 または 売上 >= 1500 ===
          日付  店舗 商品  数量  単価    売上
0  2024-01-01  東京    A    10   100  1000
3  2024-01-02  大阪    A    12   100  1200
5  2024-01-03  大阪    B     9   200  1800
6  2024-01-04  東京    A    15   100  1500

=== 5. 売上合計 ===
条件4のデータの売上合計: 5,500円
```

---

### 発展解法（Pandas の機能を活用）

```python
import pandas as pd

df = pd.DataFrame({
    "日付": ["2024-01-01", "2024-01-01", "2024-01-02", "2024-01-02", 
             "2024-01-03", "2024-01-03", "2024-01-04", "2024-01-04"],
    "店舗": ["東京", "大阪", "東京", "大阪", "東京", "大阪", "東京", "大阪"],
    "商品": ["A", "B", "A", "A", "B", "B", "A", "B"],
    "数量": [10, 5, 8, 12, 7, 9, 15, 6],
    "単価": [100, 200, 100, 100, 200, 200, 100, 200],
    "売上": [1000, 1000, 800, 1200, 1400, 1800, 1500, 1200]
})

# 1. 東京店舗の売上データのみを抽出
result1 = df[df["店舗"] == "東京"]

# 2. 売上が 1000 以上 1500 以下のデータを抽出
result2 = df[df["売上"].between(1000, 1500)]

# 3. 東京店舗で商品Aの売上データを抽出
result3 = df[(df["店舗"] == "東京") & (df["商品"] == "A")]

# 4. 数量が 10 以上 または 売上が 1500 以上のデータを抽出
result4 = df[(df["数量"] >= 10) | (df["売上"] >= 1500)]

# 5. 抽出したデータの売上合計を計算
total_sales = result4["売上"].sum()
print(f"売上合計: {total_sales:,}円")
```

</details>

---

## 🚀 応用問題2: 社員データの条件抽出

### 問題

以下の社員データから、人事部門の視点で必要なデータを抽出してください。

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", "E006", "E007", "E008"],
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤", "山田", "中村", "小林"],
    "部署": ["営業", "開発", "営業", "人事", "開発", "営業", "開発", "人事"],
    "役職": ["一般", "主任", "一般", "課長", "主任", "課長", "一般", "一般"],
    "入社年": [2020, 2018, 2021, 2015, 2019, 2016, 2022, 2023],
    "年収": [350, 450, 320, 550, 480, 520, 300, 280]
})
```

1. 入社年が 2019年以前（5年以上勤務）の社員を抽出
2. 部署が「営業」または「開発」で、役職が「主任」以上の社員を抽出
3. 年収が 400万以上 かつ 入社年が 2018年以降の社員を抽出
4. 「一般」社員で入社年が 2020年以降の社員を抽出（若手一般社員）
5. 各抽出結果の人数と平均年収を計算

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", "E006", "E007", "E008"],
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤", "山田", "中村", "小林"],
    "部署": ["営業", "開発", "営業", "人事", "開発", "営業", "開発", "人事"],
    "役職": ["一般", "主任", "一般", "課長", "主任", "課長", "一般", "一般"],
    "入社年": [2020, 2018, 2021, 2015, 2019, 2016, 2022, 2023],
    "年収": [350, 450, 320, 550, 480, 520, 300, 280]
})

print("=== 元の DataFrame ===")
print(df)
print()

# ===== 1. 入社年が 2019年以前（5年以上勤務）の社員を抽出 =====

veteran_data = []
for i in range(len(df)):
    if df.iloc[i]["入社年"] <= 2019:
        veteran_data.append(df.iloc[i])

result1 = pd.DataFrame(veteran_data)

print("=== 1. 5年以上勤務（2019年以前入社）===")
print(result1)

# 人数と平均年収を計算
count1 = len(result1)
total_salary1 = 0
for i in range(len(result1)):
    total_salary1 = total_salary1 + result1.iloc[i]["年収"]
avg_salary1 = total_salary1 / count1 if count1 > 0 else 0

print(f"人数: {count1}人, 平均年収: {avg_salary1:.0f}万円")
print()

# ===== 2. 「営業」または「開発」で、「主任」以上の社員 =====

senior_data = []
for i in range(len(df)):
    dept = df.iloc[i]["部署"]
    role = df.iloc[i]["役職"]
    # 部署条件
    dept_ok = (dept == "営業") or (dept == "開発")
    # 役職条件（主任または課長）
    role_ok = (role == "主任") or (role == "課長")
    
    if dept_ok and role_ok:
        senior_data.append(df.iloc[i])

result2 = pd.DataFrame(senior_data)

print("=== 2. 営業・開発の主任以上 ===")
print(result2)

count2 = len(result2)
total_salary2 = 0
for i in range(len(result2)):
    total_salary2 = total_salary2 + result2.iloc[i]["年収"]
avg_salary2 = total_salary2 / count2 if count2 > 0 else 0

print(f"人数: {count2}人, 平均年収: {avg_salary2:.0f}万円")
print()

# ===== 3. 年収 400万以上 かつ 2018年以降入社 =====

high_salary_data = []
for i in range(len(df)):
    if df.iloc[i]["年収"] >= 400 and df.iloc[i]["入社年"] >= 2018:
        high_salary_data.append(df.iloc[i])

result3 = pd.DataFrame(high_salary_data)

print("=== 3. 年収400万以上 & 2018年以降入社 ===")
print(result3)

count3 = len(result3)
total_salary3 = 0
for i in range(len(result3)):
    total_salary3 = total_salary3 + result3.iloc[i]["年収"]
avg_salary3 = total_salary3 / count3 if count3 > 0 else 0

print(f"人数: {count3}人, 平均年収: {avg_salary3:.0f}万円")
print()

# ===== 4. 「一般」社員で 2020年以降入社（若手一般社員）=====

young_data = []
for i in range(len(df)):
    if df.iloc[i]["役職"] == "一般" and df.iloc[i]["入社年"] >= 2020:
        young_data.append(df.iloc[i])

result4 = pd.DataFrame(young_data)

print("=== 4. 若手一般社員（2020年以降入社の一般）===")
print(result4)

count4 = len(result4)
total_salary4 = 0
for i in range(len(result4)):
    total_salary4 = total_salary4 + result4.iloc[i]["年収"]
avg_salary4 = total_salary4 / count4 if count4 > 0 else 0

print(f"人数: {count4}人, 平均年収: {avg_salary4:.0f}万円")
```

**実行結果:**
```
=== 元の DataFrame ===
  社員ID  名前  部署  役職  入社年  年収
0   E001  田中  営業  一般   2020  350
1   E002  佐藤  開発  主任   2018  450
2   E003  鈴木  営業  一般   2021  320
3   E004  高橋  人事  課長   2015  550
4   E005  伊藤  開発  主任   2019  480
5   E006  山田  営業  課長   2016  520
6   E007  中村  開発  一般   2022  300
7   E008  小林  人事  一般   2023  280

=== 1. 5年以上勤務（2019年以前入社）===
  社員ID  名前  部署  役職  入社年  年収
1   E002  佐藤  開発  主任   2018  450
3   E004  高橋  人事  課長   2015  550
4   E005  伊藤  開発  主任   2019  480
5   E006  山田  営業  課長   2016  520
人数: 4人, 平均年収: 500万円

=== 2. 営業・開発の主任以上 ===
  社員ID  名前  部署  役職  入社年  年収
1   E002  佐藤  開発  主任   2018  450
4   E005  伊藤  開発  主任   2019  480
5   E006  山田  営業  課長   2016  520
人数: 3人, 平均年収: 483万円

=== 3. 年収400万以上 & 2018年以降入社 ===
  社員ID  名前  部署  役職  入社年  年収
1   E002  佐藤  開発  主任   2018  450
4   E005  伊藤  開発  主任   2019  480
人数: 2人, 平均年収: 465万円

=== 4. 若手一般社員（2020年以降入社の一般）===
  社員ID  名前  部署  役職  入社年  年収
0   E001  田中  営業  一般   2020  350
2   E003  鈴木  営業  一般   2021  320
6   E007  中村  開発  一般   2022  300
7   E008  小林  人事  一般   2023  280
人数: 4人, 平均年収: 313万円
```

---

### 発展解法（Pandas の機能を活用）

```python
import pandas as pd

df = pd.DataFrame({
    "社員ID": ["E001", "E002", "E003", "E004", "E005", "E006", "E007", "E008"],
    "名前": ["田中", "佐藤", "鈴木", "高橋", "伊藤", "山田", "中村", "小林"],
    "部署": ["営業", "開発", "営業", "人事", "開発", "営業", "開発", "人事"],
    "役職": ["一般", "主任", "一般", "課長", "主任", "課長", "一般", "一般"],
    "入社年": [2020, 2018, 2021, 2015, 2019, 2016, 2022, 2023],
    "年収": [350, 450, 320, 550, 480, 520, 300, 280]
})

# 1. 入社年が 2019年以前
result1 = df[df["入社年"] <= 2019]
print(f"人数: {len(result1)}, 平均年収: {result1['年収'].mean():.0f}万円")

# 2. 営業・開発 & 主任以上
result2 = df[df["部署"].isin(["営業", "開発"]) & df["役職"].isin(["主任", "課長"])]
print(f"人数: {len(result2)}, 平均年収: {result2['年収'].mean():.0f}万円")

# 3. 年収400万以上 & 2018年以降
result3 = df[(df["年収"] >= 400) & (df["入社年"] >= 2018)]
print(f"人数: {len(result3)}, 平均年収: {result3['年収'].mean():.0f}万円")

# 4. 一般 & 2020年以降
result4 = df[(df["役職"] == "一般") & (df["入社年"] >= 2020)]
print(f"人数: {len(result4)}, 平均年収: {result4['年収'].mean():.0f}万円")
```

</details>

---

## 🚀 応用問題3: 商品検索システム

### 問題

以下の商品データベースを使って、検索機能を実装してください。

```python
import pandas as pd

df = pd.DataFrame({
    "商品コード": ["P001", "P002", "P003", "P004", "P005", "P006", "P007", "P008"],
    "商品名": ["ノートPC Pro", "ノートPC Basic", "ワイヤレスマウス", 
               "有線マウス", "メカニカルキーボード", "静音キーボード",
               "4Kモニター", "フルHDモニター"],
    "カテゴリ": ["PC", "PC", "周辺機器", "周辺機器", "周辺機器", "周辺機器", "モニター", "モニター"],
    "価格": [120000, 80000, 3000, 1000, 8000, 5000, 50000, 25000],
    "在庫": [5, 10, 50, 100, 20, 30, 8, 15],
    "評価": [4.5, 4.0, 4.2, 3.8, 4.8, 4.3, 4.6, 4.1]
})
```

1. 商品名に「キーボード」を含む商品を検索
2. 価格が 5000円 以下で評価が 4.0 以上の商品を検索
3. カテゴリが「周辺機器」で在庫が 30 以上の商品を検索
4. 評価が 4.5 以上の高評価商品を検索し、価格順にソート
5. 「ノート」を含む または 「モニター」を含む商品を検索

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

df = pd.DataFrame({
    "商品コード": ["P001", "P002", "P003", "P004", "P005", "P006", "P007", "P008"],
    "商品名": ["ノートPC Pro", "ノートPC Basic", "ワイヤレスマウス", 
               "有線マウス", "メカニカルキーボード", "静音キーボード",
               "4Kモニター", "フルHDモニター"],
    "カテゴリ": ["PC", "PC", "周辺機器", "周辺機器", "周辺機器", "周辺機器", "モニター", "モニター"],
    "価格": [120000, 80000, 3000, 1000, 8000, 5000, 50000, 25000],
    "在庫": [5, 10, 50, 100, 20, 30, 8, 15],
    "評価": [4.5, 4.0, 4.2, 3.8, 4.8, 4.3, 4.6, 4.1]
})

print("=== 商品データベース ===")
print(df)
print()

# ===== 1. 商品名に「キーボード」を含む商品を検索 =====

keyboard_data = []
for i in range(len(df)):
    if "キーボード" in df.iloc[i]["商品名"]:
        keyboard_data.append(df.iloc[i])

result1 = pd.DataFrame(keyboard_data)

print("=== 1. 「キーボード」を含む商品 ===")
print(result1)
print()

# ===== 2. 価格が 5000円 以下で評価が 4.0 以上 =====

budget_data = []
for i in range(len(df)):
    if df.iloc[i]["価格"] <= 5000 and df.iloc[i]["評価"] >= 4.0:
        budget_data.append(df.iloc[i])

result2 = pd.DataFrame(budget_data)

print("=== 2. 5000円以下 & 評価4.0以上 ===")
print(result2)
print()

# ===== 3. カテゴリが「周辺機器」で在庫が 30 以上 =====

peripheral_data = []
for i in range(len(df)):
    if df.iloc[i]["カテゴリ"] == "周辺機器" and df.iloc[i]["在庫"] >= 30:
        peripheral_data.append(df.iloc[i])

result3 = pd.DataFrame(peripheral_data)

print("=== 3. 周辺機器で在庫30以上 ===")
print(result3)
print()

# ===== 4. 評価が 4.5 以上の高評価商品（価格順にソート）=====

high_rating_data = []
for i in range(len(df)):
    if df.iloc[i]["評価"] >= 4.5:
        high_rating_data.append(df.iloc[i])

result4 = pd.DataFrame(high_rating_data)

# 基本解法：バブルソートで価格順にソート
for i in range(len(result4)):
    for j in range(len(result4) - 1):
        if result4.iloc[j]["価格"] > result4.iloc[j + 1]["価格"]:
            # 行を入れ替え（実際にはインデックスを使う）
            pass  # ソートはPandasの機能を使う方が簡単

# Pandasのsort_valuesを使用
result4 = result4.sort_values("価格")

print("=== 4. 評価4.5以上（価格順）===")
print(result4)
print()

# ===== 5. 「ノート」または「モニター」を含む商品 =====

note_or_monitor = []
for i in range(len(df)):
    name = df.iloc[i]["商品名"]
    if "ノート" in name or "モニター" in name:
        note_or_monitor.append(df.iloc[i])

result5 = pd.DataFrame(note_or_monitor)

print("=== 5. 「ノート」または「モニター」を含む ===")
print(result5)
```

**実行結果:**
```
=== 商品データベース ===
  商品コード            商品名    カテゴリ     価格  在庫   評価
0       P001      ノートPC Pro        PC  120000     5  4.5
1       P002    ノートPC Basic        PC   80000    10  4.0
2       P003    ワイヤレスマウス    周辺機器    3000    50  4.2
3       P004        有線マウス    周辺機器    1000   100  3.8
4       P005  メカニカルキーボード    周辺機器    8000    20  4.8
5       P006      静音キーボード    周辺機器    5000    30  4.3
6       P007        4Kモニター    モニター   50000     8  4.6
7       P008    フルHDモニター    モニター   25000    15  4.1

=== 1. 「キーボード」を含む商品 ===
  商品コード              商品名    カテゴリ   価格  在庫   評価
4       P005  メカニカルキーボード    周辺機器  8000    20  4.8
5       P006      静音キーボード    周辺機器  5000    30  4.3

=== 2. 5000円以下 & 評価4.0以上 ===
  商品コード          商品名    カテゴリ   価格  在庫   評価
2       P003  ワイヤレスマウス    周辺機器  3000    50  4.2
5       P006    静音キーボード    周辺機器  5000    30  4.3

=== 3. 周辺機器で在庫30以上 ===
  商品コード          商品名    カテゴリ   価格  在庫   評価
2       P003  ワイヤレスマウス    周辺機器  3000    50  4.2
3       P004      有線マウス    周辺機器  1000   100  3.8
5       P006    静音キーボード    周辺機器  5000    30  4.3

=== 4. 評価4.5以上（価格順）===
  商品コード              商品名    カテゴリ     価格  在庫   評価
4       P005  メカニカルキーボード    周辺機器    8000    20  4.8
6       P007        4Kモニター    モニター   50000     8  4.6
0       P001      ノートPC Pro        PC  120000     5  4.5

=== 5. 「ノート」または「モニター」を含む ===
  商品コード          商品名    カテゴリ     価格  在庫   評価
0       P001    ノートPC Pro        PC  120000     5  4.5
1       P002  ノートPC Basic        PC   80000    10  4.0
6       P007      4Kモニター    モニター   50000     8  4.6
7       P008  フルHDモニター    モニター   25000    15  4.1
```

---

### 発展解法（Pandas の機能を活用）

```python
import pandas as pd

df = pd.DataFrame({
    "商品コード": ["P001", "P002", "P003", "P004", "P005", "P006", "P007", "P008"],
    "商品名": ["ノートPC Pro", "ノートPC Basic", "ワイヤレスマウス", 
               "有線マウス", "メカニカルキーボード", "静音キーボード",
               "4Kモニター", "フルHDモニター"],
    "カテゴリ": ["PC", "PC", "周辺機器", "周辺機器", "周辺機器", "周辺機器", "モニター", "モニター"],
    "価格": [120000, 80000, 3000, 1000, 8000, 5000, 50000, 25000],
    "在庫": [5, 10, 50, 100, 20, 30, 8, 15],
    "評価": [4.5, 4.0, 4.2, 3.8, 4.8, 4.3, 4.6, 4.1]
})

# 1. 商品名に「キーボード」を含む
result1 = df[df["商品名"].str.contains("キーボード")]

# 2. 価格が 5000円 以下で評価が 4.0 以上
result2 = df[(df["価格"] <= 5000) & (df["評価"] >= 4.0)]

# 3. カテゴリが「周辺機器」で在庫が 30 以上
result3 = df[(df["カテゴリ"] == "周辺機器") & (df["在庫"] >= 30)]

# 4. 評価が 4.5 以上（価格順）
result4 = df[df["評価"] >= 4.5].sort_values("価格")

# 5. 「ノート」または「モニター」を含む
result5 = df[df["商品名"].str.contains("ノート|モニター")]
```

</details>

---

## 🎯 応用問題チェックリスト

以下ができるようになったか確認しましょう：

- [ ] 複数の条件を AND/OR で組み合わせてフィルタリングできる
- [ ] isin() で複数値の条件を指定できる
- [ ] between() で範囲条件を指定できる
- [ ] str.contains() で文字列の部分一致検索ができる
- [ ] フィルタリング結果に対して集計（sum, mean, len）ができる
- [ ] sort_values() でソートを組み合わせられる
