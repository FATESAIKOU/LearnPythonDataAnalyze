# Section3: データの読み書き - 応用問題

## 🎯 この応用問題の目的

実際のデータ分析ワークフローを想定した、
ファイル読み込み → 加工 → 保存 の一連の流れを実践します。

---

## 🚀 応用問題1: 売上レポートの作成

### 問題

以下の手順で売上レポートを作成してください：

1. 売上データ（DataFrame）を作成する
2. CSV ファイルに保存する
3. CSV ファイルを読み込む
4. 合計と平均を計算して追加する
5. Excel ファイルにレポートとして保存する

**作成する売上データ:**

| 店舗 | 1月 | 2月 | 3月 |
|------|-----|-----|-----|
| 東京 | 150 | 180 | 200 |
| 大阪 | 120 | 140 | 160 |
| 福岡 | 80 | 90 | 110 |

（単位: 万円）

**期待する出力:**
- 各店舗の「合計」列を追加
- 各月の「合計」行を追加
- Excel ファイル「sales_report.xlsx」として保存

<details>
<summary>解答例を見る</summary>

### 基本解法（四則演算とループを使用）

```python
import pandas as pd

# ===== Step 1: 売上データを作成 =====

df = pd.DataFrame({
    "店舗": ["東京", "大阪", "福岡"],
    "1月": [150, 180, 200],
    "2月": [120, 140, 160],
    "3月": [80, 90, 110]
})

print("=== 元の売上データ ===")
print(df)
print()

# ===== Step 2: CSV ファイルに保存 =====

df.to_csv("sales_data.csv", index=False)
print("sales_data.csv に保存しました")
print()

# ===== Step 3: CSV ファイルを読み込む =====

df_loaded = pd.read_csv("sales_data.csv")
print("=== CSV から読み込み ===")
print(df_loaded)
print()

# ===== Step 4: 合計と平均を計算（基本解法：ループ使用）=====

# 各店舗の合計列を追加（ループで計算）
totals = []
for i in range(len(df_loaded)):
    row_total = df_loaded.loc[i, "1月"] + df_loaded.loc[i, "2月"] + df_loaded.loc[i, "3月"]
    totals.append(row_total)

df_loaded["合計"] = totals

print("=== 合計列を追加 ===")
print(df_loaded)
print()

# 各月の合計行を追加（ループで計算）
jan_total = 0
feb_total = 0
mar_total = 0
all_total = 0

for i in range(len(df_loaded)):
    jan_total = jan_total + df_loaded.loc[i, "1月"]
    feb_total = feb_total + df_loaded.loc[i, "2月"]
    mar_total = mar_total + df_loaded.loc[i, "3月"]
    all_total = all_total + df_loaded.loc[i, "合計"]

# 合計行を作成
total_row = pd.DataFrame({
    "店舗": ["合計"],
    "1月": [jan_total],
    "2月": [feb_total],
    "3月": [mar_total],
    "合計": [all_total]
})

# 合計行を追加
df_report = pd.concat([df_loaded, total_row], ignore_index=True)

print("=== 合計行を追加 ===")
print(df_report)
print()

# ===== Step 5: Excel に保存 =====

df_report.to_excel("sales_report.xlsx", sheet_name="売上レポート", index=False)
print("sales_report.xlsx に保存しました！")
```

**実行結果:**
```
=== 元の売上データ ===
   店舗   1月   2月   3月
0  東京  150  120   80
1  大阪  180  140   90
2  福岡  200  160  110

sales_data.csv に保存しました

=== CSV から読み込み ===
   店舗   1月   2月   3月
0  東京  150  120   80
1  大阪  180  140   90
2  福岡  200  160  110

=== 合計列を追加 ===
   店舗   1月   2月   3月  合計
0  東京  150  120   80   350
1  大阪  180  140   90   410
2  福岡  200  160  110   470

=== 合計行を追加 ===
   店舗   1月   2月   3月   合計
0  東京  150  120   80   350
1  大阪  180  140   90   410
2  福岡  200  160  110   470
3  合計  530  420  280  1230

sales_report.xlsx に保存しました！
```

---

### 発展解法（Pandas の組み込み関数を使用）

```python
import pandas as pd

# ===== Step 1-3: 同じ =====

df = pd.DataFrame({
    "店舗": ["東京", "大阪", "福岡"],
    "1月": [150, 180, 200],
    "2月": [120, 140, 160],
    "3月": [80, 90, 110]
})

df.to_csv("sales_data.csv", index=False)
df_loaded = pd.read_csv("sales_data.csv")

# ===== Step 4: 合計を計算（発展解法：組み込み関数）=====

# 各店舗の合計列を追加（sum を使用、axis=1 で行方向）
df_loaded["合計"] = df_loaded[["1月", "2月", "3月"]].sum(axis=1)

# 各月の合計行を追加
total_row = df_loaded[["1月", "2月", "3月", "合計"]].sum()
total_row["店舗"] = "合計"

# 合計行を追加
df_report = pd.concat([df_loaded, pd.DataFrame([total_row])], ignore_index=True)

print("=== レポート（発展解法）===")
print(df_report)

# ===== Step 5: Excel に保存 =====
df_report.to_excel("sales_report.xlsx", sheet_name="売上レポート", index=False)
```

</details>

---

## 🚀 応用問題2: 複数ファイルの結合

### 問題

3つの月別売上ファイルを作成し、それらを1つのファイルに結合してください。

1. 1月、2月、3月の売上ファイル（CSV）を作成
2. 3つのファイルを読み込んで1つの DataFrame に結合
3. 結合した結果を Excel ファイルに保存

**1月データ (jan.csv):**
| 商品 | 売上 |
|------|------|
| A | 100 |
| B | 150 |

**2月データ (feb.csv):**
| 商品 | 売上 |
|------|------|
| A | 120 |
| B | 180 |

**3月データ (mar.csv):**
| 商品 | 売上 |
|------|------|
| A | 130 |
| B | 200 |

**期待する結合結果:**
- 各ファイルに「月」列を追加してから結合
- 縦方向に結合して1つの DataFrame にする

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

# ===== Step 1: 月別ファイルを作成 =====

# 1月データ
df_jan = pd.DataFrame({
    "商品": ["A", "B"],
    "売上": [100, 150]
})
df_jan.to_csv("jan.csv", index=False)

# 2月データ
df_feb = pd.DataFrame({
    "商品": ["A", "B"],
    "売上": [120, 180]
})
df_feb.to_csv("feb.csv", index=False)

# 3月データ
df_mar = pd.DataFrame({
    "商品": ["A", "B"],
    "売上": [130, 200]
})
df_mar.to_csv("mar.csv", index=False)

print("3つの CSV ファイルを作成しました")
print()

# ===== Step 2: ファイルを読み込んで結合（基本解法：ループ使用）=====

# ファイル名と月名のリスト
files = ["jan.csv", "feb.csv", "mar.csv"]
months = ["1月", "2月", "3月"]

# 結合結果を格納するリスト
all_data = []

# ループで各ファイルを処理
for i in range(len(files)):
    file_name = files[i]
    month_name = months[i]
    
    # CSVを読み込み
    df = pd.read_csv(file_name)
    
    # 月列を追加
    df["月"] = month_name
    
    # リストに追加
    all_data.append(df)
    
    print(f"=== {file_name} ===")
    print(df)
    print()

# すべてのDataFrameを結合
df_combined = pd.concat(all_data, ignore_index=True)

print("=== 結合結果 ===")
print(df_combined)
print()

# ===== Step 3: Excel に保存 =====

df_combined.to_excel("quarterly_sales.xlsx", index=False)
print("quarterly_sales.xlsx に保存しました！")
```

**実行結果:**
```
3つの CSV ファイルを作成しました

=== jan.csv ===
  商品  売上   月
0    A  100  1月
1    B  150  1月

=== feb.csv ===
  商品  売上   月
0    A  120  2月
1    B  180  2月

=== mar.csv ===
  商品  売上   月
0    A  130  3月
1    B  200  3月

=== 結合結果 ===
  商品  売上   月
0    A  100  1月
1    B  150  1月
2    A  120  2月
3    B  180  2月
4    A  130  3月
5    B  200  3月

quarterly_sales.xlsx に保存しました！
```

---

### 発展解法（リスト内包表記を使用）

```python
import pandas as pd

# Step 1: 同じ

# ===== Step 2: ファイルを読み込んで結合（発展解法）=====

files = [("jan.csv", "1月"), ("feb.csv", "2月"), ("mar.csv", "3月")]

# リスト内包表記で一括読み込み
dfs = [pd.read_csv(f).assign(月=m) for f, m in files]

# 結合
df_combined = pd.concat(dfs, ignore_index=True)

print("=== 結合結果（発展解法）===")
print(df_combined)

# Step 3: Excel に保存
df_combined.to_excel("quarterly_sales.xlsx", index=False)
```

</details>

---

## 🚀 応用問題3: データの加工と保存

### 問題

社員データを作成し、以下の加工を行ってから保存してください。

1. 社員データを作成
2. 年収から税金（20%）を計算して「税金」列を追加
3. 手取り（年収 - 税金）を計算して「手取り」列を追加
4. 部署ごとに異なるシートで Excel に保存

**作成する社員データ:**
| 社員名 | 部署 | 年収 |
|--------|------|------|
| 田中 | 営業 | 4000000 |
| 佐藤 | 開発 | 5000000 |
| 鈴木 | 営業 | 4500000 |
| 高橋 | 開発 | 5500000 |
| 伊藤 | 人事 | 4200000 |

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

# ===== Step 1: 社員データを作成 =====

df = pd.DataFrame({
    "社員名": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "開発", "人事"],
    "年収": [4000000, 5000000, 4500000, 5500000, 4200000]
})

print("=== 元の社員データ ===")
print(df)
print()

# ===== Step 2-3: 税金と手取りを計算（基本解法：ループ使用）=====

# 税金列を計算
taxes = []
for i in range(len(df)):
    tax = df.loc[i, "年収"] * 0.2  # 20%
    taxes.append(tax)
df["税金"] = taxes

# 手取り列を計算
take_homes = []
for i in range(len(df)):
    take_home = df.loc[i, "年収"] - df.loc[i, "税金"]
    take_homes.append(take_home)
df["手取り"] = take_homes

# 見やすく整数に変換
df["税金"] = df["税金"].astype(int)
df["手取り"] = df["手取り"].astype(int)

print("=== 税金・手取りを追加 ===")
print(df)
print()

# ===== Step 4: 部署ごとに異なるシートで保存（基本解法：ループ使用）=====

# 部署の一覧を取得
departments = []
for dept in df["部署"]:
    if dept not in departments:
        departments.append(dept)

print(f"部署一覧: {departments}")
print()

# 部署ごとに Excel シートに保存
with pd.ExcelWriter("employee_report.xlsx") as writer:
    for dept in departments:
        # 該当部署のデータを抽出（ループで検索）
        dept_data = []
        for i in range(len(df)):
            if df.loc[i, "部署"] == dept:
                dept_data.append(df.loc[i])
        
        # DataFrameに変換
        df_dept = pd.DataFrame(dept_data)
        
        # シートに保存
        df_dept.to_excel(writer, sheet_name=dept, index=False)
        
        print(f"=== {dept}シート ===")
        print(df_dept)
        print()

print("employee_report.xlsx に保存しました！")
```

**実行結果:**
```
=== 元の社員データ ===
  社員名  部署      年収
0   田中  営業  4000000
1   佐藤  開発  5000000
2   鈴木  営業  4500000
3   高橋  開発  5500000
4   伊藤  人事  4200000

=== 税金・手取りを追加 ===
  社員名  部署      年収     税金     手取り
0   田中  営業  4000000   800000  3200000
1   佐藤  開発  5000000  1000000  4000000
2   鈴木  営業  4500000   900000  3600000
3   高橋  開発  5500000  1100000  4400000
4   伊藤  人事  4200000   840000  3360000

部署一覧: ['営業', '開発', '人事']

=== 営業シート ===
  社員名  部署      年収    税金     手取り
0   田中  営業  4000000  800000  3200000
2   鈴木  営業  4500000  900000  3600000

=== 開発シート ===
  社員名  部署      年収      税金     手取り
1   佐藤  開発  5000000  1000000  4000000
3   高橋  開発  5500000  1100000  4400000

=== 人事シート ===
  社員名  部署      年収    税金     手取り
4   伊藤  人事  4200000  840000  3360000

employee_report.xlsx に保存しました！
```

---

### 発展解法（Pandas の機能を活用）

```python
import pandas as pd

# Step 1: 同じ

df = pd.DataFrame({
    "社員名": ["田中", "佐藤", "鈴木", "高橋", "伊藤"],
    "部署": ["営業", "開発", "営業", "開発", "人事"],
    "年収": [4000000, 5000000, 4500000, 5500000, 4200000]
})

# ===== Step 2-3: 税金と手取りを計算（発展解法：ベクトル演算）=====

df["税金"] = (df["年収"] * 0.2).astype(int)
df["手取り"] = (df["年収"] - df["税金"]).astype(int)

# ===== Step 4: 部署ごとに異なるシートで保存（発展解法：groupby）=====

with pd.ExcelWriter("employee_report.xlsx") as writer:
    for dept, group in df.groupby("部署"):
        group.to_excel(writer, sheet_name=dept, index=False)

print("employee_report.xlsx に保存しました！")
```

</details>

---

## 🚀 応用問題4: ファイル情報の一覧作成

### 問題

複数の CSV ファイルを作成し、それぞれのファイル情報（行数、列数、カラム名）を一覧表にまとめてください。

1. 3種類のサンプル CSV ファイルを作成
2. 各ファイルの情報を収集
3. 情報一覧表を CSV として保存

<details>
<summary>解答例を見る</summary>

### 基本解法（ループを使用）

```python
import pandas as pd

# ===== Step 1: サンプル CSV ファイルを作成 =====

# ファイル1: 商品データ
df1 = pd.DataFrame({
    "商品ID": [1, 2, 3],
    "商品名": ["りんご", "みかん", "バナナ"],
    "価格": [100, 80, 120]
})
df1.to_csv("products.csv", index=False)

# ファイル2: 顧客データ
df2 = pd.DataFrame({
    "顧客ID": [101, 102, 103, 104],
    "名前": ["田中", "佐藤", "鈴木", "高橋"],
    "会員ランク": ["ゴールド", "シルバー", "ゴールド", "ブロンズ"]
})
df2.to_csv("customers.csv", index=False)

# ファイル3: 注文データ
df3 = pd.DataFrame({
    "注文ID": range(1, 11),
    "顧客ID": [101, 102, 101, 103, 104, 102, 101, 103, 104, 101],
    "商品ID": [1, 2, 3, 1, 2, 3, 1, 2, 3, 1],
    "数量": [2, 1, 3, 1, 2, 1, 4, 2, 1, 2],
    "注文日": ["2024-01-01"] * 10
})
df3.to_csv("orders.csv", index=False)

print("3つの CSV ファイルを作成しました")
print()

# ===== Step 2: 各ファイルの情報を収集（基本解法：ループ使用）=====

file_names = ["products.csv", "customers.csv", "orders.csv"]

# 情報を格納するリスト
info_list = []

for file_name in file_names:
    # ファイルを読み込み
    df = pd.read_csv(file_name)
    
    # 情報を収集
    row_count = df.shape[0]
    col_count = df.shape[1]
    
    # カラム名を文字列として結合
    column_names = ""
    for col in df.columns:
        if column_names == "":
            column_names = col
        else:
            column_names = column_names + ", " + col
    
    # 情報を辞書として追加
    info = {
        "ファイル名": file_name,
        "行数": row_count,
        "列数": col_count,
        "カラム名": column_names
    }
    info_list.append(info)
    
    print(f"=== {file_name} ===")
    print(f"  行数: {row_count}")
    print(f"  列数: {col_count}")
    print(f"  カラム: {column_names}")
    print()

# ===== Step 3: 情報一覧表を CSV として保存 =====

df_info = pd.DataFrame(info_list)

print("=== ファイル情報一覧 ===")
print(df_info)
print()

df_info.to_csv("file_info.csv", index=False)
print("file_info.csv に保存しました！")
```

**実行結果:**
```
3つの CSV ファイルを作成しました

=== products.csv ===
  行数: 3
  列数: 3
  カラム: 商品ID, 商品名, 価格

=== customers.csv ===
  行数: 4
  列数: 3
  カラム: 顧客ID, 名前, 会員ランク

=== orders.csv ===
  行数: 10
  列数: 5
  カラム: 注文ID, 顧客ID, 商品ID, 数量, 注文日

=== ファイル情報一覧 ===
        ファイル名  行数  列数                               カラム名
0    products.csv     3     3                      商品ID, 商品名, 価格
1   customers.csv     4     3                   顧客ID, 名前, 会員ランク
2      orders.csv    10     5  注文ID, 顧客ID, 商品ID, 数量, 注文日

file_info.csv に保存しました！
```

---

### 発展解法（リスト内包表記と join を使用）

```python
import pandas as pd

# Step 1: 同じ

# ===== Step 2-3: 情報収集と保存（発展解法）=====

file_names = ["products.csv", "customers.csv", "orders.csv"]

# リスト内包表記で一括処理
info_list = []
for f in file_names:
    df = pd.read_csv(f)
    info_list.append({
        "ファイル名": f,
        "行数": df.shape[0],
        "列数": df.shape[1],
        "カラム名": ", ".join(df.columns)  # join で結合
    })

df_info = pd.DataFrame(info_list)
df_info.to_csv("file_info.csv", index=False)

print("=== ファイル情報一覧（発展解法）===")
print(df_info)
```

</details>

---

## 🎯 応用問題チェックリスト

以下ができるようになったか確認しましょう：

- [ ] CSV → DataFrame → 加工 → Excel の一連の流れができる
- [ ] 複数の CSV ファイルを結合できる
- [ ] 計算列を追加してファイルに保存できる
- [ ] 部署・カテゴリごとに異なるシートに保存できる
- [ ] ファイルのメタ情報を収集して一覧表を作成できる
